name: Architecture Contract Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  architecture-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.12]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Lint with ruff
        run: |
          ruff check backend --fix
          ruff check tests --fix
      
      - name: Check code formatting with black
        run: |
          black --check backend tests
      
      - name: Check import sorting with isort
        run: |
          isort --check-only backend tests
      
      - name: Type check with mypy
        run: |
          mypy backend --ignore-missing-imports
      
      - name: Run architecture contract tests
        run: |
          echo "ğŸ” ì•„í‚¤í…ì²˜ ê³„ì•½ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
          
          # Import-linter ê²€ì‚¬
          echo "1. Import-linter ê³„ì•½ ê²€ì‚¬..."
          if python -m importlinter check; then
            echo "âœ… Import-linter ê³„ì•½ ê²€ì‚¬ í†µê³¼"
          else
            echo "âš ï¸ Import-linterì—ì„œ ê³„ì•½ ìœ„ë°˜ ë°œê²¬ë¨"
            echo "ê³„ì•½ ìœ„ë°˜ ìƒì„¸ ì •ë³´:"
            python -m importlinter check --verbose
          fi
          
          # Pytest ì•„í‚¤í…ì²˜ í…ŒìŠ¤íŠ¸
          echo "2. Pytest ì•„í‚¤í…ì²˜ í…ŒìŠ¤íŠ¸..."
          if pytest tests/architecture/ -v --tb=short; then
            echo "âœ… Pytest ì•„í‚¤í…ì²˜ í…ŒìŠ¤íŠ¸ í†µê³¼"
          else
            echo "âš ï¸ Pytest ì•„í‚¤í…ì²˜ í…ŒìŠ¤íŠ¸ì—ì„œ ì‹¤íŒ¨ ë°œê²¬ë¨"
            pytest tests/architecture/ -v --tb=short --no-header
          fi
          
          echo "âœ… ì•„í‚¤í…ì²˜ ê³„ì•½ í…ŒìŠ¤íŠ¸ ì™„ë£Œ (ìœ„ë°˜ ì‚¬í•­ í™•ì¸ í•„ìš”)"
      
      - name: Architecture test success
        if: success()
        run: |
          echo "âœ… ëª¨ë“  ì•„í‚¤í…ì²˜ ê³„ì•½ í†µê³¼!"
          echo "ì½”ë“œ êµ¬ì¡°ê°€ ì•„í‚¤í…ì²˜ ì›ì¹™ì„ ì¤€ìˆ˜í•©ë‹ˆë‹¤."

  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run comprehensive code quality checks
        run: |
          echo "ğŸ” ì¢…í•© ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì‹¤í–‰ ì¤‘..."
          
          # 1. ì •ì  ë¶„ì„
          echo "1. Ruff ì •ì  ë¶„ì„..."
          if ! ruff check backend tests --output-format=github; then
            echo "âš ï¸ Ruff ì •ì  ë¶„ì„ì—ì„œ ë¬¸ì œ ë°œê²¬ë¨"
            ruff check backend tests --output-format=github --exit-zero
          else
            echo "âœ… Ruff ì •ì  ë¶„ì„ í†µê³¼"
          fi
          
          # 2. íƒ€ì… ê²€ì‚¬
          echo "2. MyPy íƒ€ì… ê²€ì‚¬..."
          if ! mypy backend --ignore-missing-imports --show-error-codes; then
            echo "âš ï¸ MyPy íƒ€ì… ê²€ì‚¬ì—ì„œ ë¬¸ì œ ë°œê²¬ë¨"
            mypy backend --ignore-missing-imports --show-error-codes --no-error-summary
          else
            echo "âœ… MyPy íƒ€ì… ê²€ì‚¬ í†µê³¼"
          fi
          
          # 3. ë³´ì•ˆ ê²€ì‚¬
          echo "3. ë³´ì•ˆ ê²€ì‚¬..."
          if ! ruff check backend tests --select=S --output-format=github; then
            echo "âš ï¸ ë³´ì•ˆ ê²€ì‚¬ì—ì„œ ë¬¸ì œ ë°œê²¬ë¨"
            ruff check backend tests --select=S --output-format=github --exit-zero
          else
            echo "âœ… ë³´ì•ˆ ê²€ì‚¬ í†µê³¼"
          fi
          
          echo "âœ… ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ (ê²½ê³  í¬í•¨)"

  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Check for known security vulnerabilities
        run: |
          echo "ğŸ”’ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ ì¤‘..."
          
          # Safety ê²€ì‚¬
          echo "1. Safety ë³´ì•ˆ ê²€ì‚¬..."
          if safety check --json --output safety-report.json; then
            echo "âœ… Safety ê²€ì‚¬ í†µê³¼"
          else
            echo "âš ï¸ Safetyì—ì„œ ì·¨ì•½ì  ë°œê²¬ë¨ (ë³´ê³ ì„œ ìƒì„±ë¨)"
          fi
          
          # pip-audit ê²€ì‚¬
          echo "2. pip-audit ë³´ì•ˆ ê²€ì‚¬..."
          if pip-audit --desc --format=json --output=pip-audit-report.json; then
            echo "âœ… pip-audit ê²€ì‚¬ í†µê³¼"
          else
            echo "âš ï¸ pip-auditì—ì„œ ì·¨ì•½ì  ë°œê²¬ë¨ (ë³´ê³ ì„œ ìƒì„±ë¨)"
          fi
          
          echo "âœ… ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ ì™„ë£Œ (ë³´ê³ ì„œ í™•ì¸ í•„ìš”)"
      
      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            safety-report.json
            pip-audit-report.json

  architecture-documentation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Generate architecture documentation
        run: |
          echo "ğŸ“š ì•„í‚¤í…ì²˜ ë¬¸ì„œ ìƒì„± ì¤‘..."
          
          # ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨ ìƒì„± (ì˜ˆì‹œ)
          echo "Creating architecture overview..."
          
          # ê³„ì•½ ìœ„ë°˜ ë¦¬í¬íŠ¸ ìƒì„±
          echo "1. ì•„í‚¤í…ì²˜ ê³„ì•½ ë¦¬í¬íŠ¸ ìƒì„±..."
          if python -m importlinter check --format=json > architecture-report.json; then
            echo "âœ… ì•„í‚¤í…ì²˜ ê³„ì•½ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ (ìœ„ë°˜ ì—†ìŒ)"
          else
            echo "âš ï¸ ì•„í‚¤í…ì²˜ ê³„ì•½ ìœ„ë°˜ ë°œê²¬ë¨ (ë¦¬í¬íŠ¸ ìƒì„±ë¨)"
            # ìœ„ë°˜ì´ ìˆì–´ë„ ë¦¬í¬íŠ¸ëŠ” ìƒì„±ë¨
          fi
          
          # ë¦¬í¬íŠ¸ íŒŒì¼ ì¡´ì¬ í™•ì¸
          if [ -f "architecture-report.json" ]; then
            echo "âœ… ì•„í‚¤í…ì²˜ ë¦¬í¬íŠ¸ íŒŒì¼ ìƒì„±ë¨: architecture-report.json"
          else
            echo "âš ï¸ ì•„í‚¤í…ì²˜ ë¦¬í¬íŠ¸ íŒŒì¼ ìƒì„± ì‹¤íŒ¨"
            echo "{}" > architecture-report.json  # ë¹ˆ JSON íŒŒì¼ ìƒì„±
          fi
          
          echo "âœ… ì•„í‚¤í…ì²˜ ë¬¸ì„œ ìƒì„± ì™„ë£Œ"
      
      - name: Upload architecture documentation
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: architecture-docs
          path: |
            architecture-report.json
