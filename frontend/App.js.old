import React, { useState, useEffect, useCallback, useRef } from 'react';
import { Text, View, StyleSheet, FlatList, ActivityIndicator, TouchableOpacity, TextInput, SafeAreaView, Alert, Modal, Pressable, ScrollView, Dimensions, KeyboardAvoidingView, Platform, Switch, Image, RefreshControl } from 'react-native';
import { NavigationContainer, useFocusEffect, useNavigationState } from '@react-navigation/native';
import { createBottomTabNavigator } from '@react-navigation/bottom-tabs';
import { createMaterialTopTabNavigator } from '@react-navigation/material-top-tabs';
import { createStackNavigator } from '@react-navigation/stack';
import Ionicons from 'react-native-vector-icons/Ionicons';
import { Calendar, LocaleConfig } from 'react-native-calendars';
import MapView, { Marker } from 'react-native-maps';
import DateTimePicker from '@react-native-community/datetimepicker';
import io from 'socket.io-client';
import AsyncStorage from '@react-native-async-storage/async-storage';

// ìƒìˆ˜ì™€ ìŠ¤íƒ€ì¼ import
import { 
    RENDER_SERVER_URL, 
    API_BASE_URL, 
    CURRENT_USER_ID, 
    myEmployeeId, 
    COLORS, 
    DARK_COLORS,
    SCREEN_WIDTH,
    SCREEN_HEIGHT
} from './utils/constants';
import { commonStyles } from './utils/styles';

// ë¶„ë¦¬ëœ í™”ë©´ ì»´í¬ë„ŒíŠ¸ë“¤ import
import ChatRoomScreen from './screens/ChatRoomScreen';
import IntelligentSchedulingScreen from './screens/IntelligentSchedulingScreen';
import HomeScreen from './screens/HomeScreen';
import RestaurantsScreen from './screens/RestaurantsScreen';
import ChatListScreen from './screens/ChatListScreen';

const myNickname = 'í™ê¸¸ë™'; // ì‹¤ì œ ë‚´ ë‹‰ë„¤ì„ìœ¼ë¡œ ìˆ˜ì •

// --- ìœ í‹¸ í•¨ìˆ˜ ì¶”ê°€ (ì „ì—­ì—ì„œ ì‚¬ìš© ê°€ëŠ¥) ---
function parseRecipientIds(recipientIds) {
  // ë¹ˆ ë¬¸ìì—´ì´ë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜
  if (!recipientIds || recipientIds.trim() === '') {
    return [];
  }
  
  // ì—°ì†ëœ ì‰¼í‘œë¥¼ í•˜ë‚˜ë¡œ ì¹˜í™˜í•˜ê³ , ì•ë’¤ ê³µë°± ì œê±°
  const cleanedIds = recipientIds.replace(/,,+/g, ',').trim();
  
  // ì‰¼í‘œë¡œ ë¶„ë¦¬í•˜ê³  ë¹ˆ ë¬¸ìì—´ ì œê±°
  const ids = cleanedIds
    .split(',')
    .map(id => id.trim())
    .filter(id => id.length > 0);
  
  // ë§Œì•½ ê° IDê°€ í•œ ê¸€ìì”©ì´ë¼ë©´ (ì˜ˆ: "K,O,I,C,A,0,0,2"), ì˜¬ë°”ë¥¸ í˜•íƒœë¡œ ì¡°í•©
  if (ids.length > 0 && ids[0].length === 1) {
    const combinedIds = [];
    let currentId = '';
    
    for (let i = 0; i < ids.length; i++) {
      currentId += ids[i];
      // 8ê¸€ìê°€ ë˜ë©´ í•˜ë‚˜ì˜ IDë¡œ ê°„ì£¼ (KOICA002 í˜•íƒœ)
      if (currentId.length === 8) {
        combinedIds.push(currentId);
        currentId = '';
      }
    }
    
    // ë‚¨ì€ ê¸€ìë“¤ë„ IDë¡œ ì¶”ê°€ (8ê¸€ìê°€ ì•ˆ ë˜ë”ë¼ë„)
    if (currentId.length > 0) {
      combinedIds.push(currentId);
    }
    
    return combinedIds;
  }
  
  return ids;
}
// ë‚ ì§œë¥¼ YYYY-MM-DD(ë¡œì»¬)ë¡œ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
function toLocalDateString(date) {
  const pad = n => n.toString().padStart(2, '0');
  return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}`;
}
function getGroupKeyFromIds(ids) {
  return [...ids].sort().join(',');
}

// --- ì‹¤ì‹œê°„ ì•Œë¦¼ ê´€ë¦¬ í•¨ìˆ˜ë“¤ ---
const addNotification = (setNotifications, setUnreadCount, type, message, data = {}) => {
    const newNotification = {
        id: Date.now(),
        type,
        message,
        data,
        timestamp: new Date(),
        read: false
    };
    setNotifications(prev => [newNotification, ...prev]);
    setUnreadCount(prev => prev + 1);
};

const markNotificationAsRead = (setNotifications, setUnreadCount, notificationId) => {
    setNotifications(prev => 
        prev.map(notif => 
            notif.id === notificationId ? { ...notif, read: true } : notif
        )
    );
    setUnreadCount(prev => Math.max(0, prev - 1));
};

const Tab = createBottomTabNavigator();
const Stack = createStackNavigator();
const TopTab = createMaterialTopTabNavigator();

// --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ì„ì‹œ) ---
const basicStyles = StyleSheet.create({
    centeredView: { flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: 'rgba(0,0,0,0.6)' },
    modalView: { 
        margin: 20, 
        backgroundColor: 'white', 
        borderRadius: 24, 
        padding: 30, 
        alignItems: 'center', 
        width: '90%', 
        shadowColor: '#000', 
        shadowOffset: { width: 0, height: 8 }, 
        shadowOpacity: 0.3, 
        shadowRadius: 12, 
        elevation: 8 
    },
    modalTitle: { fontSize: 22, fontWeight: 'bold', marginBottom: 24, textAlign: 'center', color: '#3B82F6', letterSpacing: 0.5 },
    button: { 
        borderRadius: 16, 
        padding: 16, 
        elevation: 3, 
        width: '100%', 
        marginTop: 12,
        shadowColor: '#3B82F6',
        shadowOffset: { width: 0, height: 2 }, 
        shadowOpacity: 0.2, 
        shadowRadius: 4
    },
    buttonClose: { backgroundColor: '#E2E8F0' },
    textStyle: { color: 'white', fontWeight: 'bold', textAlign: 'center', fontSize: 16 },
    textStyleBlack: { color: 'black', fontWeight: 'bold', textAlign: 'center', fontSize: 16 },
    optionButton: { padding: 12, marginVertical: 4, borderRadius: 8, backgroundColor: '#F1F5F9' },
    optionButtonSelected: { backgroundColor: '#3B82F6' },
    optionButtonText: { fontSize: 16, color: '#1E293B' },
    optionButtonTextSelected: { color: 'white' },
    scrollerContainer: { height: 200, alignItems: 'center' },
    scroller: { width: 100 },
    scrollerItem: { height: 50, justifyContent: 'center', alignItems: 'center' },
    scrollerItemText: { fontSize: 18, fontWeight: 'bold' },
    scrollerIndicator: { position: 'absolute', top: 75, left: 0, right: 0, height: 50, backgroundColor: 'rgba(59, 130, 246, 0.1)', borderRadius: 8 }
});

// --- í…Œë§ˆ ê´€ë¦¬ í•¨ìˆ˜ ---

const COLORS = {
    // ë¼ì´íŠ¸ ëª¨ë“œ
    light: {
        primary: '#3B82F6',      // íŒŒë€ìƒ‰ (ë©”ì¸ ì»¬ëŸ¬)
        primaryLight: 'rgba(59, 130, 246, 0.1)',
        secondary: '#10B981',    // ì—ë©”ë„ë“œ (ê°•ì¡°/íŒŒí‹°ìƒì„±)
        accent: '#8B5CF6',       // ë³´ë¼ (ì„±ê³µ/í™•ì¸)
        background: '#F1F5F9',   // ì—°í•œ ë¸”ë£¨ ê·¸ë ˆì´
        surface: '#FFFFFF',
        text: '#1E293B',
        textSecondary: '#64748B',
        border: '#E2E8F0',
        gray: '#64748B',
        lightGray: '#E2E8F0',
        red: '#EF4444',
        disabled: '#CBD5E0',
        blue: '#3B82F6',         // íŒŒë€ìƒ‰ (ë©”ì¸)
        indigo: '#6366F1',       // ì¸ë””ê³  (ë‹¨ê³¨íŒŒí‹°)
        cyan: '#06B6D4',         // ì‹œì•ˆ (ë§›ì§‘)
        deepBlue: '#1D5D9B',      // ì§„í•œ íŒŒë€ìƒ‰
        skyBlue: '#75C2F6',       // ì—°í•œ íŒŒë€ìƒ‰
        yellow: '#F4D160',        // ë°ì€ ë…¸ë€ìƒ‰
        paleYellow: '#FBEEAC',     // ì—°í•œ ë…¸ë€ìƒ‰
        white: '#FFFFFF',         // í°ìƒ‰
    },
    // ë‹¤í¬ ëª¨ë“œ
    dark: {
        primary: '#60A5FA',      // ë°ì€ íŒŒë€ìƒ‰
        primaryLight: 'rgba(96, 165, 250, 0.1)',
        secondary: '#34D399',    // ë°ì€ ì—ë©”ë„ë“œ
        accent: '#A78BFA',       // ë°ì€ ë³´ë¼
        background: '#0F172A',   // ì§„í•œ ë„¤ì´ë¹„
        surface: '#1E293B',      // ì–´ë‘ìš´ ê·¸ë ˆì´
        text: '#F8FAFC',         // ë°ì€ í…ìŠ¤íŠ¸
        textSecondary: '#94A3B8', // íšŒìƒ‰ í…ìŠ¤íŠ¸
        border: '#334155',       // ì–´ë‘ìš´ ë³´ë”
        gray: '#94A3B8',
        lightGray: '#334155',
        red: '#F87171',
        disabled: '#475569',
        blue: '#60A5FA',
        indigo: '#818CF8',
        cyan: '#22D3EE',
        deepBlue: '#3B82F6',
        skyBlue: '#7DD3FC',
        yellow: '#FCD34D',
        paleYellow: '#FEF3C7',
        white: '#FFFFFF',         // í°ìƒ‰
    }
};



LocaleConfig.locales['ko'] = { monthNames: ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'], monthNamesShort: ['1.', '2.', '3.', '4.', '5.', '6.', '7.', '8.', '9.', '10.', '11.', '12.'], dayNames: ['ì¼ìš”ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'], dayNamesShort: ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '], today: 'ì˜¤ëŠ˜' };
LocaleConfig.defaultLocale = 'ko';

// --- ì¬ì‚¬ìš© ì»´í¬ë„ŒíŠ¸ ---
const SelectionModal = ({ visible, title, options, selected, onSelect, onClose, isMultiSelect = false, styles, colors }) => {
    const handleSelect = (item) => {
        if (isMultiSelect) {
            let newSelected = [...selected];
            if (newSelected.includes(item)) {
                newSelected = newSelected.filter(i => i !== item);
            } else if (newSelected.length < 3) {
                newSelected.push(item);
            } else {
                Alert.alert("ì„ íƒ ì œí•œ", "ìµœëŒ€ 3ê°œê¹Œì§€ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            }
            onSelect(newSelected);
        } else {
            onSelect(item);
            onClose();
        }
    };
    return (
        <Modal visible={visible} transparent={true} animationType="fade" onRequestClose={onClose}>
            <Pressable style={styles.centeredView} onPress={onClose}>
                <Pressable style={styles.modalView}>
                    <Text style={styles.modalTitle}>{title}</Text>
                    <ScrollView 
                        style={{width: '100%', maxHeight: 300}}
                        showsVerticalScrollIndicator={false}
                        contentContainerStyle={{paddingBottom: 10}}
                    >
                        {options.map(item => (
                            <TouchableOpacity key={item} style={[styles.optionButton, (isMultiSelect ? selected.includes(item) : selected === item) && styles.optionButtonSelected]} onPress={() => handleSelect(item)}>
                                <Text style={[styles.optionButtonText, (isMultiSelect ? selected.includes(item) : selected === item) && styles.optionButtonTextSelected]}>{item}</Text>
                            </TouchableOpacity>
                        ))}
                    </ScrollView>
                    {isMultiSelect && <Pressable style={[styles.button, styles.buttonClose]} onPress={onClose}><Text style={styles.textStyleBlack}>ì„ íƒ ì™„ë£Œ</Text></Pressable>}
                </Pressable>
            </Pressable>
        </Modal>
    );
};

const NumberScroller = ({ onSelect, initialValue = 4, styles }) => {
    const numbers = Array.from({ length: 9 }, (_, i) => i + 2); // 2 to 10
    const scrollViewRef = useRef(null);

    useEffect(() => {
        const initialIndex = numbers.indexOf(initialValue);
        if (initialIndex !== -1 && scrollViewRef.current) {
            setTimeout(() => scrollViewRef.current.scrollTo({ y: initialIndex * 50, animated: false }), 100);
        }
    }, [initialValue]);

    return (
        <View style={styles.scrollerContainer}>
            <ScrollView
                ref={scrollViewRef}
                style={styles.scroller}
                onMomentumScrollEnd={(event) => {
                    const index = Math.round(event.nativeEvent.contentOffset.y / 50);
                    onSelect(numbers[index]);
                }}
                snapToInterval={50}
                showsVerticalScrollIndicator={false}
                decelerationRate="fast"
            >
                {numbers.map(num => (
                    <View key={num} style={styles.scrollerItem}>
                        <Text style={styles.scrollerItemText}>{num}ëª…</Text>
                    </View>
                ))}
            </ScrollView>
            <View style={styles.scrollerIndicator} />
        </View>
    );
};

// --- í…Œë§ˆ ê´€ë¦¬ í•¨ìˆ˜ ---

LocaleConfig.locales['ko'] = { monthNames: ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'], monthNamesShort: ['1.', '2.', '3.', '4.', '5.', '6.', '7.', '8.', '9.', '10.', '11.', '12.'], dayNames: ['ì¼ìš”ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'], dayNamesShort: ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '], today: 'ì˜¤ëŠ˜' };
LocaleConfig.defaultLocale = 'ko';

// --- í™ˆ íƒ­ --- (HomeScreenì€ screens/HomeScreen.jsë¡œ ë¶„ë¦¬ë¨)


        
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        fetch(`${RENDER_SERVER_URL}/events/${myEmployeeId}`).then(res => res.json()).then(data => {
    if (!data || typeof data !== 'object') return;
    const newMarkedDates = {};
    const upcoming = [];

    // 1. ì˜¤ëŠ˜ë¶€í„° 7ì¼ê°„ì˜ 'ë‚˜ì˜ ì ì‹¬ ì•½ì†'ë§Œ upcomingì— ë„£ê¸° (UIìš©)
    for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        const dateString = toLocalDateString(date);
        const eventsOnDate = data[dateString] || [];
        const todayString = toLocalDateString(today);
        if (dateString >= todayString) {
            upcoming.push({ date: dateString, events: eventsOnDate });
        }
    }

    // 2. ë°ì´í„°ì— ìˆëŠ” ëª¨ë“  ë‚ ì§œë¥¼ markedDatesì— í‘œì‹œ (ë‹¬ë ¥ ë™ê·¸ë¼ë¯¸) - ê³¼ê±°/ë¯¸ë˜ ëª¨ë‘ í¬í•¨
    Object.keys(data).forEach(dateString => {
        const eventsOnDate = data[dateString] || [];
        if (eventsOnDate.length > 0) {
            // ì¼ì • íƒ€ì…ë³„ë¡œ ìƒ‰ìƒ ê²°ì •
            let hasRandomLunch = false;
            let hasPersonalSchedule = false;
            let hasOtherEvents = false;
            eventsOnDate.forEach(event => {
                if (event.type === 'ëœë¤ ëŸ°ì¹˜') {
                    hasRandomLunch = true;
                } else if (event.type === 'ê°œì¸ ì¼ì •') {
                    hasPersonalSchedule = true;
                } else {
                    hasOtherEvents = true;
                }
            });
            // ìš°ì„ ìˆœìœ„: ëœë¤ëŸ°ì¹˜ > ê°œì¸ì¼ì • > ê¸°íƒ€
            let dotColor;
            if (hasRandomLunch) {
                dotColor = '#F4D160';
            } else if (hasPersonalSchedule) {
                dotColor = currentColors.gray;
            } else {
                dotColor = currentColors.primary;
            }
            newMarkedDates[dateString] = {
                selected: true,
                selectedColor: dotColor,
                selectedTextColor: '#FFFFFF'
            };
        }
    });

    setAppointments(upcoming);
    setMarkedDates(newMarkedDates);
    // ì „ì²´ ì´ë²¤íŠ¸ ë°ì´í„°ë¥¼ ì €ì¥ (ë‹¬ë ¥ í´ë¦­ ì‹œ ì‚¬ìš©)
    setAllEvents(data);
}).catch(console.error);

        fetch(`${RENDER_SERVER_URL}/match/status/${myEmployeeId}`).then(res => res.json()).then(data => {
            if (!data) return;
            setMatchStatus(data.status);
            if (data.status === 'waiting' && data.countdown_target) {
                countdownIntervalRef.current = setInterval(() => {
                    const diff = new Date(data.countdown_target) - new Date();
                    if (diff <= 0) {
                        clearInterval(countdownIntervalRef.current);
                        setCountdown('ì˜¤ì „ 10ì‹œ! ë§¤ì¹­ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤...');
                        fetchHomeData(); 
                    } else {
                        const hours = Math.floor(diff / (1000 * 60 * 60));
                        const minutes = Math.floor((diff / 1000 / 60) % 60);
                        const seconds = Math.floor((diff / 1000) % 60);
                        setCountdown(`ì˜¤ì „ 10ì‹œ ë§¤ì¹­ê¹Œì§€ ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);
                    }
                }, 1000);
            } else {
                setCountdown('');
            }
        }).catch(console.error);

    }, []);

    useFocusEffect(fetchHomeData);
    
    useEffect(() => { return () => { if (countdownIntervalRef.current) clearInterval(countdownIntervalRef.current); }; }, []);

    const handleMatchPress = async () => {
        // ìŠ¤ë§ˆíŠ¸ ëœë¤ ëŸ°ì¹˜ í™”ë©´ìœ¼ë¡œ ì´ë™
        navigation.navigate('íŒŒí‹°', { screen: 'RandomLunch' });
    };
    
    const handleConfirmMatch = async () => {
        try {
            const response = await fetch(`${RENDER_SERVER_URL}/match/confirm`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ group_id: matchProposal.groupId }), });
            const data = await response.json();
            setMatchProposal({ visible: false, group: [], groupId: null });
            Alert.alert("ì„±ê³µ!", data.message);
            fetchHomeData();
        } catch (error) { Alert.alert("ì˜¤ë¥˜", "ë§¤ì¹­ í™•ì • ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
    };
    
    const handleRejectMatch = async () => {
        try {
            const response = await fetch(`${RENDER_SERVER_URL}/match/reject`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ group_id: matchProposal.groupId, employee_id: myEmployeeId }), });
            const data = await response.json();
            setMatchProposal({ visible: false, group: [], groupId: null });
            Alert.alert("ì•Œë¦¼", data.message);
            fetchHomeData();
        } catch (error) { Alert.alert("ì˜¤ë¥˜", "ë§¤ì¹­ ê±°ì ˆ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
    };

    const goToAddPersonalSchedule = (date) => {
        setModalData({ visible: false, events: [] });
        navigation.navigate("íŒŒí‹°", { screen: "CreatePersonalSchedule", params: { date } });
    };

    // ê°œì¸ ì¼ì • ì¶”ê°€ í›„ í™ˆ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ì„ ìœ„í•œ ë¦¬ìŠ¤ë„ˆ
    useFocusEffect(useCallback(() => {
        const unsubscribe = navigation.addListener('focus', () => {
            fetchHomeData();
        });
        return unsubscribe;
    }, [navigation]));

    const handleEditPersonalSchedule = (event) => {
        setModalData({ visible: false, events: [] });
        navigation.navigate('íŒŒí‹°', { screen: 'EditPersonalSchedule', params: { schedule: event } });
    };

    const handleDeletePersonalSchedule = (scheduleId) => {
        Alert.alert("ì¼ì • ì‚­ì œ", "ì •ë§ë¡œ ì´ ì ì‹¬ ì•½ì†ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", [
            { text: "ì·¨ì†Œ", style: "cancel" },
            { text: "ì‚­ì œ", style: "destructive", onPress: async () => {
                const response = await fetch(`${RENDER_SERVER_URL}/personal_schedules/${scheduleId}`, { method: 'DELETE' });
                if (response.ok) {
                    Alert.alert("ì„±ê³µ", "ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    setModalData({ visible: false, events: [] });
                    fetchHomeData();
                } else { Alert.alert("ì˜¤ë¥˜", "ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); }
            }}
        ]);
    };

    const renderAppointmentItem = ({ item }) => {
        const date = new Date(item.date);
        const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];
        return (
            <TouchableOpacity style={styles.appointmentCard} onPress={() => { 
                setModalData({ visible: true, events: item.events || [], date: item.date }); 
            }}>
                <Text style={styles.appointmentDate}>{`${date.getDate()}ì¼ (${dayOfWeek})`}</Text>
                {item.events && item.events.length > 0 ? (
                    item.events.map((event, index) => {
                        // ì°¸ì„ìì—ì„œ ë‚´ ë‹‰ë„¤ì„ ì œì™¸
                        let others = (event.all_members || event.members || []).map(s => s.trim()).filter(name => name.toLowerCase() !== myNickname.trim().toLowerCase());
                        // descriptionì—ì„œ ì‹œê°„, ì‹ë‹¹, ì°¸ì„ì íŒŒì‹± (í•„ë“œê°€ ì—†ì„ ë•Œë§Œ)
                        let parsedTime = event.time;
                        let parsedRestaurant = event.restaurant;
                        if ((!parsedTime || !parsedRestaurant || others.length === 0) && event.description) {
                            const timeMatch = event.description.match(/ì‹œê°„: ([^\n]+)/);
                            const restaurantMatch = event.description.match(/ì‹ë‹¹: ([^\n]+)/);
                            const attendeesMatch = event.description.match(/ì°¸ì„ì: ([^\n]+)/);
                            if (!parsedTime && timeMatch) parsedTime = timeMatch[1].trim();
                            if (!parsedRestaurant && restaurantMatch) parsedRestaurant = restaurantMatch[1].trim();
                            if (others.length === 0 && attendeesMatch) {
                                others = attendeesMatch[1].split(',').map(s => s.trim()).filter(name => name && name.toLowerCase() !== myNickname.trim().toLowerCase());
                            }
                        }
                        return (
                            <View key={index} style={styles.eventItem}>
                                <Text style={styles.eventTitle} numberOfLines={1}>{event.type === 'ëœë¤ ëŸ°ì¹˜' ? 'âš¡ï¸' : (event.type === 'íŒŒí‹°' ? 'ğŸ‰' : 'ğŸ“')} {event.title}</Text>
                                {/* ì‹œê°„ í‘œì‹œ */}
                                {parsedTime && <Text style={styles.eventDetail} numberOfLines={1}>â° {parsedTime}</Text>}
                                {/* ì‹ë‹¹ í‘œì‹œ */}
                                {parsedRestaurant && <Text style={styles.eventDetail} numberOfLines={1}>ğŸ½ï¸ {parsedRestaurant}</Text>}
                                {/* ì°¸ì„ì(ë‚´ ë‹‰ë„¤ì„ ì œì™¸) */}
                                {others.length > 0 && <Text style={styles.eventDetail} numberOfLines={1}>ğŸ‘¥ {others.join(', ')}</Text>}
                            </View>
                        );
                    })
                ) : (<View style={{flex: 1, justifyContent: 'center'}}><Text style={styles.noAppointmentText}>ì•½ì† ì—†ìŒ</Text></View>)}
            </TouchableOpacity>
        );
    };

    const renderRandomLunchCard = () => {
        const isWaiting = matchStatus === 'waiting';
        const isMatched = matchStatus === 'matched';
        
        // ë§¤ì¹­ ì˜¤í”ˆ ì‹œê°„ê¹Œì§€ ë‚¨ì€ ì‹œê°„ ê³„ì‚°
        const getTimeUntilMatch = () => {
            const now = new Date();
            const today = toLocalDateString(new Date());
            const matchTime = new Date(today.getTime() + (10 * 60 * 60 * 1000)); // ì˜¤ì „ 10ì‹œ
            
            if (now >= matchTime) {
                return null; // ì´ë¯¸ ë§¤ì¹­ ì‹œê°„ì´ ì§€ë‚¬ìŒ
            }
            
            const diff = matchTime - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff / (1000 * 60)) % 60);
            
            return `${hours}ì‹œê°„ ${minutes}ë¶„`;
        };
        
        const getCardContent = () => {
            if (isMatched) return { title: 'ë§¤ì¹­ ì™„ë£Œ! âœ…', description: 'ì˜¤ëŠ˜ì˜ ì ì‹¬ ì•½ì†ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', icon: 'checkmark-done-circle', color: COLORS.white };
            if (isWaiting) {
                return { title: 'ë§¤ì¹­ ëŒ€ê¸° ì¤‘... â³', description: 'ì˜¤ì „ 10ì‹œì— ë§¤ì¹­ì´ ì‹œì‘ë©ë‹ˆë‹¤.\në‹¤ì‹œ ëˆ„ë¥´ë©´ ëŒ€ê¸°ê°€ ì·¨ì†Œë©ë‹ˆë‹¤.', icon: 'time', color: COLORS.white };
            }
            return { title: 'ëœë¤ ëŸ°ì¹˜ ğŸ²', description: 'ìƒˆë¡œìš´ ë™ë£Œì™€ ì ì‹¬ ì•½ì†ì„ ì¡ì•„ë³´ì„¸ìš”!', icon: 'shuffle', color: COLORS.white };
        };
        
        const { title, description, icon, color } = getCardContent();
        return (
            <TouchableOpacity style={[styles.card, {backgroundColor: colors.primary}]} onPress={handleMatchPress} disabled={isMatched}>
                <View style={{flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center'}}>
                    <Text style={{color: '#FFFFFF', fontSize: 20, fontWeight: 'bold', marginBottom: 12}}>{title}</Text>
                    <Ionicons name={icon} size={28} color="#FFFFFF" />
                </View>
                <Text style={{color: '#FFFFFF', fontSize: 16, marginTop: 8}}>{description}</Text>
                {isWaiting && countdown ? <Text style={{color: '#FFFFFF', fontSize: 14, fontWeight: 'bold', marginTop: 8}}>{countdown}</Text> : null}
            </TouchableOpacity>
        );
    };
    
    return (
        <SafeAreaView style={styles.safeArea}>
            <ScrollView contentContainerStyle={styles.homeContainer}>
                <View style={[styles.card, {marginTop: 16}]}><Text style={styles.cardTitle}>ì˜¤ëŠ˜ì˜ êµ¬ë‚´ì‹ë‹¹ ë©”ë‰´ ğŸ±</Text><Text style={styles.menuText}>{(todayMenu || []).length > 0 ? todayMenu.join(', ') : 'ë©”ë‰´ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'}</Text></View>
                {renderRandomLunchCard()}
                <View style={styles.card}><Text style={styles.cardTitle}>ë‚˜ì˜ ì ì‹¬ ì•½ì† ğŸ—“ï¸</Text><FlatList data={appointments || []} renderItem={renderAppointmentItem} keyExtractor={item => item.date} horizontal showsHorizontalScrollIndicator={false} contentContainerStyle={{ paddingVertical: 5 }} /></View>
                <View style={styles.card}><Text style={styles.cardTitle}>ë‹¬ë ¥ ğŸ“…</Text><Calendar 
                    markedDates={markedDates} 
                    onDayPress={(day) => { 
                        // allEventsì—ì„œ í•´ë‹¹ ë‚ ì§œì˜ ì´ë²¤íŠ¸ë¥¼ ì°¾ê¸° (ê³¼ê±°/ë¯¸ë˜ ëª¨ë“  ë‚ ì§œ í¬í•¨)
                        const events = allEvents[day.dateString] || []; 
                        setModalData({ visible: true, events: events, date: day.dateString }); 
                    }} 
                    theme={{ 
                        selectedDayBackgroundColor: currentColors.primary, 
                        todayTextColor: currentColors.primary, 
                        arrowColor: currentColors.primary,
                        selectedDayTextColor: '#FFFFFF',
                        'stylesheet.calendar.header': { 
                            week: { 
                                marginTop: 5, 
                                flexDirection: 'row', 
                                justifyContent: 'space-between' 
                            } 
                        },
                        'stylesheet.day.basic': {
                            base: {
                                width: 32,
                                height: 32,
                                alignItems: 'center',
                                justifyContent: 'center'
                            }
                        }
                    }} 
                /></View>
            </ScrollView>

            <Modal visible={modalData.visible} transparent={true} animationType="fade" onRequestClose={() => setModalData({ ...modalData, visible: false })}>
                <Pressable style={styles.centeredView} onPress={() => setModalData({ ...modalData, visible: false })}>
                    <View style={styles.modalView}>
                        {(modalData.events || []).length > 0 ? (
                            <>
                                <Text style={styles.modalTitle}>{new Date(modalData.events[0].date).toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' })} ì ì‹¬ ì•½ì†</Text>
                                <ScrollView style={{width: '100%', maxHeight: SCREEN_HEIGHT * 0.5 }}>
                                    {modalData.events.map((event, index) => (
                                        <View key={index} style={styles.modalDetailCard}>
                                            <Text style={styles.eventTitle}>{event.type === 'ëœë¤ ëŸ°ì¹˜' ? 'âš¡ï¸' : (event.type === 'íŒŒí‹°' ? 'ğŸ‰' : 'ğŸ“')} {event.title}</Text>
                                            {event.type !== 'ê°œì¸ ì¼ì •' ? (
                                                <>
                                                    <Text style={styles.modalDetailText}>âˆ™ ì¼ì‹œ: {event.date} {event.time}</Text>
                                                    <Text style={styles.modalDetailText}>âˆ™ ì‹ë‹¹: {event.restaurant}</Text>
                                                    {event.address && <Text style={styles.modalDetailText}>âˆ™ ì£¼ì†Œ: {event.address}</Text>}
                                                    <Text style={styles.modalDetailText}>âˆ™ ì¥ì†Œ: {event.location}</Text>
                                                    <Text style={styles.modalDetailText}>âˆ™ ì°¸ì„ì: {(event.all_members || []).join(', ')}</Text>
                                                    <TouchableOpacity style={[styles.button, {backgroundColor: currentColors.primary, marginTop: 15}]} onPress={() => { setModalData({ visible: false }); navigation.navigate('ì†Œí†µ', { screen: 'ChatRoom', params: { chatId: event.id, chatType: 'party', chatTitle: event.title } }); }}><Text style={styles.textStyle}>ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™</Text></TouchableOpacity>
                                                </>
                                            ) : (
                                                <>
                                                    <Text style={styles.modalDetailText}>{event.description || 'ë©”ëª¨ ì—†ìŒ'}</Text>
                                                    <View style={{flexDirection: 'row', justifyContent: 'space-around', marginTop: 15}}>
                                                        <TouchableOpacity style={[styles.button, {backgroundColor: currentColors.primary, width: '48%'}]} onPress={() => handleEditPersonalSchedule(event)}>
                                                            <Text style={[styles.textStyle, {color: '#FFFFFF'}]}>ìˆ˜ì •</Text>
                                                        </TouchableOpacity>
                                                        <TouchableOpacity style={[styles.button, {backgroundColor: currentColors.gray, width: '48%'}]} onPress={() => handleDeletePersonalSchedule(event.id)}>
                                                            <Text style={[styles.textStyle, {color: '#FFFFFF'}]}>ì‚­ì œ</Text>
                                                        </TouchableOpacity>
                                                    </View>
                                                </>
                                            )}
                                        </View>
                                    ))}
                                </ScrollView>
                            </>
                        ) : ( 
                            <>
<Text style={styles.modalTitle}>ì ì‹¬ ì•½ì†ì„ ë§Œë“¤ì–´ ë³¼ê¹Œìš”?</Text>
<Pressable
  style={{
    backgroundColor: currentColors.yellow,
    borderRadius: 18,
    marginTop: 12,
    marginBottom: 8,
    paddingVertical: 16,
    paddingHorizontal: 20,
    alignItems: 'center',
    elevation: 4,
    width: '100%',
  }}
  onPress={() => { setModalData({ visible: false }); handleMatchPress(); }}
>
  <Text style={{ color: currentColors.deepBlue, fontSize: 16, fontWeight: 'bold' }}>
    ğŸ² ëœë¤ ëŸ°ì¹˜ ì‹œì‘í•˜ê¸°
  </Text>
</Pressable>
<Pressable
  style={{
    backgroundColor: currentColors.primary,
    borderRadius: 18,
    marginTop: 8,
    marginBottom: 8,
    paddingVertical: 16,
    paddingHorizontal: 20,
    alignItems: 'center',
    elevation: 4,
    width: '100%',
  }}
  onPress={() => { setModalData({ visible: false }); navigation.navigate('íŒŒí‹°'); }}
>
  <Text style={{ color: '#FFFFFF', fontSize: 16, fontWeight: 'bold' }}>
    ğŸ‰ íŒŒí‹° ì°¸ì—¬í•˜ê¸°
  </Text>
</Pressable>
<Pressable
  style={{
    backgroundColor: currentColors.gray,
    borderRadius: 18,
    marginTop: 8,
    marginBottom: 12,
    paddingVertical: 16,
    paddingHorizontal: 20,
    alignItems: 'center',
    elevation: 4,
    width: '100%',
  }}
  onPress={() => goToAddPersonalSchedule(modalData.date)}
>
  <Text style={{ color: '#FFFFFF', fontSize: 16, fontWeight: 'bold' }}>
    ğŸ“ ê°œì¸ ì ì‹¬ ì•½ì† ì¶”ê°€
  </Text>
</Pressable>
</>
)}
</View>
</Pressable>
</Modal>
            
            {/* í”Œë¡œíŒ… ë¹ ë¥¸ ì•¡ì…˜ ë²„íŠ¼ */}
            <TouchableOpacity
                style={{
                    position: 'absolute',
                    right: 24,
                    bottom: 32,
                    width: 56,
                    height: 56,
                    borderRadius: 28,
                    backgroundColor: currentColors.primary,
                    justifyContent: 'center',
                    alignItems: 'center',
                    zIndex: 10,
                    elevation: 8,
                    shadowColor: currentColors.primary,
                    shadowOffset: { width: 0, height: 4 },
                    shadowOpacity: 0.3,
                    shadowRadius: 8
                }}
                activeOpacity={0.85}
                onPress={() => {
                    const today = toLocalDateString(new Date());
                    setModalData({ visible: true, events: [], date: today });
                }}
            >
                <Ionicons name="add" size={32} color="#fff" />
            </TouchableOpacity>
        </SafeAreaView>
    );
}

// --- ìƒˆë¡œìš´ ëœë¤ ëŸ°ì¹˜ ì‹œìŠ¤í…œ í™”ë©´ë“¤ ---
function SelectLunchDateScreen({ navigation }) {
    const [availableDates, setAvailableDates] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        fetchAvailableDates();
    }, []);

    const fetchAvailableDates = async () => {
        try {
            setLoading(true);
            const response = await fetch(`${RENDER_SERVER_URL}/proposals/available-dates?employee_id=${myEmployeeId}`);
            const data = await response.json();
            if (response.ok) {
                // ì˜¤ëŠ˜ ì´í›„(ì˜¤ëŠ˜ í¬í•¨) ë‚ ì§œë§Œ ë‚¨ê¸°ê¸°
                const today = new Date();
                today.setHours(0, 0, 0, 0); // ì˜¤ëŠ˜ 00:00

                const filteredDates = data.filter(d => {
                    // dê°€ 'YYYY-MM-DD' ë¬¸ìì—´ì´ë©´, í•­ìƒ UTC ê¸°ì¤€ìœ¼ë¡œ í•´ì„
                    const dateObj = new Date(d + 'T00:00:00Z');
                    // í•œêµ­ ì‹œê°„(UTC+9)ìœ¼ë¡œ ë³€í™˜
                    const koreaDate = new Date(dateObj.getTime() + 9 * 60 * 60 * 1000);
                    koreaDate.setHours(0, 0, 0, 0);
                    
                    return koreaDate > today; // ì˜¤ëŠ˜ë³´ë‹¤ í° ë‚ ì§œ(ë‚´ì¼ë¶€í„°)ë§Œ ë‚¨ê¹€
                });
                
                setAvailableDates(filteredDates);
} else {
    Alert.alert('ì˜¤ë¥˜', data.message || 'ë‚ ì§œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
}
        } catch (error) {
            console.error('ë‚ ì§œ ì¡°íšŒ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
            setLoading(false);
        }
    };

    const handleDateSelect = (date) => {
        navigation.navigate('SuggestGroupScreen', { selectedDate: date });
    };

    const renderDateButton = ({ item }) => {
        const date = new Date(item);
        const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];
        const isToday = new Date().toDateString() === date.toDateString();
        
        return (
            <TouchableOpacity 
                style={[styles.dateButton, isToday && styles.todayButton]} 
                onPress={() => handleDateSelect(item)}
            >
                <Text style={[styles.dateButtonText, isToday && styles.todayButtonText]}>
                    {date.getDate()}ì¼
                </Text>
                <Text style={[styles.dateButtonSubText, isToday && styles.todayButtonText]}>
                    ({dayOfWeek})
                </Text>
                {isToday && <Text style={styles.todayLabel}>ì˜¤ëŠ˜</Text>}
            </TouchableOpacity>
        );
    };

    if (loading) {
        return (
            <SafeAreaView style={styles.safeArea}>
                <View style={styles.loadingContainer}>
                    <ActivityIndicator size="large" color={COLORS.primary} />
                    <Text style={styles.loadingText}>ë‚ ì§œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</Text>
                </View>
            </SafeAreaView>
        );
    }

    return (
        <SafeAreaView style={styles.safeArea}>
            <View style={styles.header}>
                <View style={{width: 24}} />
            </View>
            
            <ScrollView style={styles.container}>
                <View style={[styles.card, {marginTop: 16}]}>
                    <Text style={styles.cardTitle}>ì–¸ì œ ì ì‹¬ì„ ë¨¹ìœ¼ì‹œê² ì–´ìš”? ğŸ½ï¸</Text>
                    <Text style={styles.cardDescription}>
                        ì•½ì†ì´ ì—†ëŠ” ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.
                    </Text>
                </View>
                
                <FlatList
                    data={availableDates}
                    renderItem={renderDateButton}
                    keyExtractor={item => item}
                    numColumns={3}
                    contentContainerStyle={styles.dateGrid}
                    scrollEnabled={false}
                />
            </ScrollView>
        </SafeAreaView>
    );
}

function SuggestGroupScreen({ navigation, route }) {
    const { selectedDate } = route.params;
    const [suggestedGroups, setSuggestedGroups] = useState([]);
    const [loading, setLoading] = useState(true);
    const [currentGroupIndex, setCurrentGroupIndex] = useState(0);
    const [proposedGroups, setProposedGroups] = useState(new Set());

    useEffect(() => {
        fetchSuggestedGroups();
    }, []);

    useEffect(() => {
        if (suggestedGroups.length > 0) {
            fetchMyProposals();
        }
    }, [suggestedGroups]);

    // í™”ë©´ì´ í¬ì»¤ìŠ¤ë  ë•Œë§ˆë‹¤ ì œì•ˆ ìƒíƒœ ìƒˆë¡œê³ ì¹¨
    useFocusEffect(
        useCallback(() => {
            fetchMyProposals();
        }, [])
    );

    const fetchMyProposals = async () => {
        try {
            const response = await fetch(`${RENDER_SERVER_URL}/proposals/mine?employee_id=${myEmployeeId}`);
            const data = await response.json();
            if (response.ok) {
                const sentProposals = data.sent_proposals || [];
                const pendingProposals = sentProposals.filter(p => p.status === 'pending');
                const proposedGroupKeys = new Set();
                pendingProposals.forEach(proposal => {
                    if (proposal.recipient_ids) {
                        // ì—¬ê¸° ë‘ ì¤„ì´ ì¤‘ìš”!
                        const ids = parseRecipientIds(proposal.recipient_ids);
                        const groupKey = getGroupKeyFromIds(ids);
                        proposedGroupKeys.add(groupKey);
                    }
                });
                setProposedGroups(proposedGroupKeys);
            }
        } catch (error) {
            console.error('ì œì•ˆ ìƒíƒœ ì¡°íšŒ ì˜¤ë¥˜:', error);
        }
    };

    const fetchSuggestedGroups = async () => {
        try {
            setLoading(true);
            const response = await fetch(`${RENDER_SERVER_URL}/proposals/suggest-groups`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    employee_id: myEmployeeId,
                    date: selectedDate
                })
            });
            const data = await response.json();
            if (response.ok) {
                setSuggestedGroups(data);
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'ì¶”ì²œ ê·¸ë£¹ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ê·¸ë£¹ ì¶”ì²œ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
            setLoading(false);
        }
    };

    const handleProposeGroup = async (group) => {
        // ê·¸ë£¹ í‚¤ ìƒì„± (ì‚¬ìš©ì IDë“¤ì„ ì •ë ¬í•˜ì—¬ ì¼ê´€ì„± ìˆëŠ” í‚¤ ìƒì„±)
        const groupUserIds = group.users
            .map(user => user.employee_id)
            .filter(id => id && id.trim().length > 0)
            .sort();
        const groupKey = getGroupKeyFromIds(groupUserIds);
        
        // ì´ë¯¸ ì œì•ˆí•œ ê·¸ë£¹ì´ë©´ ì·¨ì†Œ
        if (proposedGroups.has(groupKey)) {
            try {
                // í•´ë‹¹ ë‚ ì§œì— ë‚´ê°€ ë³´ë‚¸ ì œì•ˆ ì°¾ê¸°
                const response = await fetch(`${RENDER_SERVER_URL}/proposals/mine?employee_id=${myEmployeeId}`);
                const data = await response.json();
                
                if (response.ok) {
                    const sentProposals = data.sent_proposals || [];
                    
                    // í•´ë‹¹ ê·¸ë£¹ì— í•´ë‹¹í•˜ëŠ” ì œì•ˆ ì°¾ê¸°
                    const myProposal = sentProposals.find(proposal => {
                        if (proposal.proposed_date !== selectedDate || proposal.status !== 'pending') {
                            return false;
                        }
                        
                        if (proposal.recipient_ids) {
                            const recipientIds = parseRecipientIds(proposal.recipient_ids);
                            return getGroupKeyFromIds(recipientIds) === groupKey;
                        }
                        return false;
                    });
                    
                    if (myProposal) {
                        const cancelResponse = await fetch(`${RENDER_SERVER_URL}/proposals/${myProposal.id}/cancel`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ employee_id: myEmployeeId })
                        });
                        
                        if (cancelResponse.ok) {
                            setProposedGroups(prev => {
                                const newSet = new Set(prev);
                                newSet.delete(groupKey);
                                return newSet;
                            });
                            Alert.alert('ì•Œë¦¼', 'ì œì•ˆì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            fetchMyProposals();
                        } else {
                            Alert.alert('ì˜¤ë¥˜', 'ì œì•ˆ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    }
                }
            } catch (error) {
                console.error('ì œì•ˆ ì·¨ì†Œ ì˜¤ë¥˜:', error);
                Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
            fetchMyProposals();
            return;
        }

        try {
            const recipientIds = group.users
                .map(user => user.employee_id)
                .filter(id => id && id.trim().length > 0);
            const response = await fetch(`${RENDER_SERVER_URL}/proposals`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    proposer_id: myEmployeeId,
                    recipient_ids: recipientIds,
                    proposed_date: selectedDate
                })
            });
            const data = await response.json();
            if (response.ok) {
                // ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
                setProposedGroups(prev => new Set([...prev, groupKey]));
                Alert.alert('ì„±ê³µ', 'ì œì•ˆì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                fetchMyProposals();
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'ì œì•ˆì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ì œì•ˆ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
        fetchMyProposals();
    };

    const renderUserCard = ({ item }) => (
        <View style={{
            backgroundColor: currentColors.surface,
            borderRadius: 16,
            padding: 16,
            marginBottom: 12,
            elevation: 2,
            shadowColor: currentColors.primary,
            shadowOffset: { width: 0, height: 2 },
            shadowOpacity: 0.1,
            shadowRadius: 4,
            borderWidth: 1,
            borderColor: 'rgba(59, 130, 246, 0.1)'
        }}>
            <View style={{flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8}}>
                <Text style={{fontSize: 16, fontWeight: 'bold', color: currentColors.text}}>{item.nickname}</Text>
                <View style={{
                    backgroundColor: currentColors.yellow,
                    borderRadius: 12,
                    paddingVertical: 4,
                    paddingHorizontal: 8
                }}>
                    <Text style={{color: currentColors.deepBlue, fontSize: 'bold', fontSize: 12}}>ì¶”ì²œ</Text>
                </View>
            </View>
            {item.lunch_preference && (
                <Text style={{fontSize: 14, color: currentColors.textSecondary, marginBottom: 4}}>ğŸ½ï¸ {item.lunch_preference}</Text>
            )}
            {item.main_dish_genre && (
                <Text style={{fontSize: 14, color: currentColors.textSecondary}}>ğŸœ {item.main_dish_genre}</Text>
            )}
        </View>
    );

    const renderGroupCard = ({ item, index }) => {
        // ê·¸ë£¹ í‚¤ ìƒì„±
        const groupUserIds = item.users
            .map(user => user.employee_id)
            .filter(id => id && id.trim().length > 0)
            .sort();
        const groupKey = getGroupKeyFromIds(groupUserIds);
        
        return (
            <View style={{
                backgroundColor: currentColors.surface,
                borderRadius: 20,
                padding: 20,
                marginHorizontal: 16,
                marginBottom: 16,
                elevation: 3,
                shadowColor: currentColors.primary,
                shadowOffset: { width: 0, height: 4 },
                shadowOpacity: 0.1,
                shadowRadius: 8,
                borderWidth: 1,
                borderColor: 'rgba(59, 130, 246, 0.1)'
            }}>
                <View style={{marginBottom: 16}}>
                    <Text style={{fontSize: 20, fontWeight: 'bold', color: currentColors.primary, marginBottom: 8}}>
                        ì¶”ì²œ ê·¸ë£¹ {index + 1}
                    </Text>
                    <Text style={{fontSize: 14, color: currentColors.textSecondary}}>
                        ì„±í–¥ì´ ë§ëŠ” ë™ë£Œë“¤ê³¼ í•¨ê»˜ ì ì‹¬ì„ ë¨¹ì–´ë³´ì„¸ìš”!
                    </Text>
                </View>
                
                <FlatList
                    data={item.users}
                    renderItem={renderUserCard}
                    keyExtractor={(user, index) => `user-${user.employee_id}-${index}`}
                    scrollEnabled={false}
                />
                
                <TouchableOpacity 
                    style={{
                        backgroundColor: proposedGroups.has(groupKey) ? currentColors.gray : currentColors.primary,
                        borderRadius: 16,
                        padding: 16,
                        marginTop: 16,
                        elevation: 3,
                        shadowColor: currentColors.primary,
                        shadowOffset: { width: 0, height: 2 },
                        shadowOpacity: 0.2,
                        shadowRadius: 4
                    }}
                    onPress={() => handleProposeGroup(item)}
                >
                    <Text style={{
                        color: '#FFFFFF',
                        fontWeight: 'bold',
                        textAlign: 'center',
                        fontSize: 16
                    }}>
                        {proposedGroups.has(groupKey) ? 'ì œì•ˆ ëŒ€ê¸°ì¤‘...' : 'ì´ ê·¸ë£¹ì— ì œì•ˆí•˜ê¸°'}
                    </Text>
                </TouchableOpacity>
            </View>
        );
    };

    if (loading) {
        return (
            <SafeAreaView style={styles.safeArea}>
                <View style={{
                    flex: 1,
                    justifyContent: 'center',
                    alignItems: 'center',
                    padding: 20,
                    backgroundColor: currentColors.background
                }}>
                    <ActivityIndicator size="large" color={currentColors.primary} />
                    <Text style={{
                        fontSize: 16,
                        color: currentColors.textSecondary,
                        marginTop: 16
                    }}>ì¶”ì²œ ê·¸ë£¹ì„ ì°¾ëŠ” ì¤‘...</Text>
                </View>
            </SafeAreaView>
        );
    }

    return (
        <SafeAreaView style={styles.safeArea}>
            <View style={styles.header}>
                <View style={{width: 24}} />
            </View>
            
            <View style={styles.container}>
                <View style={{
                    backgroundColor: currentColors.surface,
                    borderRadius: 20,
                    padding: 20,
                    marginHorizontal: 16,
                    marginBottom: 16,
                    elevation: 3,
                    shadowColor: currentColors.primary,
                    shadowOffset: { width: 0, height: 4 },
                    shadowOpacity: 0.1,
                    shadowRadius: 8,
                    borderWidth: 1,
                    borderColor: 'rgba(59, 130, 246, 0.1)'
                }}>
                    <Text style={{
                        fontSize: 20,
                        fontWeight: 'bold',
                        marginBottom: 12,
                        color: currentColors.primary
                    }}>
                        {new Date(selectedDate).toLocaleDateString('ko-KR', { 
                            month: 'long', 
                            day: 'numeric' 
                        })} ì¶”ì²œ ê·¸ë£¹
                    </Text>
                    <Text style={{
                        fontSize: 16,
                        color: currentColors.textSecondary,
                        lineHeight: 24
                    }}>
                        ì„±í–¥ì´ ë§ëŠ” ë™ë£Œë“¤ê³¼ í•¨ê»˜ ì ì‹¬ì„ ë¨¹ì–´ë³´ì„¸ìš”!
                        {suggestedGroups.length > 1 && ' ì¢Œìš°ë¡œ ìŠ¤ì™€ì´í”„í•˜ì—¬ ë‹¤ë¥¸ ê·¸ë£¹ë„ í™•ì¸í•´ë³´ì„¸ìš”.'}
                    </Text>
                </View>
                
                {suggestedGroups.length > 0 ? (
                    <>
                        <FlatList
                            data={suggestedGroups}
                            renderItem={renderGroupCard}
                            keyExtractor={item => `group-${item.group_id}`}
                            horizontal
                            pagingEnabled
                            showsHorizontalScrollIndicator={false}
                            onMomentumScrollEnd={(event) => {
                                const index = Math.round(event.nativeEvent.contentOffset.x / (SCREEN_WIDTH - 32));
                                setCurrentGroupIndex(index);
                            }}
                            contentContainerStyle={{ paddingHorizontal: 0 }}
                        />
                        
                        {suggestedGroups.length > 1 && (
                            <View style={{
                                flexDirection: 'row',
                                justifyContent: 'center',
                                alignItems: 'center',
                                marginTop: 20,
                                marginBottom: 20
                            }}>
                                {suggestedGroups.map((_, index) => (
                                    <View
                                        key={index}
                                        style={{
                                            width: 8,
                                            height: 8,
                                            borderRadius: 4,
                                            backgroundColor: index === currentGroupIndex ? currentColors.primary : currentColors.lightGray,
                                            marginHorizontal: 4
                                        }}
                                    />
                                ))}
                            </View>
                        )}
                    </>
                ) : (
                    <View style={{
                        flex: 1,
                        justifyContent: 'center',
                        alignItems: 'center',
                        padding: 20,
                        backgroundColor: currentColors.background
                    }}>
                        <Text style={{
                            fontSize: 16,
                            color: currentColors.textSecondary,
                            textAlign: 'center',
                            marginTop: 50
                        }}>
                            í•´ë‹¹ ë‚ ì§œì— ì¶”ì²œí•  ìˆ˜ ìˆëŠ” ë™ë£Œê°€ ì—†ìŠµë‹ˆë‹¤.
                        </Text>
                    </View>
                )}
            </View>
        </SafeAreaView>
    );
}

function MyProposalsScreen({ navigation }) {
    const [proposals, setProposals] = useState({ sent_proposals: [], received_proposals: [] });
    const [loading, setLoading] = useState(true);
    const [expandedProposals, setExpandedProposals] = useState(new Set());
    const [groupMembersMap, setGroupMembersMap] = useState({});
    const [confirmedGroups, setConfirmedGroups] = useState([]);

    useEffect(() => {
        fetchMyProposals();
        fetchConfirmedGroups();
    }, []);

    // í™”ë©´ì´ í¬ì»¤ìŠ¤ë  ë•Œë§ˆë‹¤ ì œì•ˆ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    useFocusEffect(
        useCallback(() => {
            fetchMyProposals();
            fetchConfirmedGroups();
        }, [])
    );

    const fetchConfirmedGroups = async () => {
        try {
            const response = await fetch(`${RENDER_SERVER_URL}/parties?employee_id=${myEmployeeId}&is_from_match=true`);
            const data = await response.json();
            if (response.ok && Array.isArray(data)) {
                // ì˜¤ëŠ˜ ì´í›„ì˜ ëœë¤ëŸ°ì¹˜ë§Œ í•„í„°ë§
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const filteredData = data.filter(party => {
                    const partyDate = new Date(party.party_date);
                    return partyDate >= today;
                });
                setConfirmedGroups(filteredData);
            }
        } catch (error) {
            console.error('ì„±ì‚¬ëœ ê·¸ë£¹ ì¡°íšŒ ì˜¤ë¥˜:', error);
        }
    };

    const handleRejectProposal = async (proposalId) => {
        try {
            const response = await fetch(`${RENDER_SERVER_URL}/proposals/${proposalId}/reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: myEmployeeId })
            });
            const data = await response.json();
            if (response.ok) {
                Alert.alert('ì•Œë¦¼', data.message || 'ì œì•ˆì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.');
                fetchMyProposals(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'ê±°ì ˆì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ì œì•ˆ ê±°ì ˆ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    };

    const fetchMyProposals = async () => {
        try {
            setLoading(true);
            const response = await fetch(`${RENDER_SERVER_URL}/proposals/mine?employee_id=${myEmployeeId}`);
            const data = await response.json();
            if (response.ok) {
                // ì˜¤ëŠ˜ ì´í›„ì˜ ì œì•ˆë§Œ í•„í„°ë§í•˜ê³  ì·¨ì†Œëœ ì œì•ˆ ì œê±°
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const filterProposals = (proposals) => {
                    return proposals.filter(p => {
                        // ì·¨ì†Œëœ ì œì•ˆ ì œê±°
                        if (p.status === 'cancelled') return false;
                        
                        // ì˜¤ëŠ˜ ì´í›„ì˜ ì œì•ˆë§Œ í¬í•¨
                        const proposalDate = new Date(p.proposed_date);
                        return proposalDate >= today;
                    });
                };
                
                const filteredData = {
                    sent_proposals: filterProposals(data.sent_proposals || []),
                    received_proposals: filterProposals(data.received_proposals || [])
                };
                setProposals(filteredData);
                
                // ë³´ë‚¸ ì œì•ˆë“¤ì˜ ê·¸ë£¹ ë©¤ë²„ ì •ë³´ë¥¼ ë°”ë¡œ ê°€ì ¸ì˜¤ê¸°
                const sentProposals = filteredData.sent_proposals || [];
                for (const proposal of sentProposals) {
                    if (proposal.recipient_ids) {
                        fetchGroupMembers(proposal.id, proposal.recipient_ids);
                    }
                }
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'ì œì•ˆ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ì œì•ˆ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
            setLoading(false);
        }
    };

    const handleAcceptProposal = async (proposalId) => {
        try {
            const response = await fetch(`${RENDER_SERVER_URL}/proposals/${proposalId}/accept`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: myEmployeeId })
            });
            const data = await response.json();
            
            if (response.ok) {
                if (data.status === 'confirmed') {
                    Alert.alert('ì„±ê³µ!', 'ë§¤ì¹­ì´ ì„±ì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    Alert.alert('ì•Œë¦¼', data.message);
                }
                fetchMyProposals();
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'ìˆ˜ë½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ì œì•ˆ ìˆ˜ë½ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    };

    const handleCancelProposal = async (proposalId) => {
        try {
            const response = await fetch(`${RENDER_SERVER_URL}/proposals/${proposalId}/cancel`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: myEmployeeId })
            });
            const data = await response.json();
            
            if (response.ok) {
                Alert.alert('ì•Œë¦¼', data.message);
                // ëª©ë¡ì—ì„œ ì¦‰ì‹œ ì œê±°
                setProposals(prev => ({
                    sent_proposals: prev.sent_proposals.filter(p => p.id !== proposalId),
                    received_proposals: prev.received_proposals
                }));
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ì œì•ˆ ì·¨ì†Œ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    };

    const toggleProposalExpansion = (proposalId) => {
        setExpandedProposals(prev => {
            const newSet = new Set(prev);
            if (newSet.has(proposalId)) {
                newSet.delete(proposalId);
            } else {
                newSet.add(proposalId);
            }
            return newSet;
        });
    };

    const fetchGroupMembers = async (proposalId, recipientIds) => {
        try {
            const userIds = parseRecipientIds(recipientIds);
            
            console.log('ê·¸ë£¹ ë©¤ë²„ ì¡°íšŒ:', { proposalId, recipientIds, userIds });
            
            if (userIds.length === 0) {
                console.log('ìœ íš¨í•œ ì‚¬ìš©ì IDê°€ ì—†ìŒ');
                setGroupMembersMap(prev => ({
                    ...prev,
                    [proposalId]: []
                }));
                return;
            }
            
            const response = await fetch(`${RENDER_SERVER_URL}/users/batch`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_ids: userIds })
            });
            
            console.log('API ì‘ë‹µ ìƒíƒœ:', response.status);
            const data = await response.json();
            console.log('API ì‘ë‹µ ë°ì´í„°:', data);
            
            if (response.ok && Array.isArray(data)) {
                setGroupMembersMap(prev => ({
                    ...prev,
                    [proposalId]: data
                }));
                console.log('ê·¸ë£¹ ë©¤ë²„ ì •ë³´ ì €ì¥ ì™„ë£Œ:', data);
            } else {
                console.error('API ì‘ë‹µ ì˜¤ë¥˜:', data);
                // ì—ëŸ¬ ì‹œì—ë„ ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •í•˜ì—¬ ë¡œë”© ìƒíƒœ í•´ì œ
                setGroupMembersMap(prev => ({
                    ...prev,
                    [proposalId]: []
                }));
            }
        } catch (error) {
            console.error('ê·¸ë£¹ ë©¤ë²„ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
            // ì—ëŸ¬ ì‹œì—ë„ ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •í•˜ì—¬ ë¡œë”© ìƒíƒœ í•´ì œ
            setGroupMembersMap(prev => ({
                ...prev,
                [proposalId]: []
            }));
        }
    };

    const renderConfirmedGroupItem = ({ item }) => (
        <TouchableOpacity 
            style={{
                backgroundColor: currentColors.surface,
                borderRadius: 16,
                padding: 16,
                marginHorizontal: 6,
                width: SCREEN_WIDTH * 0.5,
                height: 160,
                borderWidth: 2,
                borderColor: currentColors.lightGray,
                justifyContent: 'flex-start',
                elevation: 2,
                shadowColor: currentColors.primary,
                shadowOffset: { width: 0, height: 2 },
                shadowOpacity: 0.1,
                shadowRadius: 4
            }}
            onPress={() => navigation.navigate('PartyDetail', { partyId: item.id })}
        >
            <View style={{marginBottom: 8}}>
                <Text style={{fontSize: 16, fontWeight: 'bold', color: currentColors.text}}>âš¡ï¸ {item.party_date}</Text>
            </View>
            <Text style={{fontSize: 13, color: currentColors.textSecondary, marginBottom: 8}}>
                ğŸ‘¥ {item.current_members}ëª… ì°¸ì—¬
            </Text>
            <Text style={{fontSize: 13, color: currentColors.textSecondary}}>
                ğŸ½ï¸ {item.restaurant_name}
            </Text>
        </TouchableOpacity>
    );

    const renderProposalItem = ({ item, type }) => {
        const isPending = item.status === 'pending';
        const isReceived = type === 'received';
        const isExpanded = expandedProposals.has(item.id);
        const groupMembers = groupMembersMap[item.id] || [];
        
        // ê·¸ë£¹ ë©¤ë²„ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (hooks ì—†ì´ ì²˜ë¦¬)
        if (isExpanded && type === 'sent' && item.recipient_ids && !groupMembersMap[item.id]) {
            console.log('ê·¸ë£¹ ë©¤ë²„ ì •ë³´ ìš”ì²­:', { proposalId: item.id, recipientIds: item.recipient_ids });
            fetchGroupMembers(item.id, item.recipient_ids);
        }
        
        return (
            <View style={{
                backgroundColor: currentColors.surface,
                borderRadius: 16,
                marginHorizontal: 16,
                marginBottom: 12,
                padding: 16,
                elevation: 2,
                shadowColor: currentColors.primary,
                shadowOffset: { width: 0, height: 2 },
                shadowOpacity: 0.1,
                shadowRadius: 4,
                borderWidth: 1,
                borderColor: 'rgba(99, 102, 241, 0.2)'
            }}>
                <TouchableOpacity 
                    style={{flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center'}}
                    onPress={() => toggleProposalExpansion(item.id)}
                >
                    <Text style={{fontSize: 16, fontWeight: 'bold', color: currentColors.text}}>
                        {new Date(item.proposed_date).toLocaleDateString('ko-KR', { 
                            month: 'long', 
                            day: 'numeric' 
                        })}
                    </Text>
                    <View style={{flexDirection: 'row', alignItems: 'center'}}>
                        <View style={{
                            backgroundColor: item.status === 'confirmed' ? currentColors.success : 
                                          item.status === 'cancelled' ? currentColors.error : 
                                          item.status === 'expired' ? currentColors.warning : currentColors.primaryLight,
                            borderRadius: 20,
                            paddingVertical: 6,
                            paddingHorizontal: 12,
                            marginRight: 8
                        }}>
                            <Text style={{color: item.status === 'confirmed' ? '#FFFFFF' : 
                                         item.status === 'cancelled' ? '#FFFFFF' : 
                                         item.status === 'expired' ? '#FFFFFF' : currentColors.primary, 
                                         fontWeight: 'bold', fontSize: 12}}>
                                {item.status === 'pending' ? 'ëŒ€ê¸°ì¤‘' : 
                                 item.status === 'confirmed' ? 'í™•ì •' : 
                                 item.status === 'cancelled' ? 'ì·¨ì†Œ' : 'ë§Œë£Œ'}
                            </Text>
                        </View>
                        <Ionicons 
                            name={isExpanded ? "chevron-up" : "chevron-down"} 
                            size={20} 
                            color={currentColors.textSecondary} 
                        />
                    </View>
                </TouchableOpacity>
                
                {isExpanded && (
                    <View style={{marginTop: 16, paddingTop: 16, borderTopWidth: 1, borderTopColor: currentColors.lightGray}}>
                        {type === 'sent' && (
                            <View style={{marginBottom: 12}}>
                                <Text style={{fontSize: 14, fontWeight: 'bold', color: currentColors.text, marginBottom: 8}}>ì œì•ˆí•œ ê·¸ë£¹:</Text>
                                {(groupMembers && groupMembers.length > 0) ? (
                                    groupMembers.map((member, index) => (
                                        <View key={index} style={{marginBottom: 8}}>
                                            <Text style={{fontSize: 14, color: currentColors.text, fontWeight: '600'}}>{member.nickname || member.employee_id}</Text>
                                            <Text style={{fontSize: 12, color: currentColors.textSecondary, marginLeft: 16}}>
                                                ğŸ½ï¸ {member.lunch_preference || '-'}
                                                {member.dining_history && `  |  ${member.dining_history}`}
                                            </Text>
                                            {member.main_dish_genre && (
                                                <Text style={{fontSize: 12, color: currentColors.textSecondary, marginLeft: 16}}>ğŸœ {member.main_dish_genre}</Text>
                                            )}
                                        </View>
                                    ))
                                ) : (
                                    <View style={{marginBottom: 8}}>
                                        <Text style={{fontSize: 12, color: currentColors.textSecondary}}>
                                            {item.recipient_ids ? 'ì°¸ì—¬ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...' : 'ì°¸ì—¬ì ì •ë³´ ì—†ìŒ'}
                                        </Text>
                                        {item.recipient_ids && (
                                            <Text style={{fontSize: 10, color: currentColors.textSecondary, marginTop: 4}}>
                                                ID: {item.recipient_ids}
                                            </Text>
                                        )}
                                    </View>
                                )}
                            </View>
                        )}
                        
                        {item.accepted_nicknames && item.accepted_nicknames.length > 0 && (
                            <Text style={{fontSize: 14, color: currentColors.success, fontWeight: '600', marginBottom: 8}}>
                                ìˆ˜ë½í•œ ì‚¬ëŒ: {item.accepted_nicknames.join(', ')}
                            </Text>
                        )}
                
                        {isReceived && isPending && (
                            <View style={{flexDirection: 'row', justifyContent: 'space-between', marginTop: 12}}>
                                <TouchableOpacity 
                                    style={{
                                        backgroundColor: currentColors.primary,
                                        borderRadius: 12,
                                        paddingVertical: 10,
                                        paddingHorizontal: 20,
                                        flex: 1,
                                        marginRight: 8,
                                        alignItems: 'center'
                                    }}
                                    onPress={() => handleAcceptProposal(item.id)}
                                >
                                    <Text style={{color: '#FFFFFF', fontWeight: 'bold', fontSize: 14}}>
                                        ìˆ˜ë½
                                    </Text>
                                </TouchableOpacity>
                                <TouchableOpacity 
                                    style={{
                                        backgroundColor: currentColors.error,
                                        borderRadius: 12,
                                        paddingVertical: 10,
                                        paddingHorizontal: 20,
                                        flex: 1,
                                        marginLeft: 8,
                                        alignItems: 'center'
                                    }}
                                       onPress={() => {
        Alert.alert('ê±°ì ˆ', 'ì´ ì œì•ˆì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', [
            { text: 'ì·¨ì†Œ', style: 'cancel' },
            { text: 'í™•ì¸', style: 'destructive', onPress: () => handleRejectProposal(item.id) }
        ]);
    }}
>
    <Text style={{color: '#FFFFFF', fontWeight: 'bold', fontSize: 14}}>
        ê±°ì ˆ
    </Text>
</TouchableOpacity>
                             </View>
                         )}
                         
                        {type === 'sent' && isPending && (
                            <TouchableOpacity 
                                style={{
                                    backgroundColor: currentColors.gray,
                                    borderRadius: 12,
                                    paddingVertical: 10,
                                    paddingHorizontal: 20,
                                    marginTop: 12,
                                    alignItems: 'center'
                                }}
                                onPress={() => {
                                    Alert.alert('ì œì•ˆ ì·¨ì†Œ', 'ì´ ì œì•ˆì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', [
                                        { text: 'ì·¨ì†Œ', style: 'cancel' },
                                        { text: 'í™•ì¸', style: 'destructive', onPress: () => handleCancelProposal(item.id) }
                                    ]);
                                }}
                            >
                                <Text style={{color: '#FFFFFF', fontWeight: 'bold', fontSize: 14}}>
                                    ì œì•ˆ ì·¨ì†Œ
                                </Text>
                            </TouchableOpacity>
                        )}
                    </View>
                )}
            </View>
        );
    };

    if (loading) {
        return (
            <SafeAreaView style={styles.safeArea}>
                <View style={{flex: 1, justifyContent: 'center', alignItems: 'center'}}>
                    <ActivityIndicator size="large" color={currentColors.primary} />
                    <Text style={{fontSize: 16, color: currentColors.textSecondary, marginTop: 16}}>ì œì•ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</Text>
                </View>
            </SafeAreaView>
        );
    }

    return (
        <SafeAreaView style={styles.safeArea}>
            <ScrollView style={{flex: 1, backgroundColor: currentColors.background}}>
                {/* ë§¤ì¹­ ì„±ê³µí•œ ì ì‹¬ ëª¨ì„ */}
                {confirmedGroups.length > 0 && (
                    <View style={{marginBottom: 24}}>
                        <Text style={{fontSize: 20, fontWeight: 'bold', marginBottom: 12, color: currentColors.primary, paddingHorizontal: 16, marginTop: 16}}>ë§¤ì¹­ ì„±ê³µ</Text>
                        <FlatList
                            data={confirmedGroups}
                            renderItem={renderConfirmedGroupItem}
                            keyExtractor={item => `confirmed-${item.id}`}
                            horizontal
                            showsHorizontalScrollIndicator={false}
                            contentContainerStyle={{ paddingHorizontal: 16, paddingVertical: 5 }}
                        />
                    </View>
                )}
                
                <View style={{marginBottom: 24}}>
                    <Text style={{fontSize: 20, fontWeight: 'bold', marginBottom: 12, color: currentColors.primary, paddingHorizontal: 16, marginTop: 16}}>ë³´ë‚¸ ì œì•ˆ</Text>
                    {proposals.sent_proposals.length > 0 ? (
                        proposals.sent_proposals.map(item => (
                            <View key={item.id}>
                                {renderProposalItem({ item, type: 'sent' })}
                            </View>
                        ))
                    ) : (
                        <Text style={{fontSize: 16, color: currentColors.textSecondary, textAlign: 'center', marginTop: 50, paddingHorizontal: 16}}>ë³´ë‚¸ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</Text>
                    )}
                </View>
                
                <View style={{marginBottom: 24}}>
                    <Text style={{fontSize: 20, fontWeight: 'bold', marginBottom: 12, color: currentColors.primary, paddingHorizontal: 16, marginTop: 16}}>ë°›ì€ ì œì•ˆ</Text>
                    {proposals.received_proposals.length > 0 ? (
                        proposals.received_proposals.map(item => (
                            <View key={item.id}>
                                {renderProposalItem({ item, type: 'received' })}
                            </View>
                        ))
                    ) : (
                        <Text style={{fontSize: 16, color: currentColors.textSecondary, textAlign: 'center', marginTop: 50, paddingHorizontal: 16}}>ë°›ì€ ì œì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</Text>
                    )}
                </View>
            </ScrollView>
        </SafeAreaView>
    );
}

function RestaurantsScreen({ navigation }) {
    const [restaurants, setRestaurants] = useState([]);
    const [recommendations, setRecommendations] = useState({ personal: [], friend: [] });
    const [isLoading, setIsLoading] = useState(true);
    const [searchQuery, setSearchQuery] = useState('');
    const [activeTab, setActiveTab] = useState('all'); // 'all', 'personal', 'friend'
    const [sortBy, setSortBy] = useState('name');
    const [categoryFilter, setCategoryFilter] = useState(null);
    const [isCategoryModalVisible, setCategoryModalVisible] = useState(false);
    const CATEGORY_OPTIONS = ['í•œì‹', 'ì¤‘ì‹', 'ì¼ì‹', 'ì–‘ì‹', 'ë¶„ì‹', 'ì•„ì‹œì•ˆ', 'í“¨ì „', 'ê¸°íƒ€'];
    
    useFocusEffect(useCallback(() => {
        setIsLoading(true);
        let url = `${RENDER_SERVER_URL}/restaurants?query=${searchQuery}&sort_by=${sortBy}`;
        if (categoryFilter) url += `&category=${categoryFilter}`;
        fetch(url).then(res => res.json()).then(data => { if(Array.isArray(data)) setRestaurants(data); }).catch(err => console.error(err)).finally(() => setIsLoading(false));
        
        // ì¶”ì²œ ì‹ë‹¹ë„ í•¨ê»˜ ê°€ì ¸ì˜¤ê¸°
        fetchRecommendations();
    }, [searchQuery, sortBy, categoryFilter]));

    const fetchRecommendations = async () => {
        try {
            const response = await fetch(`${RENDER_SERVER_URL}/restaurants/recommend?employee_id=${CURRENT_USER_ID}`);
            if (response.ok) {
                const data = await response.json();
                setRecommendations({
                    personal: data.personal_recommendations || [],
                    friend: data.friend_recommendations || []
                });
            }
        } catch (error) {
            console.error('ì¶”ì²œ ì‹ë‹¹ ì¡°íšŒ ì‹¤íŒ¨:', error);
        }
    };

    return (
        <SafeAreaView style={styles.safeArea}>
            {/* ê²€ìƒ‰ ë° í•„í„° */}
            <View style={{paddingHorizontal: 16, paddingVertical: 12, backgroundColor: currentColors.background}}>
                <TextInput 
                    style={{
                        backgroundColor: currentColors.surface,
                        borderRadius: 16,
                        padding: 14,
                        fontSize: 16,
                        marginBottom: 12,
                        borderWidth: 1,
                        borderColor: currentColors.lightGray
                    }} 
                    placeholder="ë§›ì§‘ ì´ë¦„ ê²€ìƒ‰..." 
                    placeholderTextColor={currentColors.gray} 
                    value={searchQuery} 
                    onChangeText={setSearchQuery} 
                />
                <ScrollView horizontal showsHorizontalScrollIndicator={false}>
                    <TouchableOpacity
                        style={{
                            backgroundColor: sortBy === 'name' ? currentColors.primary : currentColors.surface,
                            borderRadius: 20,
                            paddingVertical: 8,
                            paddingHorizontal: 16,
                            marginRight: 8,
                            elevation: sortBy === 'name' ? 2 : 1,
                            shadowColor: currentColors.primary,
                            shadowOffset: { width: 0, height: 2 },
                            shadowOpacity: sortBy === 'name' ? 0.2 : 0.1,
                            shadowRadius: 4,
                            borderWidth: 1,
                            borderColor: sortBy === 'name' ? currentColors.primary : currentColors.lightGray
                        }}
                        onPress={() => setSortBy('name')}
                    >
                        <Text style={{
                            color: sortBy === 'name' ? '#FFFFFF' : currentColors.text,
                            fontWeight: sortBy === 'name' ? 'bold' : '600',
                            fontSize: 14
                        }}>
                            ì´ë¦„ìˆœ
                        </Text>
                    </TouchableOpacity>
                    <TouchableOpacity
                        style={{
                            backgroundColor: sortBy === 'rating_desc' ? currentColors.primary : currentColors.surface,
                            borderRadius: 20,
                            paddingVertical: 8,
                            paddingHorizontal: 16,
                            marginRight: 8,
                            elevation: sortBy === 'rating_desc' ? 2 : 1,
                            shadowColor: currentColors.primary,
                            shadowOffset: { width: 0, height: 2 },
                            shadowOpacity: sortBy === 'rating_desc' ? 0.2 : 0.1,
                            shadowRadius: 4,
                            borderWidth: 1,
                            borderColor: sortBy === 'rating_desc' ? currentColors.primary : currentColors.lightGray
                        }}
                        onPress={() => setSortBy('rating_desc')}
                    >
                        <Text style={{
                            color: sortBy === 'rating_desc' ? '#FFFFFF' : currentColors.text,
                            fontWeight: sortBy === 'rating_desc' ? 'bold' : '600',
                            fontSize: 14
                        }}>
                            â­ë³„ì ìˆœ
                        </Text>
                    </TouchableOpacity>
                    <TouchableOpacity
                        style={{
                            backgroundColor: sortBy === 'reviews_desc' ? currentColors.primary : currentColors.surface,
                            borderRadius: 20,
                            paddingVertical: 8,
                            paddingHorizontal: 16,
                            marginRight: 8,
                            elevation: sortBy === 'reviews_desc' ? 2 : 1,
                            shadowColor: currentColors.primary,
                            shadowOffset: { width: 0, height: 2 },
                            shadowOpacity: sortBy === 'reviews_desc' ? 0.2 : 0.1,
                            shadowRadius: 4,
                            borderWidth: 1,
                            borderColor: sortBy === 'reviews_desc' ? currentColors.primary : currentColors.lightGray
                        }}
                        onPress={() => setSortBy('reviews_desc')}
                    >
                        <Text style={{
                            color: sortBy === 'reviews_desc' ? '#FFFFFF' : currentColors.text,
                            fontWeight: sortBy === 'reviews_desc' ? 'bold' : '600',
                            fontSize: 14
                        }}>
                            ğŸ’¬ë¦¬ë·°ìˆœ
                        </Text>
                    </TouchableOpacity>
                    <TouchableOpacity
                        style={{
                            backgroundColor: categoryFilter ? currentColors.primary : currentColors.surface,
                            borderRadius: 20,
                            paddingVertical: 8,
                            paddingHorizontal: 16,
                            marginRight: 8,
                            elevation: categoryFilter ? 2 : 1,
                            shadowColor: currentColors.primary,
                            shadowOffset: { width: 0, height: 2 },
                            shadowOpacity: categoryFilter ? 0.2 : 0.1,
                            shadowRadius: 4,
                            borderWidth: 1,
                            borderColor: categoryFilter ? currentColors.primary : currentColors.lightGray,
                            flexDirection: 'row',
                            alignItems: 'center'
                        }}
                        onPress={() => setCategoryModalVisible(true)}
                    >
                        <Ionicons name="filter" size={16} color={categoryFilter ? '#FFFFFF' : currentColors.gray} />
                        <Text style={{
                            color: categoryFilter ? '#FFFFFF' : currentColors.text,
                            fontWeight: categoryFilter ? 'bold' : '600',
                            fontSize: 14,
                            marginLeft: 4
                        }}>
                            {categoryFilter || 'ì¹´í…Œê³ ë¦¬'}
                        </Text>
                        {categoryFilter && (
                            <TouchableOpacity onPress={() => setCategoryFilter(null)} style={{marginLeft: 4}}>
                                <Ionicons name="close-circle" size={16} color="#FFFFFF" />
                            </TouchableOpacity>
                        )}
                    </TouchableOpacity>
                </ScrollView>
            </View>

            <SelectionModal visible={isCategoryModalVisible} title="ì¹´í…Œê³ ë¦¬ í•„í„°" options={CATEGORY_OPTIONS} selected={categoryFilter} onSelect={setCategoryFilter} onClose={() => setCategoryModalVisible(false)} styles={styles} colors={currentColors} />
            
            {/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
            <View style={{paddingHorizontal: 16, paddingVertical: 12, backgroundColor: currentColors.background}}>
                <ScrollView horizontal showsHorizontalScrollIndicator={false}>
                    <TouchableOpacity
                        style={{
                            backgroundColor: activeTab === 'all' ? currentColors.primary : currentColors.surface,
                            borderRadius: 20,
                            paddingVertical: 8,
                            paddingHorizontal: 16,
                            marginRight: 8,
                            elevation: activeTab === 'all' ? 2 : 1,
                            shadowColor: currentColors.primary,
                            shadowOffset: { width: 0, height: 2 },
                            shadowOpacity: activeTab === 'all' ? 0.2 : 0.1,
                            shadowRadius: 4,
                            borderWidth: 1,
                            borderColor: activeTab === 'all' ? currentColors.primary : currentColors.lightGray
                        }}
                        onPress={() => setActiveTab('all')}
                    >
                        <Text style={{
                            color: activeTab === 'all' ? '#FFFFFF' : currentColors.text,
                            fontWeight: activeTab === 'all' ? 'bold' : '600',
                            fontSize: 14
                        }}>
                            ì „ì²´
                        </Text>
                    </TouchableOpacity>
                    <TouchableOpacity
                        style={{
                            backgroundColor: activeTab === 'personal' ? currentColors.primary : currentColors.surface,
                            borderRadius: 20,
                            paddingVertical: 8,
                            paddingHorizontal: 16,
                            marginRight: 8,
                            elevation: activeTab === 'personal' ? 2 : 1,
                            shadowColor: currentColors.primary,
                            shadowOffset: { width: 0, height: 2 },
                            shadowOpacity: activeTab === 'personal' ? 0.2 : 0.1,
                            shadowRadius: 4,
                            borderWidth: 1,
                            borderColor: activeTab === 'personal' ? currentColors.primary : currentColors.lightGray
                        }}
                        onPress={() => setActiveTab('personal')}
                    >
                        <Text style={{
                            color: activeTab === 'personal' ? '#FFFFFF' : currentColors.text,
                            fontWeight: activeTab === 'personal' ? 'bold' : '600',
                            fontSize: 14
                        }}>
                            ê°œì¸ ì¶”ì²œ
                        </Text>
                    </TouchableOpacity>
                    <TouchableOpacity
                        style={{
                            backgroundColor: activeTab === 'friend' ? currentColors.primary : currentColors.surface,
                            borderRadius: 20,
                            paddingVertical: 8,
                            paddingHorizontal: 16,
                            marginRight: 8,
                            elevation: activeTab === 'friend' ? 2 : 1,
                            shadowColor: currentColors.primary,
                            shadowOffset: { width: 0, height: 2 },
                            shadowOpacity: activeTab === 'friend' ? 0.2 : 0.1,
                            shadowRadius: 4,
                            borderWidth: 1,
                            borderColor: activeTab === 'friend' ? currentColors.primary : currentColors.lightGray
                        }}
                        onPress={() => setActiveTab('friend')}
                    >
                        <Text style={{
                            color: activeTab === 'friend' ? '#FFFFFF' : currentColors.text,
                            fontWeight: activeTab === 'friend' ? 'bold' : '600',
                            fontSize: 14
                        }}>
                            ì¹œêµ¬ ì¶”ì²œ
                        </Text>
                    </TouchableOpacity>
                </ScrollView>
            </View>
            
            {isLoading ? (
                <ActivityIndicator size="large" style={{marginTop: 20}} color={currentColors.primary} />
            ) : (
                <FlatList 
                    data={
                        activeTab === 'all' ? restaurants :
                        activeTab === 'personal' ? recommendations.personal :
                        activeTab === 'friend' ? recommendations.friend : []
                    }
                    keyExtractor={item => item.id.toString()} 
                    renderItem={({ item }) => (
                        <TouchableOpacity 
                            style={{
                                backgroundColor: currentColors.surface,
                                borderRadius: 16,
                                marginHorizontal: 16,
                                marginBottom: 12,
                                padding: 16,
                                elevation: 2,
                                shadowColor: currentColors.primary,
                                shadowOffset: { width: 0, height: 2 },
                                shadowOpacity: 0.1,
                                shadowRadius: 4,
                                borderWidth: 1,
                                borderColor: 'rgba(99, 102, 241, 0.2)'
                            }}
                            onPress={() => navigation.navigate('RestaurantDetail', { restaurantId: item.id })}
                        >
                            <Text style={{fontSize: 18, fontWeight: 'bold', color: currentColors.text, marginBottom: 8}}>{item.name}</Text>
                            <View style={{
                                backgroundColor: currentColors.primaryLight,
                                borderRadius: 20,
                                paddingVertical: 6,
                                paddingHorizontal: 12,
                                alignSelf: 'flex-start',
                                marginBottom: 8
                            }}>
                                <Text style={{color: currentColors.primary, fontWeight: 'bold', fontSize: 12}}>{item.category}</Text>
                            </View>
                            <View style={{flexDirection: 'row', justifyContent: 'space-between', marginTop: 8, alignItems: 'center'}}>
                                <Text style={{fontSize: 14, color: currentColors.textSecondary}}>â­ {item.rating?.toFixed(1) || '0.0'}</Text>
                                <Text style={{fontSize: 14, color: currentColors.textSecondary}}>ğŸ’¬ {item.review_count || 0}ê°œ</Text>
                            </View>
                            {activeTab !== 'all' && (
                                <View style={{
                                    backgroundColor: activeTab === 'personal' ? currentColors.primaryLight : currentColors.secondary + '20',
                                    borderRadius: 12,
                                    paddingVertical: 4,
                                    paddingHorizontal: 8,
                                    alignSelf: 'flex-start',
                                    marginTop: 8
                                }}>
                                    <Text style={{
                                        color: activeTab === 'personal' ? currentColors.primary : currentColors.secondary,
                                        fontWeight: 'bold',
                                        fontSize: 12
                                    }}>
                                        {activeTab === 'personal' ? 'ê°œì¸ ì¶”ì²œ' : 'ì¹œêµ¬ ì¶”ì²œ'}
                                    </Text>
                                </View>
                            )}
                        </TouchableOpacity>
                    )} 
                    ListEmptyComponent={
                        <Text style={{fontSize: 16, color: currentColors.textSecondary, textAlign: 'center', marginTop: 50, paddingHorizontal: 16}}>
                            {activeTab === 'all' ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.' :
                             activeTab === 'personal' ? 'ê°œì¸ ì¶”ì²œ ì‹ë‹¹ì´ ì—†ìŠµë‹ˆë‹¤.' :
                             'ì¹œêµ¬ ì¶”ì²œ ì‹ë‹¹ì´ ì—†ìŠµë‹ˆë‹¤.'}
                        </Text>
                    } 
                    contentContainerStyle={{paddingTop: 16}} 
                />
            )}
            
            {/* í”Œë¡œíŒ… ì¶”ê°€ ë²„íŠ¼ */}
            <TouchableOpacity
                style={{
                    position: 'absolute',
                    right: 24,
                    bottom: 32,
                    width: 56,
                    height: 56,
                    borderRadius: 28,
                    backgroundColor: currentColors.primary,
                    justifyContent: 'center',
                    alignItems: 'center',
                    zIndex: 10,
                    elevation: 8,
                    shadowColor: currentColors.primary,
                    shadowOffset: { width: 0, height: 4 },
                    shadowOpacity: 0.3,
                    shadowRadius: 8
                }}
                activeOpacity={0.85}
                onPress={() => navigation.navigate('AddRestaurant')}
            >
                <Ionicons name="add" size={32} color="#fff" />
            </TouchableOpacity>
        </SafeAreaView>
    );
}

function AddRestaurantScreen({ navigation }) {
    const [name, setName] = useState('');
    const [category, setCategory] = useState('');
    const [address, setAddress] = useState('');
    const [isCategoryModalVisible, setCategoryModalVisible] = useState(false);
    const CATEGORY_OPTIONS = ['í•œì‹', 'ì¤‘ì‹', 'ì¼ì‹', 'ì–‘ì‹', 'ë¶„ì‹', 'ì•„ì‹œì•ˆ', 'í“¨ì „', 'ê¸°íƒ€'];

    const handleSubmit = async () => {
        if (!name.trim() || !category || !address.trim()) {
            Alert.alert('ì…ë ¥ ì˜¤ë¥˜', 'ë§›ì§‘ ì´ë¦„, ì¹´í…Œê³ ë¦¬, ì£¼ì†Œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            const response = await fetch(`${RENDER_SERVER_URL}/restaurants`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name.trim(),
                    category: category,
                    address: address.trim()
                })
            });
            const data = await response.json();
            if (response.ok) {
                Alert.alert('ì„±ê³µ', 'ìƒˆë¡œìš´ ë§›ì§‘ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                navigation.goBack();
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'ë§›ì§‘ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    };

    return (
        <SafeAreaView style={styles.safeArea}>
            <ScrollView contentContainerStyle={styles.formContainer}>
                <Text style={styles.inputLabel}>ë§›ì§‘ ì´ë¦„ *</Text>
                <TextInput style={styles.input} placeholder="ì˜ˆ: íŒêµì—­ ë§›ì§‘" value={name} onChangeText={setName} />
                
                <Text style={styles.inputLabel}>ì¹´í…Œê³ ë¦¬ *</Text>
                <TouchableOpacity style={styles.input} onPress={() => setCategoryModalVisible(true)}>
                    <Text style={category ? {color: currentColors.black} : {color: currentColors.gray}}>
                        {category || 'ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”'}
                    </Text>
                </TouchableOpacity>
                
                <Text style={styles.inputLabel}>ì£¼ì†Œ *</Text>
                <TextInput style={styles.input} placeholder="ì˜ˆ: ê²½ê¸°ë„ ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬ íŒêµì—­ë¡œ 146" value={address} onChangeText={setAddress} />
                
                <TouchableOpacity style={styles.submitButton} onPress={handleSubmit}>
                    <Text style={styles.submitButtonText}>ë§›ì§‘ ì¶”ê°€í•˜ê¸°</Text>
                </TouchableOpacity>
                
                <TouchableOpacity style={[styles.submitButton, { backgroundColor: currentColors.gray, marginTop: 10 }]} onPress={() => navigation.navigate('ë§›ì§‘')}>
                    <Text style={styles.submitButtonText}>ì·¨ì†Œí•˜ê¸°</Text>
                </TouchableOpacity>
            </ScrollView>
            
            <SelectionModal 
                visible={isCategoryModalVisible} 
                title="ì¹´í…Œê³ ë¦¬ ì„ íƒ" 
                options={CATEGORY_OPTIONS} 
                selected={category} 
                onSelect={setCategory} 
                onClose={() => setCategoryModalVisible(false)} 
                styles={styles} colors={currentColors} 
            />
        </SafeAreaView>
    );
}

function RestaurantDetailScreen({ route, navigation }) {
    const { restaurantId } = route.params;
    const [restaurant, setRestaurant] = useState(null);
    const [reviews, setReviews] = useState([]);
    const [myRating, setMyRating] = useState(0);
    const [myComment, setMyComment] = useState('');

    const fetchData = useCallback(() => { 
        fetch(`${RENDER_SERVER_URL}/restaurants/${restaurantId}`).then(res=>res.json()).then(setRestaurant).catch(console.error);
        fetch(`${RENDER_SERVER_URL}/restaurants/${restaurantId}/reviews`).then(res=>res.json()).then(setReviews).catch(console.error);
    }, [restaurantId]);

    useFocusEffect(fetchData);
    
    const handleReviewSubmit = async () => {
        if (myRating === 0 || !myComment) { Alert.alert("ì•Œë¦¼", "ë³„ì ê³¼ í•œì¤„í‰ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        try {
            const response = await fetch(`${RENDER_SERVER_URL}/restaurants/${restaurantId}/reviews`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: myEmployeeId, rating: myRating, comment: myComment }), });
            const data = await response.json();
            if (response.ok) { 
                Alert.alert("ì„±ê³µ", data.message); 
                setMyRating(0); 
                setMyComment(''); 
                fetchData(); 
            } else { Alert.alert("ì˜¤ë¥˜", data.message); }
        } catch (error) { Alert.alert("ì˜¤ë¥˜", "ë¦¬ë·° ë“±ë¡ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
    };

    const requestCorrection = () => { Alert.alert("ì •ë³´ ìˆ˜ì • ìš”ì²­", "ê°œë°œìì—ê²Œ ì •ë³´ ìˆ˜ì •ì„ ìš”ì²­í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤. (êµ¬í˜„ ì˜ˆì •)"); };

    if (!restaurant) return <ActivityIndicator style={{flex: 1}} size="large" color={currentColors.primary} />;
    
    return (
        <SafeAreaView style={styles.safeArea}>
            <FlatList
                ListHeaderComponent={
                    <>
                        <View style={styles.infoCard}>
                            <View style={{flexDirection: 'row', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                                <Text style={styles.infoCardTitle}>{restaurant.name}</Text>
                                <View style={styles.categoryChip}><Text style={styles.categoryChipText}>{restaurant.category}</Text></View>
                            </View>
                            <Text style={styles.infoCardAddress}>ğŸ“ {restaurant.address}</Text>
                            {restaurant.keywords && restaurant.keywords.length > 0 && <View style={styles.keywordContainer}>{restaurant.keywords.map(k => <View key={k} style={styles.keywordChip}><Text style={styles.keywordText}>{k}</Text></View>)}</View>}
                        </View>
                        <TouchableOpacity style={[styles.createPartyButton, {backgroundColor: currentColors.yellow}]} onPress={() => navigation.navigate('íŒŒí‹°', { screen: 'CreateParty', params: { prefilledRestaurant: restaurant.name } })}><Text style={[styles.createPartyButtonText, {color: currentColors.deepBlue}]}>ğŸ‰ ì´ ë§›ì§‘ìœ¼ë¡œ íŒŒí‹° ë§Œë“¤ê¸°</Text></TouchableOpacity>
                        <View style={styles.reviewInputContainer}>
                            <Text style={styles.cardTitle}>ë¦¬ë·° ë‚¨ê¸°ê¸°</Text>
                            <View style={styles.starContainer}>{[1, 2, 3, 4, 5].map(star => (<TouchableOpacity key={star} onPress={() => setMyRating(star)}><Ionicons name={myRating >= star ? "star" : "star-outline"} size={35} color={currentColors.yellow} /></TouchableOpacity>))}</View>
                            <TextInput style={styles.input} placeholder="í•œì¤„í‰ì„ ë‚¨ê²¨ì£¼ì„¸ìš”..." placeholderTextColor={currentColors.gray} value={myComment} onChangeText={setMyComment} />
                            <TouchableOpacity style={styles.submitButton} onPress={handleReviewSubmit}><Text style={styles.submitButtonText}>ë¦¬ë·° ë“±ë¡</Text></TouchableOpacity>
                        </View>
                        <Text style={[styles.cardTitle, {paddingHorizontal: 16, marginTop: 20, marginBottom: 10}]}>ë‹¤ë¥¸ ì‚¬ëŒë“¤ì˜ ë¦¬ë·°</Text>
                    </>
                }
                data={reviews}
                keyExtractor={item => item.id.toString()}
                renderItem={({ item }) => (
                    <View style={styles.reviewCard}>
                        <View style={styles.reviewHeader}>
                            <Text style={styles.reviewNickname}>{item.nickname}</Text>
                            <Text style={styles.reviewDate}>{item.created_at}</Text>
                        </View>
                        <View style={styles.starContainerStatic}>
                            {[...Array(item.rating)].map((_, i) => <Ionicons key={`star-${i}`} name="star" size={16} color={currentColors.yellow} />)}
                            {[...Array(5 - item.rating)].map((_, i) => <Ionicons key={`star-outline-${i}`} name="star-outline" size={16} color={currentColors.lightGray} />)}
                        </View>
                        <Text style={styles.reviewComment}>{item.comment}</Text>
                    </View>
                )}
                ListEmptyComponent={<Text style={styles.noDataMessage}>ì•„ì§ ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</Text>}
                ListFooterComponent={
                    <TouchableOpacity style={styles.correctionButton} onPress={requestCorrection}>
                        <Text style={styles.correctionButtonText}>ì‹ë‹¹ ì •ë³´ ìˆ˜ì • ìš”ì²­</Text>
                    </TouchableOpacity>
                }
                contentContainerStyle={{ paddingBottom: 50 }}
            />
        </SafeAreaView>
    );
}

// --- íŒŒí‹° íƒ­ ---
function PartyListScreen({ navigation }) {
    const [myParties, setMyParties] = useState([]);
    const [allParties, setAllParties] = useState([]);
    const [isLoading, setIsLoading] = useState(true);

    useFocusEffect(useCallback(() => {
        setIsLoading(true);
        Promise.all([
            fetch(`${RENDER_SERVER_URL}/my_regular_parties/${myEmployeeId}`).then(res => res.json()),
            fetch(`${RENDER_SERVER_URL}/parties`).then(res => res.json())
        ]).then(([myPartiesData, allPartiesData]) => {
            if(Array.isArray(myPartiesData)) setMyParties(myPartiesData);
            if(Array.isArray(allPartiesData)) setAllParties(allPartiesData);
        }).catch(console.error).finally(() => setIsLoading(false));
    }, []));

    const renderPartyItem = ({ item }) => (
        <TouchableOpacity style={{
            backgroundColor: currentColors.surface,
            borderRadius: 20,
            padding: 20,
            marginHorizontal: 16,
            marginBottom: 16,
            elevation: 3,
            shadowColor: currentColors.primary,
            shadowOffset: { width: 0, height: 4 },
            shadowOpacity: 0.1,
            shadowRadius: 8,
            borderWidth: 1,
            borderColor: 'rgba(59, 130, 246, 0.1)'
        }} onPress={() => navigation.navigate('PartyDetail', { partyId: item.id })}>
            <Text style={{fontSize: 18, fontWeight: 'bold', color: currentColors.text, marginBottom: 8}}>{item.title}</Text>
            <Text style={{fontSize: 14, color: currentColors.textSecondary, marginBottom: 4}}>ğŸ—“ï¸ {item.party_date} {item.party_time}</Text>
            <Text style={{fontSize: 14, color: currentColors.textSecondary}}>ğŸ‘¥ {item.current_members} / {item.max_members}ëª… @ {item.restaurant_name}</Text>
        </TouchableOpacity>
    );

    const renderMyPartyItem = ({ item }) => (
        <TouchableOpacity style={{
            backgroundColor: currentColors.surface,
            borderRadius: 16,
            padding: 16,
            marginHorizontal: 6,
            width: SCREEN_WIDTH * 0.5,
            height: 160,
            borderWidth: 2,
            borderColor: currentColors.lightGray,
            justifyContent: 'flex-start',
            elevation: 2,
            shadowColor: currentColors.primary,
            shadowOffset: { width: 0, height: 2 },
            shadowOpacity: 0.1,
            shadowRadius: 4
        }} onPress={() => navigation.navigate('PartyDetail', { partyId: item.id })}>
            <Text style={{fontSize: 16, fontWeight: 'bold', color: currentColors.text, marginBottom: 8, numberOfLines: 1}}>{item.title}</Text>
            <Text style={{fontSize: 13, color: currentColors.textSecondary, marginBottom: 8}}>ğŸ—“ï¸ {item.party_date} {item.party_time}</Text>
            <View style={{flexDirection: 'row', justifyContent: 'space-between', marginTop: 8, alignItems: 'center'}}>
                <Text style={{fontSize: 12, color: currentColors.textSecondary}}>ğŸ‘¥ {item.current_members}/{item.max_members}ëª…</Text>
                <Text style={{fontSize: 12, color: currentColors.textSecondary, numberOfLines: 1}}>ğŸ“ {item.restaurant_name}</Text>
            </View>
        </TouchableOpacity>
    );

    if (isLoading) return <ActivityIndicator style={{flex: 1}} size="large" color={currentColors.primary} />;

    return (
        <ScrollView style={styles.safeArea}>
            <Text style={{fontSize: 20, fontWeight: 'bold', marginBottom: 12, color: currentColors.primary, paddingHorizontal: 16, marginTop: 16}}>ë‚´ ì¼ë°˜íŒŒí‹°</Text>
            {myParties.length > 0 ? (
                <FlatList 
                    data={myParties} 
                    renderItem={renderMyPartyItem} 
                    keyExtractor={item => `my-${item.id}`} 
                    horizontal 
                    showsHorizontalScrollIndicator={false}
                    contentContainerStyle={{ paddingHorizontal: 16, paddingVertical: 5 }}
                />
            ) : <Text style={{fontSize: 16, color: currentColors.textSecondary, textAlign: 'center', marginTop: 50, paddingHorizontal: 16}}>ì°¸ì—¬í•œ ì¼ë°˜íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤.</Text>}
            
            <Text style={{fontSize: 20, fontWeight: 'bold', marginBottom: 12, color: currentColors.primary, paddingHorizontal: 16, marginTop: 16}}>ì „ì²´ íŒŒí‹°</Text>
            <FlatList data={allParties} renderItem={renderPartyItem} keyExtractor={item => `all-${item.id}`} scrollEnabled={false} />
        </ScrollView>
    );
}

function DangolPotContainerScreen({ navigation }) {
    const [myPots, setMyPots] = useState([]);
    const [allPots, setAllPots] = useState([]);
    const [isLoading, setIsLoading] = useState(true);

    useFocusEffect(useCallback(() => {
        setIsLoading(true);
        Promise.all([
            fetch(`${RENDER_SERVER_URL}/my_dangolpots/${myEmployeeId}`).then(res => res.json()),
            fetch(`${RENDER_SERVER_URL}/dangolpots`).then(res => res.json())
        ]).then(([myPotsData, allPotsData]) => {
            if(Array.isArray(myPotsData)) setMyPots(myPotsData);
            if(Array.isArray(allPotsData)) setAllPots(allPotsData);
        }).catch(console.error).finally(() => setIsLoading(false));
    }, []));

    const renderPotItem = ({ item }) => (
        <TouchableOpacity style={{
            backgroundColor: currentColors.surface,
            borderRadius: 16,
            marginHorizontal: 16,
            marginBottom: 12,
            padding: 16,
            elevation: 2,
            shadowColor: currentColors.primary,
            shadowOffset: { width: 0, height: 2 },
            shadowOpacity: 0.1,
            shadowRadius: 4,
            borderWidth: 1,
            borderColor: 'rgba(99, 102, 241, 0.2)'
        }} onPress={() => navigation.navigate('DangolPotDetail', { potId: item.id })}>
            <View style={{flexDirection: 'row', justifyContent: 'space-between', marginBottom: 8}}>
                <Text style={{fontSize: 18, fontWeight: 'bold', color: currentColors.text}}>{item.name}</Text>
                <View style={{
                    backgroundColor: currentColors.primaryLight,
                    borderRadius: 20,
                    paddingVertical: 6,
                    paddingHorizontal: 12,
                    alignSelf: 'flex-start'
                }}>
                    <Text style={{color: currentColors.primary, fontWeight: 'bold', fontSize: 12}}>{item.category}</Text>
                </View>
            </View>
            <Text style={{fontSize: 14, color: currentColors.textSecondary, marginBottom: 4, numberOfLines: 1}}>{item.description}</Text>
            <Text style={{fontSize: 14, color: currentColors.textSecondary, marginBottom: 8}}>{item.tags}</Text>
            <View style={{flexDirection: 'row', justifyContent: 'space-between', marginTop: 10, alignItems: 'center'}}>
                <Text style={{fontSize: 14, color: currentColors.textSecondary}}>ğŸ‘¥ {item.member_count}ëª…</Text>
                <Text style={{fontSize: 14, color: currentColors.textSecondary}}>ê°œì„¤ì¼: {item.created_at}</Text>
            </View>
        </TouchableOpacity>
    );

    const renderMyPotItem = ({ item }) => (
        <TouchableOpacity style={{
            backgroundColor: currentColors.surface,
            borderRadius: 16,
            padding: 16,
            marginHorizontal: 6,
            width: SCREEN_WIDTH * 0.5,
            height: 160,
            borderWidth: 2,
            borderColor: currentColors.lightGray,
            justifyContent: 'flex-start',
            elevation: 2,
            shadowColor: currentColors.primary,
            shadowOffset: { width: 0, height: 2 },
            shadowOpacity: 0.1,
            shadowRadius: 4
        }} onPress={() => navigation.navigate('DangolPotDetail', { potId: item.id })}>
            <Text style={{fontSize: 16, fontWeight: 'bold', color: currentColors.text, marginBottom: 8, numberOfLines: 1}}>{item.name}</Text>
            <View style={{marginBottom: 8}}>
                <View style={{
                    backgroundColor: currentColors.primaryLight,
                    borderRadius: 20,
                    paddingVertical: 6,
                    paddingHorizontal: 12,
                    alignSelf: 'flex-start'
                }}>
                    <Text style={{color: currentColors.primary, fontWeight: 'bold', fontSize: 12}}>{item.category}</Text>
                </View>
            </View>
            <Text style={{fontSize: 13, color: currentColors.textSecondary, marginBottom: 8, numberOfLines: 2}}>{item.description}</Text>
            <View style={{flexDirection: 'row', justifyContent: 'space-between', marginTop: 8, alignItems: 'center'}}>
                <Text style={{fontSize: 12, color: currentColors.textSecondary}}>ğŸ‘¥ {item.member_count}ëª…</Text>
                <Text style={{fontSize: 12, color: currentColors.textSecondary}}>{item.created_at}</Text>
            </View>
        </TouchableOpacity>
    );

    if (isLoading) return <ActivityIndicator style={{flex: 1}} size="large" color={currentColors.primary} />;

    return (
        <ScrollView style={styles.safeArea}>
            <Text style={{fontSize: 20, fontWeight: 'bold', marginBottom: 12, color: currentColors.primary, paddingHorizontal: 16, marginTop: 16}}>ë‚´ ë‹¨ê³¨íŒŒí‹°</Text>
            {myPots.length > 0 ? (
                <FlatList 
                    data={myPots} 
                    renderItem={renderMyPotItem} 
                    keyExtractor={item => `my-${item.id}`} 
                    horizontal 
                    showsHorizontalScrollIndicator={false}
                    contentContainerStyle={{ paddingHorizontal: 16, paddingVertical: 5 }}
                />
            ) : <Text style={{fontSize: 16, color: currentColors.textSecondary, textAlign: 'center', marginTop: 50, paddingHorizontal: 16}}>ê°€ì…í•œ ë‹¨ê³¨íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤.</Text>}
            
            <Text style={{fontSize: 20, fontWeight: 'bold', marginBottom: 12, color: currentColors.primary, paddingHorizontal: 16, marginTop: 16}}>ì „ì²´ ë‹¨ê³¨íŒŒí‹°</Text>
            <FlatList data={allPots} renderItem={renderPotItem} keyExtractor={item => `all-${item.id}`} scrollEnabled={false} />
        </ScrollView>
    );
}

function PartiesContainerScreen({ navigation }) {
    const [tabIndex, setTabIndex] = useState(0);
    const currentTabIndexRef = useRef(0);
    
    // í˜„ì¬ íƒ­ ì¸ë±ìŠ¤ë¥¼ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
    const currentTabIndex = useNavigationState(state => {
        const routes = state?.routes;
        if (routes && routes.length > 0) {
            const currentRoute = routes[routes.length - 1];
            if (currentRoute.state && currentRoute.state.index !== undefined) {
                return currentRoute.state.index;
            }
        }
        return 0;
    });
    
    // currentTabIndexRef ì—…ë°ì´íŠ¸
    useEffect(() => {
        currentTabIndexRef.current = currentTabIndex;
    }, [currentTabIndex]);
    
    const handleAddPress = () => {
        const currentIndex = currentTabIndexRef.current;
        
        if (currentIndex === 0) {
            // ëœë¤ëŸ°ì¹˜ íƒ­ì—ì„œëŠ” í™ˆíƒ­ì˜ handleMatchPressì™€ ë™ì¼í•˜ê²Œ ë™ì‘
            navigation.navigate('RandomLunch');
        } else if (currentIndex === 1) {
            // ì¼ë°˜íŒŒí‹° íƒ­ì—ì„œëŠ” ìƒˆ íŒŒí‹° ë§Œë“¤ê¸° í™”ë©´ìœ¼ë¡œ ì´ë™
            navigation.navigate('CreateParty');
        } else if (currentIndex === 2) {
            // ë‹¨ê³¨íŒŒí‹° íƒ­ì—ì„œëŠ” ìƒˆ ë‹¨ê³¨íŒŒí‹° ë§Œë“¤ê¸° í™”ë©´ìœ¼ë¡œ ì´ë™
            navigation.navigate('CreateDangolPot');
        }
    };
    
    return (
        <SafeAreaView style={{flex: 1, backgroundColor: currentColors.background}}>
            <TopTab.Navigator
                initialRouteName="ëœë¤ëŸ°ì¹˜"
                screenOptions={{
                    tabBarActiveTintColor: currentColors.primary,
                    tabBarInactiveTintColor: currentColors.gray,
                    tabBarIndicatorStyle: { backgroundColor: currentColors.primary },
                    tabBarLabelStyle: { fontWeight: '600', fontSize: 16, marginTop: 2 },
                    tabBarIconStyle: { marginBottom: 4 }
                }}
                screenListeners={{
                    tabPress: (e) => {
                        const routeName = e.target.split('-')[0];
                        if (routeName === 'ëœë¤ëŸ°ì¹˜') {
                            setTabIndex(0);
                            currentTabIndexRef.current = 0;
                        } else if (routeName === 'ì¼ë°˜íŒŒí‹°') {
                            setTabIndex(1);
                            currentTabIndexRef.current = 1;
                        } else if (routeName === 'ë‹¨ê³¨íŒŒí‹°') {
                            setTabIndex(2);
                            currentTabIndexRef.current = 2;
                        }
                    },
                    focus: (e) => {
                        const routeName = e.target.split('-')[0];
                        if (routeName === 'ëœë¤ëŸ°ì¹˜') {
                            setTabIndex(0);
                            currentTabIndexRef.current = 0;
                        } else if (routeName === 'ì¼ë°˜íŒŒí‹°') {
                            setTabIndex(1);
                            currentTabIndexRef.current = 1;
                        } else if (routeName === 'ë‹¨ê³¨íŒŒí‹°') {
                            setTabIndex(2);
                            currentTabIndexRef.current = 2;
                        }
                    }
                }}
            >
                <TopTab.Screen name="ëœë¤ëŸ°ì¹˜" component={MyProposalsScreen} />
                <TopTab.Screen name="ì¼ë°˜íŒŒí‹°" component={PartyListScreen} />
                <TopTab.Screen name="ë‹¨ê³¨íŒŒí‹°" component={DangolPotContainerScreen} />
            </TopTab.Navigator>
            <TouchableOpacity
                style={{
                    position: 'absolute',
                    right: 24,
                    bottom: 32,
                    width: 56,
                    height: 56,
                    borderRadius: 28,
                    backgroundColor: currentColors.primary,
                    justifyContent: 'center',
                    alignItems: 'center',
                    zIndex: 10,
                    elevation: 8,
                    shadowColor: currentColors.primary,
                    shadowOffset: { width: 0, height: 4 },
                    shadowOpacity: 0.3,
                    shadowRadius: 8
                }}
                activeOpacity={0.85}
                onPress={handleAddPress}
            >
                <Ionicons name="add" size={32} color="#fff" />
            </TouchableOpacity>
        </SafeAreaView>
    );
}

function PartyDetailScreen({ route, navigation }) {
    const { partyId } = route.params;
    const [party, setParty] = useState(null);
    
    const fetchPartyDetails = useCallback(() => { 
        fetch(`${RENDER_SERVER_URL}/parties/${partyId}`).then(res => res.json()).then(setParty).catch(err => { console.error(err); setParty(null); });
    }, [partyId]);

    useFocusEffect(fetchPartyDetails);

    if (!party) return <View style={styles.centerView}><ActivityIndicator size="large" color={currentColors.primary}/></View>;

    const isMember = party.members.some(m => m.employee_id === myEmployeeId);
    const isHost = party.host_employee_id === myEmployeeId;

    const handleJoinParty = async () => {
        const response = await fetch(`${RENDER_SERVER_URL}/parties/${party.id}/join`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ employee_id: myEmployeeId }) });
        const data = await response.json();
        Alert.alert("ì•Œë¦¼", data.message);
        if(response.ok) fetchPartyDetails();
    };

    const handleLeaveParty = async () => {
        Alert.alert(
            'íŒŒí‹° ë‚˜ê°€ê¸°',
            'ì •ë§ë¡œ ì´ íŒŒí‹°ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?',
            [
                { text: 'ì·¨ì†Œ', style: 'cancel' },
                { text: 'ë‚˜ê°€ê¸°', style: 'destructive', onPress: async () => {
                    try {
                        const response = await fetch(`${RENDER_SERVER_URL}/parties/${party.id}/leave`, { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ employee_id: myEmployeeId }) 
                        });
                        const data = await response.json();
                        if (response.ok) {
                            Alert.alert('ì„±ê³µ', 'íŒŒí‹°ì—ì„œ ë‚˜ê°”ìŠµë‹ˆë‹¤.');
                            navigation.goBack();
                        } else {
                            Alert.alert('ì˜¤ë¥˜', data.message || 'íŒŒí‹° ë‚˜ê°€ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    } catch (e) {
                        Alert.alert('ì˜¤ë¥˜', 'íŒŒí‹° ë‚˜ê°€ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                }}
            ]
        );
    };

    const renderActionButtons = () => {
        if(isMember) {
            return (
                <View>
                    <TouchableOpacity style={styles.submitButton} onPress={() => navigation.navigate('ì†Œí†µ', { screen: 'ChatRoom', params: { chatId: party.id, chatType: 'party', chatTitle: party.title } })}>
                        <Text style={styles.submitButtonText}>ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™</Text>
                    </TouchableOpacity>
                    
                    {/* ë§¤ì¹­ ì„±ê³µí•œ ëœë¤ëŸ°ì¹˜ íŒŒí‹°ì—ì„œ ë‚˜ê°€ê¸° ë²„íŠ¼ */}
                    {party.is_from_match && (
                        <TouchableOpacity style={[styles.submitButton, {marginTop: 10, backgroundColor: currentColors.red}]} onPress={handleLeaveParty}>
                            <Text style={[styles.submitButtonText, {color: currentColors.white}]}>íŒŒí‹° ë‚˜ê°€ê¸°</Text>
                        </TouchableOpacity>
                    )}
                    
                    {isHost && !party.is_from_match && (
                        <>
                            <TouchableOpacity style={[styles.submitButton, {marginTop: 10, backgroundColor: currentColors.gray}]} onPress={() => navigation.navigate('EditParty', { partyData: party })}>
                                <Text style={[styles.submitButtonText, {color: currentColors.white}]}>íŒŒí‹° ì •ë³´ ìˆ˜ì •</Text>
                            </TouchableOpacity>
                            <TouchableOpacity style={[styles.submitButton, {marginTop: 10, backgroundColor: currentColors.red}]} onPress={handleDeleteParty}>
                                <Text style={[styles.submitButtonText, {color: currentColors.white}]}>íŒŒí‹° ì‚­ì œ</Text>
                            </TouchableOpacity>
                        </>
                    )}
                </View>
            );
        }
        if (party.current_members < party.max_members) {
            return (
                <TouchableOpacity style={styles.submitButton} onPress={handleJoinParty}>
                    <Text style={styles.submitButtonText}>íŒŒí‹° ì°¸ì—¬í•˜ê¸°</Text>
                </TouchableOpacity>
            );
        }
        return <Text style={styles.partyFullText}>íŒŒí‹° ì¸ì›ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.</Text>;
    };

    // íŒŒí‹° ì‚­ì œ í•¸ë“¤ëŸ¬ ì¶”ê°€
    const handleDeleteParty = async () => {
        Alert.alert(
            'íŒŒí‹° ì‚­ì œ',
            'ì •ë§ë¡œ ì´ íŒŒí‹°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
            [
                { text: 'ì·¨ì†Œ', style: 'cancel' },
                { text: 'ì‚­ì œ', style: 'destructive', onPress: async () => {
                    try {
                        const response = await fetch(`${RENDER_SERVER_URL}/parties/${party.id}?employee_id=${myEmployeeId}`, { method: 'DELETE' });
                        const data = await response.json();
                        if (response.ok) {
                            Alert.alert('ì„±ê³µ', 'íŒŒí‹°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            navigation.goBack();
                        } else {
                            Alert.alert('ì˜¤ë¥˜', data.message || 'íŒŒí‹° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    } catch (e) {
                        Alert.alert('ì˜¤ë¥˜', 'íŒŒí‹° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                }}
            ]
        );
    };

    return (
        <SafeAreaView style={styles.safeArea}>
            <ScrollView contentContainerStyle={styles.detailContainer}>
                <Text style={styles.title}>{party.is_from_match ? 'âš¡ï¸ ' : 'ğŸ‰ '}{party.title}</Text>
                <Text style={styles.detailInfo}>ğŸ“ {party.restaurant_name}</Text>
                <Text style={styles.detailInfo}>ğŸ—“ï¸ {party.party_date} {party.party_time}</Text>
                <Text style={styles.detailInfo}>ğŸ  {party.meeting_location}</Text>
                <Text style={styles.detailInfo}>ğŸ‘¥ {party.current_members} / {party.max_members}ëª…</Text>
                <View style={styles.memberList}>
                    <Text style={styles.cardTitle}>ì°¸ì—¬ì ëª©ë¡:</Text>
                    {party.members.map(m => (
                        <View key={m.employee_id} style={styles.memberItem}>
                            <Text style={styles.memberName}>
                                â€¢ {m.nickname} {m.employee_id === party.host_employee_id ? '(íŒŸì¥)' : ''}
                            </Text>
                            {m.lunch_preference && (
                                <Text style={styles.memberDetail}>ğŸ½ï¸ {m.lunch_preference}</Text>
                            )}
                            {m.main_dish_genre && (
                                <Text style={styles.memberDetail}>ğŸœ {m.main_dish_genre}</Text>
                            )}
                        </View>
                    ))}
                </View>
                <View style={{marginTop: 30}}>{renderActionButtons()}</View>
            </ScrollView>
        </SafeAreaView>
    );
}

function DangolPotDetailScreen({ route, navigation }) {
    const { potId } = route.params;
    const [pot, setPot] = useState(null);
    const [isMember, setIsMember] = useState(false);

    const fetchDetails = useCallback(() => {
        fetch(`${RENDER_SERVER_URL}/dangolpots/${potId}`).then(res => res.json()).then(data => {
            setPot(data);
            setIsMember(data.members.some(m => m.employee_id === myEmployeeId));
        }).catch(console.error);
    }, [potId]);

    useFocusEffect(fetchDetails);

    const handleJoin = async () => {
        const response = await fetch(`${RENDER_SERVER_URL}/dangolpots/${pot.id}/join`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ employee_id: myEmployeeId }) });
        if (response.ok) { Alert.alert("ì„±ê³µ", "ë‹¨ê³¨íŒŒí‹°ì— ê°€ì…í–ˆìŠµë‹ˆë‹¤!"); fetchDetails(); } 
        else { Alert.alert("ì˜¤ë¥˜", "ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); }
    };

    const handleDeletePot = async () => {
        Alert.alert(
            'ë‹¨ê³¨íŒŒí‹° ì‚­ì œ',
            'ì •ë§ë¡œ ì´ ë‹¨ê³¨íŒŒí‹°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
            [
                { text: 'ì·¨ì†Œ', style: 'cancel' },
                { text: 'ì‚­ì œ', style: 'destructive', onPress: async () => {
                    try {
                        const response = await fetch(`${RENDER_SERVER_URL}/dangolpots/${pot.id}?employee_id=${myEmployeeId}`, { method: 'DELETE' });
                        const data = await response.json();
                        if (response.ok) {
                            Alert.alert('ì„±ê³µ', 'ë‹¨ê³¨íŒŒí‹°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            navigation.goBack();
                        } else {
                            Alert.alert('ì˜¤ë¥˜', data.message || 'ë‹¨ê³¨íŒŒí‹° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    } catch (e) {
                        Alert.alert('ì˜¤ë¥˜', 'ë‹¨ê³¨íŒŒí‹° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                }}
            ]
        );
    };
    
    if (!pot) return <View style={styles.centerView}><ActivityIndicator size="large" color={currentColors.primary} /></View>;

    const isHost = pot.host_id === myEmployeeId;

    const renderActionButtons = () => {
        if (isMember) {
            return (
                <View>
                    <TouchableOpacity style={styles.submitButton} onPress={() => navigation.navigate('ì†Œí†µ', { screen: 'ChatRoom', params: { chatId: pot.id, chatType: 'dangolpot', chatTitle: pot.name } })}>
                        <Text style={styles.submitButtonText}>ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™</Text>
                    </TouchableOpacity>
                    {isHost && (
                        <>
                            <TouchableOpacity style={[styles.submitButton, {marginTop: 10, backgroundColor: currentColors.gray}]} onPress={() => navigation.navigate('EditDangolPot', { potData: pot })}>
                                <Text style={[styles.submitButtonText, {color: currentColors.white}]}>ë‹¨ê³¨íŒŒí‹° ì •ë³´ ìˆ˜ì •</Text>
                            </TouchableOpacity>
                            <TouchableOpacity style={[styles.submitButton, {marginTop: 10, backgroundColor: currentColors.red}]} onPress={handleDeletePot}>
                                <Text style={[styles.submitButtonText, {color: currentColors.white}]}>ë‹¨ê³¨íŒŒí‹° ì‚­ì œ</Text>
                            </TouchableOpacity>
                        </>
                    )}
                </View>
            );
        }
        return (
            <TouchableOpacity style={styles.submitButton} onPress={handleJoin}>
                <Text style={styles.submitButtonText}>ê°€ì…í•˜ê¸°</Text>
            </TouchableOpacity>
        );
    };

    return (
        <SafeAreaView style={styles.safeArea}>
            <ScrollView contentContainerStyle={styles.detailContainer}>
                <View style={{flexDirection: 'row', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                    <Text style={styles.title}>{pot.name}</Text>
                    <View style={styles.categoryChip}><Text style={styles.categoryChipText}>{pot.category}</Text></View>
                </View>
                <Text style={styles.detailInfo}>{pot.description}</Text>
                <Text style={styles.detailInfo}>#ï¸âƒ£ {pot.tags}</Text>
                <View style={styles.memberList}>
                    <Text style={styles.cardTitle}>ë©¤ë²„ ëª©ë¡ ({pot.members.length}ëª…)</Text>
                    {/* íŒŸì¥(í˜¸ìŠ¤íŠ¸)ë§Œ ë§¨ ìœ„ì— í•œ ë²ˆ í‘œì‹œ */}
                    {(() => {
                        const leader = pot.members.find(m => m.is_host);
                        if (!leader) return null;
                        return (
                            <View style={{
                                flexDirection: 'row',
                                alignItems: 'center',
                                paddingVertical: 8,
                                paddingHorizontal: 12,
                                backgroundColor: currentColors.background,
                                borderRadius: 8,
                                marginBottom: 8
                            }}>
                                <View style={{
                                    width: 40,
                                    height: 40,
                                    borderRadius: 20,
                                    backgroundColor: currentColors.yellow,
                                    justifyContent: 'center',
                                    alignItems: 'center',
                                    marginRight: 12
                                }}>
                                    <Text style={{
                                        color: currentColors.deepBlue,
                                        fontSize: 16,
                                        fontWeight: 'bold'
                                    }}>
                                        {leader.nickname ? leader.nickname.charAt(0) : '?'}
                                    </Text>
                                </View>
                                <View style={{ flex: 1 }}>
                                    <Text style={{
                                        fontSize: 16,
                                        fontWeight: '600',
                                        color: currentColors.text
                                    }}>
                                        {leader.nickname || 'ì•Œ ìˆ˜ ì—†ìŒ'}
                                    </Text>
                                </View>
                                <View style={{
                                    backgroundColor: currentColors.yellow,
                                    borderRadius: 12,
                                    paddingHorizontal: 8,
                                    paddingVertical: 4
                                }}>
                                    <Text style={{
                                        fontSize: 10,
                                        fontWeight: 'bold',
                                        color: currentColors.deepBlue
                                    }}>
                                        íŒŸì¥
                                    </Text>
                                </View>
                            </View>
                        );
                    })()}
                    {/* ì¼ë°˜ ë©¤ë²„ë§Œ ë¦¬ìŠ¤íŠ¸ë¡œ í‘œì‹œ (íŒŸì¥ employee_idì™€ ë‹¤ë¥¸ ë©¤ë²„ë§Œ) */}
                    <FlatList
                        data={pot.members.filter(m => {
                            const leader = pot.members.find(x => x.is_host);
                            return !leader || m.employee_id !== leader.employee_id;
                        })}
                        keyExtractor={(item, index) => `member-${item.employee_id}-${index}`}
                        renderItem={({ item }) => (
                            <View style={{
                                flexDirection: 'row',
                                alignItems: 'center',
                                paddingVertical: 8,
                                paddingHorizontal: 12,
                                backgroundColor: currentColors.background,
                                borderRadius: 8,
                                marginBottom: 8
                            }}>
                                <View style={{
                                    width: 40,
                                    height: 40,
                                    borderRadius: 20,
                                    backgroundColor: currentColors.primary,
                                    justifyContent: 'center',
                                    alignItems: 'center',
                                    marginRight: 12
                                }}>
                                    <Text style={{
                                        color: '#FFFFFF',
                                        fontSize: 16,
                                        fontWeight: 'bold'
                                    }}>
                                        {item.nickname ? item.nickname.charAt(0) : '?'}
                                    </Text>
                                </View>
                                <View style={{ flex: 1 }}>
                                    <Text style={{
                                        fontSize: 16,
                                        fontWeight: '600',
                                        color: currentColors.text
                                    }}>
                                        {item.nickname || 'ì•Œ ìˆ˜ ì—†ìŒ'}
                                    </Text>
                                </View>
                            </View>
                        )}
                        showsVerticalScrollIndicator={false}
                    />
                </View>
                <View style={{marginTop: 30}}>{renderActionButtons()}</View>
            </ScrollView>
        </SafeAreaView>
    );
}

function CreatePartyScreen({ navigation, route }) {
    const [title, setTitle] = useState('');
    const [restaurant, setRestaurant] = useState('');
    const [date, setDate] = useState('');
    const [time, setTime] = useState('');
    const [location, setLocation] = useState('');
    const [maxMembers, setMaxMembers] = useState(4);
    const [description, setDescription] = useState('');
    const [isDateModalVisible, setDateModalVisible] = useState(false);
    const [isTimeModalVisible, setTimeModalVisible] = useState(false);
    const [isMaxMembersModalVisible, setMaxMembersModalVisible] = useState(false);
    const [suggestedTitles, setSuggestedTitles] = useState([]);
    const [isLoadingSuggestions, setIsLoadingSuggestions] = useState(false);
    const [selectedDate, setSelectedDate] = useState(new Date());
    
    const prefilledRestaurant = route.params?.prefilledRestaurant;
    
    useEffect(() => {
        if (prefilledRestaurant) {
            setRestaurant(prefilledRestaurant);
        }
    }, [prefilledRestaurant]);

    // AI íŒŒí‹° ì œëª© ì œì•ˆ ê¸°ëŠ¥
    const generateTitleSuggestions = async () => {
        if (!restaurant.trim() && !date.trim()) {
            Alert.alert('ì•Œë¦¼', 'ì‹ë‹¹ëª…ì´ë‚˜ ë‚ ì§œë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            setIsLoadingSuggestions(true);
            const response = await fetch(`${RENDER_SERVER_URL}/ai/suggest-party-titles`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    restaurant: restaurant.trim(),
                    date: date.trim(),
                    time: time.trim(),
                    location: location.trim()
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('ì„œë²„ì—ì„œ JSON ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
            
            const data = await response.json();
            setSuggestedTitles(data.suggestions || []);
        } catch (error) {
            console.error('AI ì œëª© ì œì•ˆ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'AI ì œëª© ì œì•ˆ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        } finally {
            setIsLoadingSuggestions(false);
        }
    };

    const handleTitleSuggestion = (suggestion) => {
        setTitle(suggestion);
        setSuggestedTitles([]); // ì œì•ˆ ëª©ë¡ ë‹«ê¸°
    };

    const handleDateSelect = (selectedDate) => {
        // ë‚ ì§œë¥¼ YYYY.M.D.(ìš”ì¼) í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
        const year = selectedDate.getFullYear();
        const month = selectedDate.getMonth() + 1;
        const day = selectedDate.getDate();
        const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][selectedDate.getDay()];
        
        const dateText = `${year}.${month}.${day}.(${dayOfWeek})`;
        
        setDate(dateText);
        setSelectedDate(selectedDate);
        setDateModalVisible(false);
    };

    const handleCreate = async () => {
        if (!title.trim() || !restaurant.trim() || !date.trim() || !time.trim()) {
            Alert.alert('ì…ë ¥ ì˜¤ë¥˜', 'íŒŒí‹° ì œëª©, ì‹ë‹¹, ë‚ ì§œ, ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        // ë‚ ì§œ í…ìŠ¤íŠ¸ë¥¼ ì‹¤ì œ ë‚ ì§œë¡œ ë³€í™˜
        let actualDate = '';
        if (date && date.includes('.')) {
            // YYYY.M.D.(ìš”ì¼) í˜•ì‹ì—ì„œ ë‚ ì§œ ì¶”ì¶œ
            const match = date.match(/(\d+)\.(\d+)\.(\d+)\./);
            if (match) {
                const year = parseInt(match[1]);
                const month = parseInt(match[2]);
                const day = parseInt(match[3]);
                const dateObj = new Date(year, month - 1, day);
                actualDate = toLocalDateString(dateObj);
            } else {
                actualDate = toLocalDateString(selectedDate);
            }
        } else {
            actualDate = toLocalDateString(selectedDate);
        }

        try {
            const response = await fetch(`${RENDER_SERVER_URL}/parties`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: title.trim(),
                    restaurant_name: restaurant.trim(),
                    party_date: actualDate,
                    party_time: time.trim(),
                    meeting_location: location.trim(),
                    max_members: maxMembers,
                    description: description.trim(),
                    host_employee_id: myEmployeeId
                })
            });
            const data = await response.json();
            if (response.ok) {
                Alert.alert('ì„±ê³µ', 'ìƒˆë¡œìš´ íŒŒí‹°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                // í™ˆ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ë©´ì„œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                navigation.navigate('í™ˆ');
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'íŒŒí‹° ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    };

    return (
        <SafeAreaView style={styles.safeArea}>
            <ScrollView contentContainerStyle={styles.formContainer}>
                <Text style={styles.inputLabel}>íŒŒí‹° ì œëª© *</Text>
                <View style={styles.titleInputContainer}>
                    <TextInput 
                        style={[styles.input, { flex: 1 }]} 
                        placeholder="íŒŒí‹° ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" 
                        value={title} 
                        onChangeText={setTitle} 
                    />
                    <TouchableOpacity
                        style={styles.aiSuggestButton}
                        onPress={generateTitleSuggestions}
                        disabled={isLoadingSuggestions}
                    >
                        <Ionicons 
                            name="sparkles" 
                            size={20} 
                            color={isLoadingSuggestions ? currentColors.gray : currentColors.primary} 
                        />
                    </TouchableOpacity>
                </View>

                {/* AI ì œì•ˆ ì œëª© ëª©ë¡ */}
                {suggestedTitles.length > 0 && (
                    <View style={styles.suggestionsContainer}>
                        <Text style={styles.suggestionsTitle}>AI ì œì•ˆ ì œëª©</Text>
                        {suggestedTitles.map((suggestion, index) => (
                            <TouchableOpacity
                                key={index}
                                style={styles.suggestionItem}
                                onPress={() => handleTitleSuggestion(suggestion)}
                            >
                                <Text style={styles.suggestionText}>{suggestion}</Text>
                                <Ionicons name="arrow-forward" size={16} color={currentColors.primary} />
                            </TouchableOpacity>
                        ))}
                    </View>
                )}

                <Text style={styles.inputLabel}>ì‹ë‹¹ *</Text>
                <TextInput style={styles.input} placeholder="ì‹ë‹¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" value={restaurant} onChangeText={setRestaurant} />
                
                <Text style={styles.inputLabel}>ë‚ ì§œ *</Text>
                <TouchableOpacity style={styles.input} onPress={() => setDateModalVisible(true)}>
                    <Text style={date ? styles.inputText : styles.placeholderText}>
                        {date || 'ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”'}
                    </Text>
                </TouchableOpacity>
                
                <Text style={styles.inputLabel}>ì‹œê°„ *</Text>
                <TouchableOpacity style={styles.input} onPress={() => setTimeModalVisible(true)}>
                    <Text style={time ? styles.inputText : styles.placeholderText}>
                        {time || 'ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”'}
                    </Text>
                </TouchableOpacity>
                
                <Text style={styles.inputLabel}>ì¥ì†Œ (ì„ íƒ)</Text>
                <TextInput style={styles.input} placeholder="ì˜ˆ: íŒêµì—­ 2ë²ˆ ì¶œêµ¬" value={location} onChangeText={setLocation} />
                
                <Text style={styles.inputLabel}>ìµœëŒ€ ì¸ì› *</Text>
                <TouchableOpacity style={styles.input} onPress={() => setMaxMembersModalVisible(true)}>
                    <Text style={styles.inputText}>{maxMembers}ëª…</Text>
                </TouchableOpacity>
                
                <Text style={styles.inputLabel}>ì„¤ëª… (ì„ íƒ)</Text>
                <TextInput 
                    style={[styles.input, { height: 100, textAlignVertical: 'top' }]} 
                    placeholder="íŒŒí‹°ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" 
                    value={description} 
                    onChangeText={setDescription} 
                    multiline 
                />
                
                <TouchableOpacity style={styles.submitButton} onPress={handleCreate}>
                    <Text style={styles.submitButtonText}>íŒŒí‹° ë§Œë“¤ê¸°</Text>
                </TouchableOpacity>
                
                <TouchableOpacity style={[styles.submitButton, { backgroundColor: currentColors.gray, marginTop: 10 }]} onPress={() => navigation.goBack()}>
                    <Text style={styles.submitButtonText}>ì·¨ì†Œí•˜ê¸°</Text>
                </TouchableOpacity>
            </ScrollView>
            
            {/* ë‚ ì§œ ì„ íƒ ëª¨ë‹¬ - ì‘ì€ ìº˜ë¦°ë” */}
            <Modal
                visible={isDateModalVisible}
                transparent={true}
                animationType="fade"
                onRequestClose={() => setDateModalVisible(false)}
            >
                <View style={styles.centeredView}>
                    <View style={[styles.modalView, { width: 350, height: 450, maxWidth: '90%', maxHeight: '80%' }]}>
                        <View style={styles.modalHeader}>
                            <Text style={styles.modalTitle}>ë‚ ì§œ ì„ íƒ</Text>
                            <TouchableOpacity onPress={() => setDateModalVisible(false)}>
                                <Ionicons name="close" size={24} color={currentColors.gray} />
                            </TouchableOpacity>
                        </View>
                        <Calendar
                            current={selectedDate instanceof Date && !isNaN(selectedDate) ? selectedDate : new Date()}
  onDayPress={(day) => handleDateSelect(new Date(day.timestamp))}
  markedDates={{
    [toLocalDateString(selectedDate instanceof Date && !isNaN(selectedDate) ? selectedDate : new Date())]: {
      selected: true,
      selectedColor: currentColors.primary
    }
                            }}
                            theme={{
                                calendarBackground: currentColors.surface,
                                textSectionTitleColor: currentColors.text,
                                selectedDayBackgroundColor: currentColors.primary,
                                selectedDayTextColor: currentColors.surface,
                                todayTextColor: currentColors.primary,
                                dayTextColor: currentColors.text,
                                textDisabledColor: currentColors.gray,
                                dotColor: currentColors.primary,
                                selectedDotColor: currentColors.surface,
                                arrowColor: currentColors.primary,
                                monthTextColor: currentColors.text,
                                indicatorColor: currentColors.primary,
                                textDayFontWeight: '300',
                                textMonthFontWeight: 'bold',
                                textDayHeaderFontWeight: '300',
                                textDayFontSize: 16,
                                textMonthFontSize: 16,
                                textDayHeaderFontSize: 13
                            }}
                        />
                    </View>
                </View>
            </Modal>
            
            <SelectionModal 
                visible={isTimeModalVisible} 
                title="ì‹œê°„ ì„ íƒ" 
                options={['11:30', '12:00', '12:30', '13:00', '13:30', '14:00']} 
                selected={time} 
                onSelect={setTime} 
                onClose={() => setTimeModalVisible(false)} 
                styles={styles} colors={currentColors} 
            />
            <SelectionModal 
                visible={isMaxMembersModalVisible} 
                title="ìµœëŒ€ ì¸ì› ì„ íƒ" 
                options={['2ëª…', '3ëª…', '4ëª…', '5ëª…', '6ëª…', '7ëª…', '8ëª…']} 
                selected={`${maxMembers}ëª…`} 
                onSelect={(value) => setMaxMembers(parseInt(value))} 
                onClose={() => setMaxMembersModalVisible(false)} 
                styles={styles} colors={currentColors} 
            />
        </SafeAreaView>
    );
}

function EditPartyScreen({ route, navigation }) {
    const { partyData } = route.params;
    const [title, setTitle] = useState(partyData.title);
    const [restaurant, setRestaurant] = useState(partyData.restaurant_name);
    const [date, setDate] = useState('');
    const [time, setTime] = useState(partyData.party_time);
    const [location, setLocation] = useState(partyData.meeting_location);
    const [maxMembers, setMaxMembers] = useState(partyData.max_members);
    const [description, setDescription] = useState(partyData.description || '');
    const [isDateModalVisible, setDateModalVisible] = useState(false);
    const [isTimeModalVisible, setTimeModalVisible] = useState(false);
    const [isMaxMembersModalVisible, setMaxMembersModalVisible] = useState(false);
    const [selectedDate, setSelectedDate] = useState(new Date(partyData.party_date));
    const [suggestedTitles, setSuggestedTitles] = useState([]);
    const [isLoadingSuggestions, setIsLoadingSuggestions] = useState(false);

    // ì´ˆê¸° ë‚ ì§œ ì„¤ì •
    useEffect(() => {
        const dateObj = new Date(partyData.party_date);
        const year = dateObj.getFullYear();
        const month = dateObj.getMonth() + 1;
        const day = dateObj.getDate();
        const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][dateObj.getDay()];
        setDate(`${year}.${month}.${day}.(${dayOfWeek})`);
    }, [partyData.party_date]);

    // AI íŒŒí‹° ì œëª© ì œì•ˆ ê¸°ëŠ¥
    const generateTitleSuggestions = async () => {
        if (!restaurant.trim() && !date.trim()) {
            Alert.alert('ì•Œë¦¼', 'ì‹ë‹¹ëª…ì´ë‚˜ ë‚ ì§œë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            setIsLoadingSuggestions(true);
            const response = await fetch(`${RENDER_SERVER_URL}/ai/suggest-party-titles`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    restaurant: restaurant.trim(),
                    date: date.trim(),
                    time: time.trim(),
                    location: location.trim()
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('ì„œë²„ì—ì„œ JSON ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
            
            const data = await response.json();
            setSuggestedTitles(data.suggestions || []);
        } catch (error) {
            console.error('AI ì œëª© ì œì•ˆ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'AI ì œëª© ì œì•ˆ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        } finally {
            setIsLoadingSuggestions(false);
        }
    };

    const handleTitleSuggestion = (suggestion) => {
        setTitle(suggestion);
        setSuggestedTitles([]); // ì œì•ˆ ëª©ë¡ ë‹«ê¸°
    };

    const handleDateSelect = (selectedDate) => {
        // ë‚ ì§œë¥¼ YYYY.M.D.(ìš”ì¼) í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
        const year = selectedDate.getFullYear();
        const month = selectedDate.getMonth() + 1;
        const day = selectedDate.getDate();
        const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][selectedDate.getDay()];
        
        const dateText = `${year}.${month}.${day}.(${dayOfWeek})`;
        
        setDate(dateText);
        setSelectedDate(selectedDate);
        setDateModalVisible(false);
    };

    const handleUpdate = async () => {
        if (!title.trim() || !restaurant.trim() || !date.trim() || !time.trim()) {
            Alert.alert('ì…ë ¥ ì˜¤ë¥˜', 'íŒŒí‹° ì œëª©, ì‹ë‹¹, ë‚ ì§œ, ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        // ë‚ ì§œ í…ìŠ¤íŠ¸ë¥¼ ì‹¤ì œ ë‚ ì§œë¡œ ë³€í™˜
        let actualDate = '';
        if (date && date.includes('.')) {
            // YYYY.M.D.(ìš”ì¼) í˜•ì‹ì—ì„œ ë‚ ì§œ ì¶”ì¶œ
            const match = date.match(/(\d+)\.(\d+)\.(\d+)\./);
            if (match) {
                const year = parseInt(match[1]);
                const month = parseInt(match[2]);
                const day = parseInt(match[3]);
                const dateObj = new Date(year, month - 1, day);
                actualDate = toLocalDateString(dateObj);
            } else {
                actualDate = toLocalDateString(selectedDate);
            }
        } else {
            actualDate = toLocalDateString(selectedDate);
        }

        try {
            const response = await fetch(`${RENDER_SERVER_URL}/parties/${partyData.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    employee_id: myEmployeeId,
                    title: title.trim(),
                    restaurant_name: restaurant.trim(),
                    party_date: actualDate,
                    party_time: time.trim(),
                    meeting_location: location.trim(),
                    max_members: maxMembers,
                    description: description.trim()
                })
            });
            const data = await response.json();
            if (response.ok) {
                Alert.alert('ì„±ê³µ', 'íŒŒí‹° ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                navigation.goBack();
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'íŒŒí‹° ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    };

    return (
        <SafeAreaView style={styles.safeArea}>
            <ScrollView contentContainerStyle={styles.formContainer}>
                <Text style={styles.inputLabel}>íŒŒí‹° ì œëª© *</Text>
                <View style={styles.titleInputContainer}>
                    <TextInput 
                        style={[styles.input, { flex: 1 }]} 
                        placeholder="íŒŒí‹° ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" 
                        value={title} 
                        onChangeText={setTitle} 
                    />
                    <TouchableOpacity
                        style={styles.aiSuggestButton}
                        onPress={generateTitleSuggestions}
                        disabled={isLoadingSuggestions}
                    >
                        <Ionicons 
                            name="sparkles" 
                            size={20} 
                            color={isLoadingSuggestions ? currentColors.gray : currentColors.primary} 
                        />
                    </TouchableOpacity>
                </View>

                {/* AI ì œì•ˆ ì œëª© ëª©ë¡ */}
                {suggestedTitles.length > 0 && (
                    <View style={styles.suggestionsContainer}>
                        <Text style={styles.suggestionsTitle}>AI ì œì•ˆ ì œëª©</Text>
                        {suggestedTitles.map((suggestion, index) => (
                            <TouchableOpacity
                                key={index}
                                style={styles.suggestionItem}
                                onPress={() => handleTitleSuggestion(suggestion)}
                            >
                                <Text style={styles.suggestionText}>{suggestion}</Text>
                                <Ionicons name="arrow-forward" size={16} color={currentColors.primary} />
                            </TouchableOpacity>
                        ))}
                    </View>
                )}

                <Text style={styles.inputLabel}>ì‹ë‹¹ *</Text>
                <TextInput style={styles.input} placeholder="ì‹ë‹¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" value={restaurant} onChangeText={setRestaurant} />
                
                <Text style={styles.inputLabel}>ë‚ ì§œ *</Text>
                <TouchableOpacity style={styles.input} onPress={() => setDateModalVisible(true)}>
                    <Text style={date ? styles.inputText : styles.placeholderText}>
                        {date || 'ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”'}
                    </Text>
                </TouchableOpacity>
                
                <Text style={styles.inputLabel}>ì‹œê°„ *</Text>
                <TouchableOpacity style={styles.input} onPress={() => setTimeModalVisible(true)}>
                    <Text style={time ? styles.inputText : styles.placeholderText}>
                        {time || 'ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”'}
                    </Text>
                </TouchableOpacity>
                
                <Text style={styles.inputLabel}>ì¥ì†Œ (ì„ íƒ)</Text>
                <TextInput style={styles.input} placeholder="ì˜ˆ: íŒêµì—­ 2ë²ˆ ì¶œêµ¬" value={location} onChangeText={setLocation} />
                
                <Text style={styles.inputLabel}>ìµœëŒ€ ì¸ì› *</Text>
                <TouchableOpacity style={styles.input} onPress={() => setMaxMembersModalVisible(true)}>
                    <Text style={styles.inputText}>{maxMembers}ëª…</Text>
                </TouchableOpacity>
                
                <Text style={styles.inputLabel}>ì„¤ëª… (ì„ íƒ)</Text>
                <TextInput 
                    style={[styles.input, { height: 100, textAlignVertical: 'top' }]} 
                    placeholder="íŒŒí‹°ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" 
                    value={description} 
                    onChangeText={setDescription} 
                    multiline 
                />
                
                <TouchableOpacity style={styles.submitButton} onPress={handleUpdate}>
                    <Text style={[styles.submitButtonText, {color: currentColors.white}]}>ìˆ˜ì •í•˜ê¸°</Text>
                </TouchableOpacity>
                
                <TouchableOpacity style={[styles.submitButton, { backgroundColor: currentColors.gray, marginTop: 10 }]} onPress={() => navigation.goBack()}>
                    <Text style={[styles.submitButtonText, {color: currentColors.white}]}>ì·¨ì†Œí•˜ê¸°</Text>
                </TouchableOpacity>
            </ScrollView>

            {/* ë‚ ì§œ ì„ íƒ ëª¨ë‹¬ - ì‘ì€ ìº˜ë¦°ë” */}
            <Modal
                visible={isDateModalVisible}
                transparent={true}
                animationType="fade"
                onRequestClose={() => setDateModalVisible(false)}
            >
                    <View style={styles.centeredView}>
                        <View style={[styles.modalView, { width: 350, height: 450, maxWidth: '90%', maxHeight: '80%' }]}> 
                            <View style={styles.modalHeader}>
                                <Text style={styles.modalTitle}>ë‚ ì§œ ì„ íƒ</Text>
                                <TouchableOpacity onPress={() => setDateModalVisible(false)}>
                                    <Ionicons name="close" size={24} color={currentColors.gray} />
                                </TouchableOpacity>
                            </View>
                            <Calendar
                                current={selectedDate instanceof Date && !isNaN(selectedDate) ? selectedDate : new Date()}
  onDayPress={(day) => handleDateSelect(new Date(day.timestamp))}
  markedDates={{
    [toLocalDateString(selectedDate instanceof Date && !isNaN(selectedDate) ? selectedDate : new Date())]: {
      selected: true,
      selectedColor: currentColors.primary
    }
                            }}
                            theme={{
                                selectedDayBackgroundColor: currentColors.primary,
                                selectedDayTextColor: currentColors.white,
                                todayTextColor: currentColors.primary,
                                dayTextColor: currentColors.text,
                                textDisabledColor: currentColors.gray,
                                arrowColor: currentColors.primary,
                                monthTextColor: currentColors.text,
                                indicatorColor: currentColors.primary,
                                textDayFontWeight: '300',
                                textMonthFontWeight: 'bold',
                                textDayHeaderFontWeight: '300',
                                textDayFontSize: 16,
                                textMonthFontSize: 16,
                                textDayHeaderFontSize: 13
                            }}
                            />
                        </View>
                    </View>
                </Modal>

            {/* ì‹œê°„ ì„ íƒ ëª¨ë‹¬ */}
            <Modal
                visible={isTimeModalVisible}
                transparent={true}
                animationType="fade"
                onRequestClose={() => setTimeModalVisible(false)}
            >
                <View style={styles.centeredView}>
                    <View style={[styles.modalView, { width: 300, height: 400 }]}>
                        <View style={styles.modalHeader}>
                            <Text style={styles.modalTitle}>ì‹œê°„ ì„ íƒ</Text>
                            <TouchableOpacity onPress={() => setTimeModalVisible(false)}>
                                <Ionicons name="close" size={24} color={currentColors.gray} />
                            </TouchableOpacity>
                        </View>
                        <ScrollView style={styles.timeOptionsContainer}>
                            {['11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:30', '20:00'].map((timeOption) => (
                                <TouchableOpacity
                                    key={timeOption}
                                    style={[
                                        styles.timeOption,
                                        time === timeOption && styles.selectedTimeOption
                                    ]}
                                    onPress={() => {
                                        setTime(timeOption);
                                        setTimeModalVisible(false);
                                    }}
                                >
                                    <Text style={[
                                        styles.timeOptionText,
                                        time === timeOption && styles.selectedTimeOptionText
                                    ]}>
                                        {timeOption}
                                    </Text>
                                </TouchableOpacity>
                            ))}
                        </ScrollView>
                    </View>
                </View>
            </Modal>

            {/* ìµœëŒ€ ì¸ì› ì„ íƒ ëª¨ë‹¬ */}
            <Modal
                visible={isMaxMembersModalVisible}
                transparent={true}
                animationType="fade"
                onRequestClose={() => setMaxMembersModalVisible(false)}
            >
                <View style={styles.centeredView}>
                    <View style={[styles.modalView, { width: 300, height: 400 }]}>
                        <View style={styles.modalHeader}>
                            <Text style={styles.modalTitle}>ìµœëŒ€ ì¸ì› ì„ íƒ</Text>
                            <TouchableOpacity onPress={() => setMaxMembersModalVisible(false)}>
                                <Ionicons name="close" size={24} color={currentColors.gray} />
                            </TouchableOpacity>
                        </View>
                        <ScrollView style={styles.maxMembersOptionsContainer}>
                            {[2, 3, 4, 5, 6, 7, 8, 9, 10].map((memberCount) => (
                                <TouchableOpacity
                                    key={memberCount}
                                    style={[
                                        styles.maxMembersOption,
                                        maxMembers === memberCount && styles.selectedMaxMembersOption
                                    ]}
                                    onPress={() => {
                                        setMaxMembers(memberCount);
                                        setMaxMembersModalVisible(false);
                                    }}
                                >
                                    <Text style={[
                                        styles.maxMembersOptionText,
                                        maxMembers === memberCount && styles.selectedMaxMembersOptionText
                                    ]}>
                                        {memberCount}ëª…
                                    </Text>
                                </TouchableOpacity>
                            ))}
                        </ScrollView>
                    </View>
                </View>
            </Modal>
        </SafeAreaView>
    );
}

function CreateDangolPotScreen({ navigation }) {
    const [name, setName] = useState('');
    const [description, setDescription] = useState('');
    const [tags, setTags] = useState('');
    const [category, setCategory] = useState('');
    const [isCategoryModalVisible, setCategoryModalVisible] = useState(false);
    const CATEGORY_OPTIONS = ['í•œì‹', 'ì¤‘ì‹', 'ì¼ì‹', 'ì–‘ì‹', 'ë¶„ì‹', 'ì•„ì‹œì•ˆ', 'í“¨ì „', 'ê¸°íƒ€'];

    const handleSubmit = async () => {
        if (!name || !category) { Alert.alert("ì…ë ¥ ì˜¤ë¥˜", "ë‹¨ê³¨íŒŒí‹° ì´ë¦„ê³¼ ì¹´í…Œê³ ë¦¬ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }
        const response = await fetch(`${RENDER_SERVER_URL}/dangolpots`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, description, tags, category, host_id: myEmployeeId }) });
        if (response.ok) { Alert.alert("ì„±ê³µ", "ë‹¨ê³¨íŒŒí‹°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"); navigation.goBack(); } 
        else { Alert.alert("ì˜¤ë¥˜", "ë‹¨ê³¨íŒŒí‹° ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); }
    };
    return (
        <SafeAreaView style={styles.safeArea}>
            <ScrollView contentContainerStyle={styles.formContainer}>
                <Text style={styles.inputLabel}>ë‹¨ê³¨íŒŒí‹° ì´ë¦„</Text><TextInput style={styles.input} value={name} onChangeText={setName} />
                <Text style={styles.inputLabel}>ìŒì‹ ì¹´í…Œê³ ë¦¬</Text>
                <TouchableOpacity style={styles.input} onPress={() => setCategoryModalVisible(true)}><Text style={category ? styles.inputText : styles.placeholderText}>{category || "ì¹´í…Œê³ ë¦¬ ì„ íƒ"}</Text></TouchableOpacity>
                <Text style={styles.inputLabel}>ì†Œê°œ</Text><TextInput style={[styles.input, {height: 100, textAlignVertical: 'top'}]} placeholder="ì–´ë–¤ ëª¨ì„ì¸ì§€ ì†Œê°œí•´ì£¼ì„¸ìš”" value={description} onChangeText={setDescription} multiline />
                <Text style={styles.inputLabel}>ê´€ì‹¬ì‚¬ íƒœê·¸</Text><TextInput style={styles.input} placeholder="ì˜ˆ: #ë§¤ìš´ë§› #ë§›ì§‘íƒë°©" value={tags} onChangeText={setTags} />
                <TouchableOpacity style={styles.submitButton} onPress={handleSubmit}><Text style={[styles.submitButtonText, {color: currentColors.white}]}>ë§Œë“¤ê¸°</Text></TouchableOpacity>
                <SelectionModal visible={isCategoryModalVisible} title="ì¹´í…Œê³ ë¦¬ ì„ íƒ" options={CATEGORY_OPTIONS} selected={category} onSelect={setCategory} onClose={() => setCategoryModalVisible(false)} styles={styles} colors={currentColors} />
            </ScrollView>
        </SafeAreaView>
    );
}

function EditDangolPotScreen({ route, navigation }) {
    const { potData } = route.params;
    const [name, setName] = useState(potData.name);
    const [description, setDescription] = useState(potData.description);
    const [tags, setTags] = useState(potData.tags);
    const [category, setCategory] = useState(potData.category);
    const [isCategoryModalVisible, setCategoryModalVisible] = useState(false);
    const CATEGORY_OPTIONS = ['í•œì‹', 'ì¤‘ì‹', 'ì¼ì‹', 'ì–‘ì‹', 'ë¶„ì‹', 'ì•„ì‹œì•ˆ', 'í“¨ì „', 'ê¸°íƒ€'];

    const handleUpdate = async () => {
        if (!name || !category) { Alert.alert("ì…ë ¥ ì˜¤ë¥˜", "ë‹¨ê³¨íŒŒí‹° ì´ë¦„ê³¼ ì¹´í…Œê³ ë¦¬ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }
        const response = await fetch(`${RENDER_SERVER_URL}/dangolpots/${potData.id}`, { 
            method: 'PUT', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ name, description, tags, category, employee_id: myEmployeeId }) 
        });
        if (response.ok) { Alert.alert("ì„±ê³µ", "ë‹¨ê³¨íŒŒí‹° ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!"); navigation.goBack(); } 
        else { Alert.alert("ì˜¤ë¥˜", "ë‹¨ê³¨íŒŒí‹° ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); }
    };

    return (
        <SafeAreaView style={styles.safeArea}>
            <ScrollView contentContainerStyle={styles.formContainer}>
                <Text style={styles.inputLabel}>ë‹¨ê³¨íŒŒí‹° ì´ë¦„</Text><TextInput style={styles.input} value={name} onChangeText={setName} />
                <Text style={styles.inputLabel}>ìŒì‹ ì¹´í…Œê³ ë¦¬</Text>
                <TouchableOpacity style={styles.input} onPress={() => setCategoryModalVisible(true)}><Text style={category ? styles.inputText : styles.placeholderText}>{category || "ì¹´í…Œê³ ë¦¬ ì„ íƒ"}</Text></TouchableOpacity>
                <Text style={styles.inputLabel}>ì†Œê°œ</Text><TextInput style={[styles.input, {height: 100, textAlignVertical: 'top'}]} placeholder="ì–´ë–¤ ëª¨ì„ì¸ì§€ ì†Œê°œí•´ì£¼ì„¸ìš”" value={description} onChangeText={setDescription} multiline />
                <Text style={styles.inputLabel}>ê´€ì‹¬ì‚¬ íƒœê·¸</Text><TextInput style={styles.input} placeholder="ì˜ˆ: #ë§¤ìš´ë§› #ë§›ì§‘íƒë°©" value={tags} onChangeText={setTags} />
                <TouchableOpacity style={styles.submitButton} onPress={handleUpdate}><Text style={[styles.submitButtonText, {color: currentColors.white}]}>ìˆ˜ì •í•˜ê¸°</Text></TouchableOpacity>
                <SelectionModal visible={isCategoryModalVisible} title="ì¹´í…Œê³ ë¦¬ ì„ íƒ" options={CATEGORY_OPTIONS} selected={category} onSelect={setCategory} onClose={() => setCategoryModalVisible(false)} styles={styles} colors={currentColors} />
            </ScrollView>
        </SafeAreaView>
    );
}

function CreatePersonalScheduleScreen({ navigation, route }) {
    const { date } = route.params;
    const [title, setTitle] = useState('');
    const [restaurant, setRestaurant] = useState('');
    const [selectedDate, setSelectedDate] = useState(new Date(date));
    const [time, setTime] = useState('');
    const [location, setLocation] = useState('');
    const [attendees, setAttendees] = useState('');
    const [description, setDescription] = useState('');
    const [isDateModalVisible, setDateModalVisible] = useState(false);
    const [isTimeModalVisible, setTimeModalVisible] = useState(false);
    const [suggestedTitles, setSuggestedTitles] = useState([]);
    const [isLoadingSuggestions, setIsLoadingSuggestions] = useState(false);
    const [markedDates, setMarkedDates] = useState({});

    // AI ì ì‹¬ ì•½ì† ì œëª© ì œì•ˆ ê¸°ëŠ¥
    const generateTitleSuggestions = async () => {
        if (!restaurant.trim()) {
            Alert.alert('ì•Œë¦¼', 'ì‹ë‹¹ëª…ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            setIsLoadingSuggestions(true);
            const response = await fetch(`${RENDER_SERVER_URL}/ai/suggest-party-titles`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    restaurant: restaurant.trim(),
                    date: new Date(date).toLocaleDateString('ko-KR'),
                    time: time.trim(),
                    location: location.trim()
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('ì„œë²„ì—ì„œ JSON ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
            
            const data = await response.json();
            setSuggestedTitles(data.suggestions || []);
        } catch (error) {
            console.error('AI ì œëª© ì œì•ˆ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'AI ì œëª© ì œì•ˆ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        } finally {
            setIsLoadingSuggestions(false);
        }
    };

    const handleTitleSuggestion = (suggestion) => {
        setTitle(suggestion);
        setSuggestedTitles([]); // ì œì•ˆ ëª©ë¡ ë‹«ê¸°
    };

    const handleDateSelect = (selectedDate) => {
        setSelectedDate(selectedDate);
        setDateModalVisible(false);
    };

    const handleSave = async () => {
        if (!title.trim() || !restaurant.trim() || !time.trim()) {
            Alert.alert('ì…ë ¥ ì˜¤ë¥˜', 'ì ì‹¬ ì•½ì† ì´ë¦„, ì‹ë‹¹, ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        try {
            const response = await fetch(`${RENDER_SERVER_URL}/personal_schedules`, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ 
                    employee_id: myEmployeeId, 
                    schedule_date: toLocalDateString(selectedDate), 
                    title, 
                    description: `${description}${time ? `\nì‹œê°„: ${time}` : ''}${restaurant ? `\nì‹ë‹¹: ${restaurant}` : ''}${location ? `\nì¥ì†Œ: ${location}` : ''}${attendees ? `\nì°¸ì„ì: ${attendees}` : ''}`.trim()
                }), 
            });
            const data = await response.json();
            if (response.ok) { 
                Alert.alert('ì„±ê³µ', 'ê°œì¸ ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.'); 
                navigation.goBack(); 
            } else { 
                Alert.alert('ì˜¤ë¥˜', data.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); 
            }
        } catch (error) { 
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); 
        }
    };

    return (
        <SafeAreaView style={styles.safeArea}>
            <ScrollView contentContainerStyle={styles.formContainer}>
                <Text style={styles.inputLabel}>ì ì‹¬ ì•½ì† ì´ë¦„ *</Text>
                <View style={styles.titleInputContainer}>
                    <TextInput 
                        style={[styles.input, { flex: 1 }]} 
                        placeholder="ì ì‹¬ ì•½ì† ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" 
                        value={title} 
                        onChangeText={setTitle} 
                    />
                    <TouchableOpacity
                        style={styles.aiSuggestButton}
                        onPress={generateTitleSuggestions}
                        disabled={isLoadingSuggestions}
                    >
                        <Ionicons 
                            name="sparkles" 
                            size={20} 
                            color={isLoadingSuggestions ? currentColors.gray : currentColors.primary} 
                        />
                    </TouchableOpacity>
                </View>

                {/* AI ì œì•ˆ ì œëª© ëª©ë¡ */}
                {suggestedTitles.length > 0 && (
                    <View style={styles.suggestionsContainer}>
                        <Text style={styles.suggestionsTitle}>AI ì œì•ˆ ì œëª©</Text>
                        {suggestedTitles.map((suggestion, index) => (
                            <TouchableOpacity
                                key={index}
                                style={styles.suggestionItem}
                                onPress={() => handleTitleSuggestion(suggestion)}
                            >
                                <Text style={styles.suggestionText}>{suggestion}</Text>
                                <Ionicons name="arrow-forward" size={16} color={currentColors.primary} />
                            </TouchableOpacity>
                        ))}
                    </View>
                )}

                <Text style={styles.inputLabel}>ì‹ë‹¹ *</Text>
                <TextInput style={styles.input} placeholder="ì‹ë‹¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" value={restaurant} onChangeText={setRestaurant} />
                
                <Text style={styles.inputLabel}>ë‚ ì§œ *</Text>
                <TouchableOpacity style={styles.input} onPress={() => setDateModalVisible(true)}>
                    <Text style={styles.inputText}>
                        {selectedDate.toLocaleDateString('ko-KR')}
                    </Text>
                </TouchableOpacity>
                
                <Text style={styles.inputLabel}>ì‹œê°„ (ì„ íƒ)</Text>
                <TouchableOpacity style={styles.input} onPress={() => setTimeModalVisible(true)}>
                    <Text style={time ? styles.inputText : styles.placeholderText}>
                        {time || 'ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”'}
                    </Text>
                </TouchableOpacity>
                
                <Text style={styles.inputLabel}>ì¥ì†Œ (ì„ íƒ)</Text>
                <TextInput style={styles.input} placeholder="ì˜ˆ: íŒêµì—­ 2ë²ˆ ì¶œêµ¬" value={location} onChangeText={setLocation} />
                
                <Text style={styles.inputLabel}>ì°¸ì„ì (ì„ íƒ)</Text>
                <TextInput style={styles.input} placeholder="ì°¸ì„ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" value={attendees} onChangeText={setAttendees} />
                
                <Text style={styles.inputLabel}>ì„¤ëª… (ì„ íƒ)</Text>
                <TextInput 
                    style={[styles.input, { height: 100, textAlignVertical: 'top' }]} 
                    placeholder="ì ì‹¬ ì•½ì†ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" 
                    value={description} 
                    onChangeText={setDescription} 
                    multiline 
                />
                
                <TouchableOpacity style={styles.submitButton} onPress={handleSave}>
                    <Text style={styles.submitButtonText}>ì €ì¥í•˜ê¸°</Text>
                </TouchableOpacity>
                
                <TouchableOpacity style={[styles.submitButton, { backgroundColor: currentColors.gray, marginTop: 10 }]} onPress={() => navigation.goBack()}>
                    <Text style={styles.submitButtonText}>ì·¨ì†Œí•˜ê¸°</Text>
                </TouchableOpacity>
            </ScrollView>
            
            {/* ë‚ ì§œ ì„ íƒ ëª¨ë‹¬ - ì‘ì€ ìº˜ë¦°ë” */}
            <Modal
                visible={isDateModalVisible}
                transparent={true}
                animationType="fade"
                onRequestClose={() => setDateModalVisible(false)}
            >
                <View style={styles.centeredView}>
                    <View style={[styles.modalView, { width: 350, height: 450, maxWidth: '90%', maxHeight: '80%' }]}>
                        <View style={styles.modalHeader}>
                            <Text style={styles.modalTitle}>ë‚ ì§œ ì„ íƒ</Text>
                            <TouchableOpacity onPress={() => setDateModalVisible(false)}>
                                <Ionicons name="close" size={24} color={currentColors.gray} />
                            </TouchableOpacity>
                        </View>
                        <Calendar
                            current={selectedDate instanceof Date && !isNaN(selectedDate) ? selectedDate : new Date()}
  onDayPress={(day) => handleDateSelect(new Date(day.timestamp))}
  markedDates={{
    [toLocalDateString(selectedDate instanceof Date && !isNaN(selectedDate) ? selectedDate : new Date())]: {
      selected: true,
      selectedColor: currentColors.primary
    }
                            }}
                            theme={{
                                calendarBackground: currentColors.surface,
                                textSectionTitleColor: currentColors.text,
                                selectedDayBackgroundColor: currentColors.primary,
                                selectedDayTextColor: currentColors.surface,
                                todayTextColor: currentColors.primary,
                                dayTextColor: currentColors.text,
                                textDisabledColor: currentColors.gray,
                                dotColor: currentColors.primary,
                                selectedDotColor: currentColors.surface,
                                arrowColor: currentColors.primary,
                                monthTextColor: currentColors.text,
                                indicatorColor: currentColors.primary,
                                textDayFontWeight: '300',
                                textMonthFontWeight: 'bold',
                                textDayHeaderFontWeight: '300',
                                textDayFontSize: 16,
                                textMonthFontSize: 16,
                                textDayHeaderFontSize: 13
                            }}
                        />
                    </View>
                </View>
            </Modal>
            
            <SelectionModal 
                visible={isTimeModalVisible} 
                title="ì‹œê°„ ì„ íƒ" 
                options={['11:30', '12:00', '12:30', '13:00', '13:30', '14:00']} 
                selected={time} 
                onSelect={setTime} 
                onClose={() => setTimeModalVisible(false)} 
                styles={styles} colors={currentColors} 
            />
        </SafeAreaView>
    );
}

function EditPersonalScheduleScreen({ route, navigation }) {
    const { schedule } = route.params;
    const [title, setTitle] = useState(schedule.title);
    const [selectedDate, setSelectedDate] = useState(new Date(schedule.schedule_date));
    // descriptionì—ì„œ ì‹œê°„, ì¥ì†Œ, ì‹ë‹¹, ì°¸ì„ì, ë©”ëª¨ íŒŒì‹±
    let initialTime = '', initialLocation = '', initialRestaurant = '', initialAttendees = '', initialMemo = '';
    if (schedule.description) {
        const timeMatch = schedule.description.match(/ì‹œê°„: ([^\n]+)/);
        const locationMatch = schedule.description.match(/ì¥ì†Œ: ([^\n]+)/);
        const restaurantMatch = schedule.description.match(/ì‹ë‹¹: ([^\n]+)/);
        const attendeesMatch = schedule.description.match(/ì°¸ì„ì: ([^\n]+)/);
        initialTime = timeMatch ? timeMatch[1].trim() : '';
        initialLocation = locationMatch ? locationMatch[1].trim() : '';
        initialRestaurant = restaurantMatch ? restaurantMatch[1].trim() : '';
        initialAttendees = attendeesMatch ? attendeesMatch[1].trim() : '';
        // ë©”ëª¨ëŠ” ìœ„ í•­ëª©ë“¤ ì œì™¸í•œ ë‚˜ë¨¸ì§€
        initialMemo = schedule.description
            .replace(/ì‹œê°„: [^\n]+\n?/g, '')
            .replace(/ì¥ì†Œ: [^\n]+\n?/g, '')
            .replace(/ì‹ë‹¹: [^\n]+\n?/g, '')
            .replace(/ì°¸ì„ì: [^\n]+\n?/g, '')
            .trim();
    }
    const [time, setTime] = useState(initialTime);
    const [location, setLocation] = useState(initialLocation);
    const [restaurant, setRestaurant] = useState(initialRestaurant);
    const [attendees, setAttendees] = useState(initialAttendees);
    const [memo, setMemo] = useState(initialMemo);
    const [isDateModalVisible, setDateModalVisible] = useState(false);
    const [isTimeModalVisible, setTimeModalVisible] = useState(false);

    const handleDateSelect = (selectedDate) => {
        setSelectedDate(selectedDate);
        setDateModalVisible(false);
    };

    const handleUpdate = async () => {
        if (!title.trim() || !restaurant.trim() || !time.trim()) {
            Alert.alert('ì…ë ¥ ì˜¤ë¥˜', 'ì ì‹¬ ì•½ì† ì´ë¦„, ì‹ë‹¹, ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // description ì¬ì¡°ë¦½
        let desc = memo ? memo : '';
        if (time) desc += `${desc ? '\n' : ''}ì‹œê°„: ${time}`;
        if (restaurant) desc += `${desc ? '\n' : ''}ì‹ë‹¹: ${restaurant}`;
        if (location) desc += `${desc ? '\n' : ''}ì¥ì†Œ: ${location}`;
        if (attendees) desc += `${desc ? '\n' : ''}ì°¸ì„ì: ${attendees}`;
        
        const response = await fetch(`${RENDER_SERVER_URL}/personal_schedules/${schedule.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                title, 
                schedule_date: toLocalDateString(selectedDate),
                description: desc 
            })
        });
        if (response.ok) { Alert.alert("ì„±ê³µ", "ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); navigation.goBack(); }
        else { Alert.alert("ì˜¤ë¥˜", "ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); }
    };
    
    return (
        <SafeAreaView style={styles.safeArea}>
            <ScrollView contentContainerStyle={styles.formContainer}>
                <Text style={styles.inputLabel}>ì ì‹¬ ì•½ì† ì´ë¦„ *</Text>
                <TextInput style={styles.input} value={title} onChangeText={setTitle} />
                
                <Text style={styles.inputLabel}>ì‹ë‹¹ *</Text>
                <TextInput style={styles.input} placeholder="ì‹ë‹¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" value={restaurant} onChangeText={setRestaurant} />
                
                <Text style={styles.inputLabel}>ë‚ ì§œ *</Text>
                <TouchableOpacity style={styles.input} onPress={() => setDateModalVisible(true)}>
                    <Text style={styles.inputText}>
                        {selectedDate.toLocaleDateString('ko-KR')}
                    </Text>
                </TouchableOpacity>
                
                <Text style={styles.inputLabel}>ì‹œê°„ (ì„ íƒ)</Text>
                <TouchableOpacity style={styles.input} onPress={() => setTimeModalVisible(true)}>
                    <Text style={time ? styles.inputText : styles.placeholderText}>
                        {time || 'ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”'}
                    </Text>
                </TouchableOpacity>
                
                <Text style={styles.inputLabel}>ì¥ì†Œ (ì„ íƒ)</Text>
                <TextInput style={styles.input} placeholder="ì˜ˆ: íŒêµì—­ 2ë²ˆ ì¶œêµ¬" value={location} onChangeText={setLocation} />
                
                <Text style={styles.inputLabel}>ì°¸ì„ì (ì„ íƒ)</Text>
                <TextInput style={styles.input} placeholder="ì°¸ì„ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" value={attendees} onChangeText={setAttendees} />
                
                <Text style={styles.inputLabel}>ì„¤ëª… (ì„ íƒ)</Text>
                <TextInput style={[styles.input, { height: 100, textAlignVertical: 'top' }]} placeholder="ì ì‹¬ ì•½ì†ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" value={memo} onChangeText={setMemo} multiline />
                
                <TouchableOpacity style={styles.submitButton} onPress={handleUpdate}>
                    <Text style={styles.submitButtonText}>ìˆ˜ì • ì™„ë£Œ</Text>
                </TouchableOpacity>
            </ScrollView>
            
            {/* ë‚ ì§œ ì„ íƒ ëª¨ë‹¬ - ì‘ì€ ìº˜ë¦°ë” */}
            <Modal
                visible={isDateModalVisible}
                transparent={true}
                animationType="fade"
                onRequestClose={() => setDateModalVisible(false)}
            >
                <View style={styles.centeredView}>
                    <View style={[styles.modalView, { width: 350, height: 450, maxWidth: '90%', maxHeight: '80%' }]}>
                        <View style={styles.modalHeader}>
                            <Text style={styles.modalTitle}>ë‚ ì§œ ì„ íƒ</Text>
                            <TouchableOpacity onPress={() => setDateModalVisible(false)}>
                                <Ionicons name="close" size={24} color={currentColors.gray} />
                            </TouchableOpacity>
                        </View>
                        <Calendar
                            current={selectedDate instanceof Date && !isNaN(selectedDate) ? selectedDate : new Date()}
  onDayPress={(day) => handleDateSelect(new Date(day.timestamp))}
  markedDates={{
    [toLocalDateString(selectedDate instanceof Date && !isNaN(selectedDate) ? selectedDate : new Date())]: {
      selected: true,
      selectedColor: currentColors.primary
    }
                            }}
                            theme={{
                                calendarBackground: currentColors.surface,
                                textSectionTitleColor: currentColors.text,
                                selectedDayBackgroundColor: currentColors.primary,
                                selectedDayTextColor: currentColors.surface,
                                todayTextColor: currentColors.primary,
                                dayTextColor: currentColors.text,
                                textDisabledColor: currentColors.gray,
                                dotColor: currentColors.primary,
                                selectedDotColor: currentColors.surface,
                                arrowColor: currentColors.primary,
                                monthTextColor: currentColors.text,
                                indicatorColor: currentColors.primary,
                                textDayFontWeight: '300',
                                textMonthFontWeight: 'bold',
                                textDayHeaderFontWeight: '300',
                                textDayFontSize: 16,
                                textMonthFontSize: 16,
                                textDayHeaderFontSize: 13
                            }}
                        />
                    </View>
                </View>
            </Modal>
            
            <SelectionModal 
                visible={isTimeModalVisible} 
                title="ì‹œê°„ ì„ íƒ" 
                options={['11:30', '12:00', '12:30', '13:00', '13:30', '14:00']} 
                selected={time} 
                onSelect={setTime} 
                onClose={() => setTimeModalVisible(false)} 
                styles={styles} colors={currentColors} 
            />
        </SafeAreaView>
    );
}

// --- ìŠ¤ë§ˆíŠ¸ ëœë¤ ëŸ°ì¹˜ í™”ë©´ ---
function RandomLunchScreen({ navigation }) {
    const [recommendations, setRecommendations] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [myAppointments, setMyAppointments] = useState({});
    const [appointments, setAppointments] = useState([]); // ë‚ ì§œë³„ ì´ë²¤íŠ¸ ë°°ì—´
    const [modalData, setModalData] = useState({ visible: false, events: [], date: null });
    const [currentIndex, setCurrentIndex] = useState(0);
    const [proposedGroups, setProposedGroups] = useState(new Set());
    const [refreshing, setRefreshing] = useState(false);
    const { width: SCREEN_WIDTH } = Dimensions.get('window');

    useFocusEffect(
        useCallback(() => {
            fetchSmartRecommendations();
            fetchMyAppointments();
            fetchMyProposals();
        }, [])
    );

    const fetchSmartRecommendations = async () => {
        try {
            setIsLoading(true);
            const response = await fetch(`${RENDER_SERVER_URL}/proposals/smart-recommendations?employee_id=${myEmployeeId}`);
            const data = await response.json();
            if (response.ok) {
                // ì˜¤ëŠ˜ ì´í›„ ë‚ ì§œë§Œ í•„í„°ë§
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const filteredRecommendations = data.filter(recommendation => {
                    // proposed_dateê°€ 'YYYY-MM-DD' í˜•ì‹ì¸ì§€ í™•ì¸
                    if (!recommendation.proposed_date) return false;
                    
                    // UTC ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ í•´ì„
                    const dateObj = new Date(recommendation.proposed_date + 'T00:00:00Z');
                    // í•œêµ­ ì‹œê°„(UTC+9)ìœ¼ë¡œ ë³€í™˜
                    const koreaDate = new Date(dateObj.getTime() + 9 * 60 * 60 * 1000);
                    koreaDate.setHours(0, 0, 0, 0);
                    
                    return koreaDate > today; // ì˜¤ëŠ˜ë³´ë‹¤ í° ë‚ ì§œ(ë‚´ì¼ë¶€í„°)ë§Œ ë‚¨ê¹€
                });
                
                setRecommendations(filteredRecommendations);
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'ì¶”ì²œ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ìŠ¤ë§ˆíŠ¸ ì¶”ì²œ ì¡°íšŒ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
            setIsLoading(false);
        }
    };

    const fetchMyAppointments = async () => {
        try {
            const response = await fetch(`${RENDER_SERVER_URL}/events/${myEmployeeId}`);
            const data = await response.json();
            if (response.ok && data) {
                const newMarkedDates = {};
                const upcoming = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                for (let i = 0; i < 14; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() + i);
                    const dateString = toLocalDateString(date);
                    const eventsOnDate = data[dateString] || [];
                    upcoming.push({ date: dateString, events: eventsOnDate });
                    if (eventsOnDate.length > 0) {
                        let hasRandomLunch = false;
                        let hasPersonalSchedule = false;
                        let hasOtherEvents = false;
                        eventsOnDate.forEach(event => {
                            if (event.type === 'ëœë¤ ëŸ°ì¹˜') {
                                hasRandomLunch = true;
                            } else if (event.type === 'ê°œì¸ ì¼ì •') {
                                hasPersonalSchedule = true;
                            } else {
                                hasOtherEvents = true;
                            }
                        });
                        let dotColor;
                        if (hasRandomLunch) {
                            dotColor = '#F4D160';
                        } else if (hasPersonalSchedule) {
                            dotColor = currentColors.gray;
                        } else {
                            dotColor = currentColors.primary;
                        }
                        newMarkedDates[dateString] = {
                            selected: true,
                            selectedColor: dotColor,
                            selectedTextColor: '#FFFFFF'
                        };
                    }
                }
                setAppointments(upcoming);
                setMyAppointments(newMarkedDates);
            }
        } catch (error) {
            console.error('ë‚´ ì¼ì • ì¡°íšŒ ì˜¤ë¥˜:', error);
        }
    };

    const fetchMyProposals = async () => {
        try {
            const response = await fetch(`${RENDER_SERVER_URL}/proposals/mine?employee_id=${myEmployeeId}`);
            const data = await response.json();
            if (response.ok) {
                // pending ìƒíƒœì¸ ì œì•ˆë“¤ì˜ ê·¸ë£¹ í‚¤ë¥¼ ì¶”ì¶œ
                const sentProposals = data.sent_proposals || [];
                const pendingProposals = sentProposals.filter(p => p.status === 'pending');
                
                const proposedGroupKeys = new Set();
                pendingProposals.forEach(proposal => {
                    if (proposal.recipient_ids) {
                        const recipientIds = parseRecipientIds(proposal.recipient_ids);
                        if (recipientIds.length > 0) {
                            const groupKey = getGroupKeyFromIds(recipientIds);
                            proposedGroupKeys.add(groupKey);
                        }
                    }
                });
                
                // ê¸°ì¡´ ì œì•ˆ ìƒíƒœë¥¼ ì™„ì „íˆ êµì²´ (ìƒˆë¡œìš´ ìƒíƒœë¡œ ì—…ë°ì´íŠ¸)
                setProposedGroups(proposedGroupKeys);
                console.log('ì œì•ˆ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', Array.from(proposedGroupKeys));
            }
        } catch (error) {
            console.error('ì œì•ˆ ìƒíƒœ ì¡°íšŒ ì˜¤ë¥˜:', error);
        }
    };

    const handleProposeGroup = async (recommendation) => {
        try {
            const recipientIds = recommendation.recommended_group
                .map(member => member.employee_id)
                .filter(id => id && id.trim().length > 0)
                .join(',');
            
            const response = await fetch(`${RENDER_SERVER_URL}/proposals`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    proposer_id: myEmployeeId,
                    recipient_ids: recipientIds,
                    proposed_date: recommendation.proposed_date
                })
            });
            
            const data = await response.json();
            if (response.ok) {
                Alert.alert('ì„±ê³µ', 'ê·¸ë£¹ì— ì œì•ˆì„ ë³´ëƒˆìŠµë‹ˆë‹¤!');
                // ì œì•ˆí•œ ê·¸ë£¹ì„ pending ìƒíƒœë¡œ ì¶”ê°€
                const groupKey = getGroupKeyFromIds(parseRecipientIds(recipientIds));
                setProposedGroups(prev => new Set([...prev, groupKey]));
                fetchMyProposals();
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'ì œì•ˆ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ì œì•ˆ ì „ì†¡ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    };

    const handleCancelProposal = async (recommendation) => {
        try {
            const recipientIds = recommendation.recommended_group
                .map(member => member.employee_id)
                .filter(id => id && id.trim().length > 0)
                .join(',');
            
            // ë‚´ê°€ ë³´ë‚¸ ì œì•ˆ ì¤‘ì—ì„œ í•´ë‹¹ ê·¸ë£¹ê³¼ ë‚ ì§œê°€ ì¼ì¹˜í•˜ëŠ” ì œì•ˆ ì°¾ê¸°
            const response = await fetch(`${RENDER_SERVER_URL}/proposals/mine?employee_id=${myEmployeeId}`);
            const data = await response.json();
            
            if (response.ok) {
                const sentProposals = data.sent_proposals || [];
                
                // recipient_idsì™€ proposed_dateë¡œ ë§¤ì¹­í•˜ëŠ” ì œì•ˆ ì°¾ê¸°
                const targetProposal = sentProposals.find(proposal => {
                    const proposalRecipients = parseRecipientIds(proposal.recipient_ids);
                    const currentRecipients = parseRecipientIds(recipientIds);
                    const proposalKey = getGroupKeyFromIds(proposalRecipients);
                    const currentKey = getGroupKeyFromIds(currentRecipients);
                    
                    return proposalKey === currentKey && 
                           proposal.proposed_date === recommendation.proposed_date &&
                           proposal.status === 'pending';
                });
                
                if (targetProposal) {
                    // ì œì•ˆ ì·¨ì†Œ API í˜¸ì¶œ
                    const cancelResponse = await fetch(`${RENDER_SERVER_URL}/proposals/${targetProposal.id}/cancel`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: myEmployeeId
                        })
                    });
                    
                    const cancelData = await cancelResponse.json();
                    
                    if (cancelResponse.ok) {
                        // ì œì•ˆí•œ ê·¸ë£¹ì—ì„œ ì œê±° (ì„±ê³µ ì‹œì—ë§Œ)
                        const groupKey = getGroupKeyFromIds(parseRecipientIds(recipientIds));
                        setProposedGroups(prev => {
                            const newSet = new Set(prev);
                            newSet.delete(groupKey);
                            return newSet;
                        });
                        Alert.alert('ì„±ê³µ', 'ì œì•ˆì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        fetchMyProposals();
                    } else {
                        Alert.alert('ì˜¤ë¥˜', cancelData.message || 'ì œì•ˆ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                } else {
                    // ë°±ì—”ë“œì—ì„œ ì°¾ì§€ ëª»í–ˆì§€ë§Œ í”„ë¡ íŠ¸ì—”ë“œì—ì„œëŠ” ì œì•ˆëœ ìƒíƒœë¼ë©´ ë¡œì»¬ì—ì„œë§Œ ì œê±°
                    const groupKey = getGroupKeyFromIds(parseRecipientIds(recipientIds));
                    setProposedGroups(prev => {
                        const newSet = new Set(prev);
                        newSet.delete(groupKey);
                        return newSet;
                    });
                    Alert.alert('ì„±ê³µ', 'ì œì•ˆì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    fetchMyProposals();
                }
            } else {
                // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œì—ë„ ë¡œì»¬ì—ì„œ ì œê±°
                const groupKey = getGroupKeyFromIds(parseRecipientIds(recipientIds));
                setProposedGroups(prev => {
                    const newSet = new Set(prev);
                    newSet.delete(groupKey);
                    return newSet;
                });
                Alert.alert('ì„±ê³µ', 'ì œì•ˆì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                fetchMyProposals();
            }
        } catch (error) {
            console.error('ì œì•ˆ ì·¨ì†Œ ì˜¤ë¥˜:', error);
            // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ë¡œì»¬ì—ì„œ ì œê±°
            const recipientIds = recommendation.recommended_group
                .map(member => member.employee_id)
                .filter(id => id && id.trim().length > 0)
                .join(',');
            const groupKey = getGroupKeyFromIds(parseRecipientIds(recipientIds));
            setProposedGroups(prev => {
                const newSet = new Set(prev);
                newSet.delete(groupKey);
                return newSet;
            });
            Alert.alert('ì„±ê³µ', 'ì œì•ˆì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            fetchMyProposals();
        }
    };

    const onRefresh = async () => {
        setRefreshing(true);
        await fetchSmartRecommendations();
        await fetchMyProposals();
        setRefreshing(false);
    };

    const renderRecommendationCard = ({ item }) => {
        const date = new Date(item.proposed_date);
        const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];
// ì¶”ì²œ ê·¸ë£¹ ì¹´ë“œì—ì„œ
const groupUserIds = item.recommended_group
    ? item.recommended_group.map(member => member.employee_id).filter(Boolean)
    : item.users.map(user => user.employee_id).filter(Boolean); // ìƒí™©ì— ë”°ë¼
const groupKey = getGroupKeyFromIds(groupUserIds);

const isProposed = proposedGroups.has(groupKey);        
        
        return (
            <View style={{
                backgroundColor: currentColors.surface,
                borderRadius: 16,
                marginHorizontal: 16,
                marginBottom: 16,
                padding: 20,
                elevation: 3,
                shadowColor: currentColors.primary,
                shadowOffset: { width: 0, height: 4 },
                shadowOpacity: 0.1,
                shadowRadius: 8,
                borderWidth: 1,
                borderColor: 'rgba(59, 130, 246, 0.1)',
                width: SCREEN_WIDTH - 32
            }}>
                <Text style={{
                    fontSize: 18,
                    fontWeight: 'bold',
                    color: currentColors.text,
                    marginBottom: 16
                }}>
                    {`${date.getMonth() + 1}ì›” ${date.getDate()}ì¼(${dayOfWeek}) ì¶”ì²œ ê·¸ë£¹`}
                </Text>
                
                {item.recommended_group.map((member, index) => (
                    <View key={index} style={{
                        backgroundColor: currentColors.background,
                        borderRadius: 12,
                        padding: 12,
                        marginBottom: 8,
                        borderWidth: 1,
                        borderColor: currentColors.lightGray
                    }}>
                        <View style={{
                            flexDirection: 'row',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            marginBottom: 4
                        }}>
                            <Text style={{
                                fontSize: 16,
                                fontWeight: 'bold',
                                color: currentColors.text
                            }}>
                                {member.nickname}
                            </Text>
                            <View style={{
                                backgroundColor: currentColors.primaryLight,
                                borderRadius: 12,
                                paddingHorizontal: 8,
                                paddingVertical: 4
                            }}>
                                <Text style={{
                                    fontSize: 12,
                                    color: currentColors.primary,
                                    fontWeight: 'bold'
                                }}>
                                    {member.dining_history}
                                </Text>
                            </View>
                        </View>
                        <Text style={{
                            fontSize: 14,
                            color: currentColors.textSecondary
                        }}>
                            {member.lunch_preference}
                        </Text>
                    </View>
                ))}
                
                <TouchableOpacity
                    style={{
                        backgroundColor: isProposed ? currentColors.red : currentColors.primary,
                        borderRadius: 12,
                        paddingVertical: 12,
                        paddingHorizontal: 20,
                        alignItems: 'center',
                        marginTop: 12
                    }}
                    onPress={() => isProposed ? handleCancelProposal(item) : handleProposeGroup(item)}
                >
                    <Text style={{
                        color: '#FFFFFF',
                        fontSize: 16,
                        fontWeight: 'bold'
                    }}>
                        {isProposed ? 'ì œì•ˆ ì·¨ì†Œ' : 'ì´ ê·¸ë£¹ì— ì œì•ˆí•˜ê¸°'}
                    </Text>
                </TouchableOpacity>
            </View>
        );
    };

    if (isLoading) {
        return (
            <SafeAreaView style={styles.safeArea}>
                <View style={{flex: 1, justifyContent: 'center', alignItems: 'center'}}>
                    <ActivityIndicator size="large" color={currentColors.primary} />
                    <Text style={{fontSize: 16, color: currentColors.textSecondary, marginTop: 16}}>
                        ìŠ¤ë§ˆíŠ¸ ì¶”ì²œì„ ë¶„ì„í•˜ëŠ” ì¤‘...
                    </Text>
                </View>
            </SafeAreaView>
        );
    }

    return (
        <SafeAreaView style={styles.safeArea}>
            <ScrollView 
                style={{flex: 1, backgroundColor: currentColors.background}}
                refreshControl={
                    <RefreshControl
                        refreshing={refreshing}
                        onRefresh={onRefresh}
                        colors={[currentColors.primary]}
                        tintColor={currentColors.primary}
                    />
                }
            >
                <View style={{
                    paddingHorizontal: 16,
                    paddingVertical: 20,
                    backgroundColor: currentColors.surface,
                    marginBottom: 16
                }}>
                    <Text style={{
                        fontSize: 24,
                        fontWeight: 'bold',
                        color: currentColors.text,
                        marginBottom: 8
                    }}>
                        ëœë¤ ëŸ°ì¹˜ ğŸ¯
                    </Text>
                    <Text style={{
                        fontSize: 16,
                        color: currentColors.textSecondary,
                        lineHeight: 22
                    }}>
                        ìƒˆë¡œìš´ ë™ë£Œì™€ ì ì‹¬ ì•½ì†ì„ ì¡ì•„ë³´ì„¸ìš”.
                    </Text>
                    <Text style={{
                        fontSize: 14,
                        color: currentColors.textSecondary,
                        marginTop: 8,
                        fontStyle: 'italic'
                    }}>
                        ì•„ë˜ë¡œ ìŠ¤ì™€ì´í”„í•˜ì—¬ ìƒˆë¡œìš´ ì¶”ì²œì„ ë°›ì•„ë³´ì„¸ìš”!
                    </Text>
                </View>

                {recommendations.length > 0 ? (
                    <>
                    <FlatList
                        data={recommendations}
                        renderItem={renderRecommendationCard}
                        keyExtractor={(item, index) => `recommendation-${index}`}
                        horizontal
                        pagingEnabled
                        showsHorizontalScrollIndicator={false}
                        onMomentumScrollEnd={event => {
                            const index = Math.round(event.nativeEvent.contentOffset.x / (SCREEN_WIDTH - 32));
                            setCurrentIndex(index);
                        }}
                        contentContainerStyle={{ paddingHorizontal: 0 }}
                    />
                    {recommendations.length > 1 && (
                        <View style={{ flexDirection: 'row', justifyContent: 'center', alignItems: 'center', marginTop: 16, marginBottom: 8 }}>
                            {recommendations.map((_, idx) => (
                                <View
                                    key={idx}
                                    style={{
                                        width: 8,
                                        height: 8,
                                        borderRadius: 4,
                                        backgroundColor: idx === currentIndex ? currentColors.primary : currentColors.lightGray,
                                        marginHorizontal: 4
                                    }}
                                />
                            ))}
                        </View>
                    )}
                    </>
                ) : (
                    <View style={{
                        paddingHorizontal: 16,
                        paddingVertical: 40,
                        alignItems: 'center'
                    }}>
                        <Text style={{
                            fontSize: 18,
                            color: currentColors.textSecondary,
                            textAlign: 'center',
                            marginBottom: 8
                        }}>
                            í˜„ì¬ ì¶”ì²œí•  ìˆ˜ ìˆëŠ” ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.
                        </Text>
                        <Text style={{
                            fontSize: 14,
                            color: currentColors.textSecondary,
                            textAlign: 'center'
                        }}>
                            ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.
                        </Text>
                    </View>
                )}

                <View style={{
                    marginHorizontal: 16,
                    marginTop: 20,
                    marginBottom: 40
                }}>
                    <Text style={{
                        fontSize: 18,
                        fontWeight: 'bold',
                        color: currentColors.text,
                        marginBottom: 12
                    }}>
                        ë‚´ ìº˜ë¦°ë” ğŸ“…
                    </Text>
                    <View style={{
                        backgroundColor: currentColors.surface,
                        borderRadius: 16,
                        padding: 16,
                        elevation: 2,
                        shadowColor: currentColors.primary,
                        shadowOffset: { width: 0, height: 2 },
                        shadowOpacity: 0.1,
                        shadowRadius: 4
                    }}>
                        <Calendar
                            markedDates={myAppointments}
                            onDayPress={(day) => {
                                const events = (appointments || []).find(a => a.date === day.dateString)?.events || [];
                                setModalData({ visible: true, events: events, date: day.dateString });
                            }}
                            theme={{
                                selectedDayBackgroundColor: currentColors.primary,
                                todayTextColor: currentColors.primary,
                                arrowColor: currentColors.primary,
                                selectedDayTextColor: '#FFFFFF',
                                'stylesheet.calendar.header': {
                                    week: {
                                        marginTop: 5,
                                        flexDirection: 'row',
                                        justifyContent: 'space-between'
                                    }
                                },
                                'stylesheet.day.basic': {
                                    base: {
                                        width: 32,
                                        height: 32,
                                        alignItems: 'center',
                                        justifyContent: 'center'
                                    }
                                }
                            }}
                        />
                    </View>
                </View>
            </ScrollView>
            <Modal visible={modalData.visible} transparent={true} animationType="fade" onRequestClose={() => setModalData({ ...modalData, visible: false })}>
                <View style={styles.centeredView}>
                    <View style={styles.modalView}>
                        {(modalData.events || []).length > 0 ? (
                            <>
                                <Text style={styles.modalTitle}>{new Date(modalData.date).toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' })} ì ì‹¬ ì•½ì†</Text>
                                <ScrollView style={{width: '100%', maxHeight: SCREEN_HEIGHT * 0.5 }}>
                                    {modalData.events.map((event, index) => (
                                        <View key={index} style={styles.modalDetailCard}>
                                            <Text style={styles.eventTitle}>{event.type === 'ëœë¤ ëŸ°ì¹˜' ? 'âš¡ï¸' : (event.type === 'íŒŒí‹°' ? 'ğŸ‰' : 'ğŸ“')} {event.title}</Text>
                                            {event.type !== 'ê°œì¸ ì¼ì •' ? (
                                                <>
                                                    <Text style={styles.modalDetailText}>âˆ™ ì¼ì‹œ: {event.date} {event.time}</Text>
                                                    <Text style={styles.modalDetailText}>âˆ™ ì‹ë‹¹: {event.restaurant}</Text>
                                                    {event.address && <Text style={styles.modalDetailText}>âˆ™ ì£¼ì†Œ: {event.address}</Text>}
                                                    <Text style={styles.modalDetailText}>âˆ™ ì¥ì†Œ: {event.location}</Text>
                                                    <Text style={styles.modalDetailText}>âˆ™ ì°¸ì„ì: {(event.all_members || []).join(', ')}</Text>
                                                    <TouchableOpacity style={[styles.button, {backgroundColor: currentColors.primary, marginTop: 15}]} onPress={() => { setModalData({ visible: false }); navigation.navigate('ì†Œí†µ', { screen: 'ChatRoom', params: { chatId: event.id, chatType: 'party', chatTitle: event.title } }); }}><Text style={styles.textStyle}>ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™</Text></TouchableOpacity>
                                                </>
                                            ) :
                                                <>
                                                    <Text style={styles.modalDetailText}>{event.description || 'ë©”ëª¨ ì—†ìŒ'}</Text>
                                                    <View style={{flexDirection: 'row', justifyContent: 'space-around', marginTop: 15}}>
                                                        <TouchableOpacity style={[styles.button, {backgroundColor: currentColors.primary, width: '48%'}]} onPress={() => handleEditPersonalSchedule(event)}>
                                                            <Text style={[styles.textStyle, {color: '#FFFFFF'}]}>ìˆ˜ì •</Text>
                                                        </TouchableOpacity>
                                                        <TouchableOpacity style={[styles.button, {backgroundColor: currentColors.gray, width: '48%'}]} onPress={() => handleDeletePersonalSchedule(event.id)}>
                                                            <Text style={[styles.textStyle, {color: '#FFFFFF'}]}>ì‚­ì œ</Text>
                                                        </TouchableOpacity>
                                                    </View>
                                                </>
                                            }
                                        </View>
                                    ))}
                                </ScrollView>
                            </>
                        ) :
                            <>
                                <Text style={styles.modalTitle}>ì ì‹¬ ì•½ì†ì„ ë§Œë“¤ì–´ ë³¼ê¹Œìš”?</Text>
                                <TouchableOpacity
                                    style={{
                                        backgroundColor: currentColors.yellow,
                                        borderRadius: 18,
                                        marginTop: 12,
                                        marginBottom: 8,
                                        paddingVertical: 16,
                                        paddingHorizontal: 20,
                                        alignItems: 'center',
                                        elevation: 4,
                                        width: '100%',
                                    }}
                                    onPress={() => { setModalData({ visible: false }); navigation.navigate('íŒŒí‹°', { screen: 'RandomLunch' }); }}
                                >
                                    <Text style={{ color: currentColors.deepBlue, fontSize: 16, fontWeight: 'bold' }}>
                                        ğŸ² ëœë¤ ëŸ°ì¹˜ ì‹œì‘í•˜ê¸°
                                    </Text>
                                </TouchableOpacity>
                                <TouchableOpacity
                                    style={{
                                        backgroundColor: currentColors.primary,
                                        borderRadius: 18,
                                        marginTop: 8,
                                        marginBottom: 8,
                                        paddingVertical: 16,
                                        paddingHorizontal: 20,
                                        alignItems: 'center',
                                        elevation: 4,
                                        width: '100%',
                                    }}
                                    onPress={() => { setModalData({ visible: false }); navigation.navigate('íŒŒí‹°'); }}
                                >
                                    <Text style={{ color: '#FFFFFF', fontSize: 16, fontWeight: 'bold' }}>
                                        ğŸ‰ íŒŒí‹° ì°¸ì—¬í•˜ê¸°
                                    </Text>
                                </TouchableOpacity>
                                <TouchableOpacity
                                    style={{
                                        backgroundColor: currentColors.gray,
                                        borderRadius: 18,
                                        marginTop: 8,
                                        marginBottom: 12,
                                        paddingVertical: 16,
                                        paddingHorizontal: 20,
                                        alignItems: 'center',
                                        elevation: 4,
                                        width: '100%',
                                    }}
                                    onPress={() => { setModalData({ visible: false }); navigation.navigate('íŒŒí‹°', { screen: 'CreatePersonalSchedule', params: { date: modalData.date } }); }}
                                >
                                    <Text style={{ color: '#FFFFFF', fontSize: 16, fontWeight: 'bold' }}>
                                        ğŸ“ ê°œì¸ ì ì‹¬ ì•½ì† ì¶”ê°€
                                    </Text>
                                </TouchableOpacity>
                            </>
                        }
                    </View>
                </View>
            </Modal>
        </SafeAreaView>
    );
}

// --- ì†Œí†µ íƒ­ ---
function ChatListScreen({ navigation }) {
    const [chats, setChats] = useState([]);
    const [filteredChats, setFilteredChats] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [activeFilter, setActiveFilter] = useState('all');
    const [refreshing, setRefreshing] = useState(false);

    const fetchChats = async () => {
        try {
            const response = await fetch(`${RENDER_SERVER_URL}/chats/${myEmployeeId}`);
            const data = await response.json();
            if(Array.isArray(data)) {
                setChats(data);
                setFilteredChats(data);
            }
        } catch (error) {
            console.error('ì±„íŒ… ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
        }
    };

    useFocusEffect(useCallback(() => {
        setIsLoading(true);
        fetchChats().finally(() => setIsLoading(false));
    }, []));

    const onRefresh = async () => {
        setRefreshing(true);
        await fetchChats();
        setRefreshing(false);
    };

    const handleFilterChange = (filter) => {
        setActiveFilter(filter);
        if (filter === 'all') {
            setFilteredChats(chats);
        } else if (filter === 'party') {
            setFilteredChats(chats.filter(chat => chat.type === 'party'));
        } else if (filter === 'dangolpot') {
            setFilteredChats(chats.filter(chat => chat.type === 'dangolpot'));
        } else if (filter === 'custom') {
            setFilteredChats(chats.filter(chat => chat.type === 'custom'));
        }
    };

    if (isLoading) return <ActivityIndicator style={{flex: 1}} size="large" color={currentColors.primary} />;
    
    return (
        <SafeAreaView style={styles.safeArea}>
            {/* ì±„íŒ… í•„í„° */}
            <View style={{paddingHorizontal: 16, paddingVertical: 12, backgroundColor: currentColors.background}}>
                <ScrollView horizontal showsHorizontalScrollIndicator={false}>
                    <TouchableOpacity
                        style={{
                            backgroundColor: activeFilter === 'all' ? currentColors.primary : currentColors.surface,
                            borderRadius: 20,
                            paddingVertical: 8,
                            paddingHorizontal: 16,
                            marginRight: 8,
                            elevation: activeFilter === 'all' ? 2 : 1,
                            shadowColor: currentColors.primary,
                            shadowOffset: { width: 0, height: 2 },
                            shadowOpacity: activeFilter === 'all' ? 0.2 : 0.1,
                            shadowRadius: 4,
                            borderWidth: 1,
                            borderColor: activeFilter === 'all' ? currentColors.primary : currentColors.lightGray
                        }}
                        onPress={() => handleFilterChange('all')}
                    >
                        <Text style={{
                            color: activeFilter === 'all' ? '#FFFFFF' : currentColors.text,
                            fontWeight: activeFilter === 'all' ? 'bold' : '600',
                            fontSize: 14
                        }}>
                            ì „ì²´
                        </Text>
                    </TouchableOpacity>
                    <TouchableOpacity
                        style={{
                            backgroundColor: activeFilter === 'party' ? currentColors.primary : currentColors.surface,
                            borderRadius: 20,
                            paddingVertical: 8,
                            paddingHorizontal: 16,
                            marginRight: 8,
                            elevation: activeFilter === 'party' ? 2 : 1,
                            shadowColor: currentColors.primary,
                            shadowOffset: { width: 0, height: 2 },
                            shadowOpacity: activeFilter === 'party' ? 0.2 : 0.1,
                            shadowRadius: 4,
                            borderWidth: 1,
                            borderColor: activeFilter === 'party' ? currentColors.primary : currentColors.lightGray
                        }}
                        onPress={() => handleFilterChange('party')}
                    >
                        <Text style={{
                            color: activeFilter === 'party' ? '#FFFFFF' : currentColors.text,
                            fontWeight: activeFilter === 'party' ? 'bold' : '600',
                            fontSize: 14
                        }}>
                            íŒŒí‹°
                        </Text>
                    </TouchableOpacity>
                    <TouchableOpacity
                        style={{
                            backgroundColor: activeFilter === 'dangolpot' ? currentColors.primary : currentColors.surface,
                            borderRadius: 20,
                            paddingVertical: 8,
                            paddingHorizontal: 16,
                            marginRight: 8,
                            elevation: activeFilter === 'dangolpot' ? 2 : 1,
                            shadowColor: currentColors.primary,
                            shadowOffset: { width: 0, height: 2 },
                            shadowOpacity: activeFilter === 'dangolpot' ? 0.2 : 0.1,
                            shadowRadius: 4,
                            borderWidth: 1,
                            borderColor: activeFilter === 'dangolpot' ? currentColors.primary : currentColors.lightGray
                        }}
                        onPress={() => handleFilterChange('dangolpot')}
                    >
                        <Text style={{
                            color: activeFilter === 'dangolpot' ? '#FFFFFF' : currentColors.text,
                            fontWeight: activeFilter === 'dangolpot' ? 'bold' : '600',
                            fontSize: 14
                        }}>
                            ë‹¨ê³¨íŒŒí‹°
                        </Text>
                    </TouchableOpacity>
                    <TouchableOpacity
                        style={{
                            backgroundColor: activeFilter === 'custom' ? currentColors.primary : currentColors.surface,
                            borderRadius: 20,
                            paddingVertical: 8,
                            paddingHorizontal: 16,
                            marginRight: 8,
                            elevation: activeFilter === 'custom' ? 2 : 1,
                            shadowColor: currentColors.primary,
                            shadowOffset: { width: 0, height: 2 },
                            shadowOpacity: activeFilter === 'custom' ? 0.2 : 0.1,
                            shadowRadius: 4,
                            borderWidth: 1,
                            borderColor: activeFilter === 'custom' ? currentColors.primary : currentColors.lightGray
                        }}
                        onPress={() => handleFilterChange('custom')}
                    >
                        <Text style={{
                            color: activeFilter === 'custom' ? '#FFFFFF' : currentColors.text,
                            fontWeight: activeFilter === 'custom' ? 'bold' : '600',
                            fontSize: 14
                        }}>
                            ê°œì¸ì±„íŒ…
                        </Text>
                    </TouchableOpacity>
                </ScrollView>
            </View>

            <FlatList 
                data={filteredChats} 
                keyExtractor={item => `${item.type}-${item.id}`} 
                refreshing={refreshing}
                onRefresh={onRefresh}
                ListEmptyComponent={<Text style={{fontSize: 16, color: currentColors.textSecondary, textAlign: 'center', marginTop: 50, paddingHorizontal: 16}}>ì°¸ì—¬ ì¤‘ì¸ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</Text>} 
                renderItem={({ item }) => (
                    <TouchableOpacity 
                        style={{
                            backgroundColor: currentColors.surface,
                            borderRadius: 16,
                            marginHorizontal: 16,
                            marginBottom: 12,
                            padding: 16,
                            flexDirection: 'row',
                            alignItems: 'center',
                            elevation: 2,
                            shadowColor: currentColors.primary,
                            shadowOffset: { width: 0, height: 2 },
                            shadowOpacity: 0.1,
                            shadowRadius: 4,
                            borderWidth: 1,
                            borderColor: 'rgba(99, 102, 241, 0.2)'
                        }} 
                        onPress={() => navigation.navigate('ChatRoom', { chatId: item.id, chatType: item.type, chatTitle: item.title })}
                    >
                        <View style={{
                            backgroundColor: currentColors.primary,
                            borderRadius: 12,
                            width: 48,
                            height: 48,
                            justifyContent: 'center',
                            alignItems: 'center',
                            marginRight: 12
                        }}>
                            <Ionicons 
                                name={item.type === 'dangolpot' ? 'heart-circle' : (item.is_from_match ? 'shuffle' : 'restaurant')} 
                                size={24} 
                                color="white" 
                            />
                        </View>
                        <View style={{flex: 1}}>
                            <Text style={{fontSize: 16, fontWeight: 'bold', color: currentColors.text, marginBottom: 4}}>{item.title}</Text>
                            <Text style={{fontSize: 14, color: currentColors.textSecondary}}>{item.subtitle}</Text>
                            {item.last_message && (
                                <Text style={{fontSize: 12, color: currentColors.textSecondary, marginTop: 2}} numberOfLines={1}>
                                    {item.last_message}
                                </Text>
                            )}
                        </View>
                        <Ionicons name="chevron-forward" size={24} color={currentColors.textSecondary} />
                    </TouchableOpacity>
                )} 
                contentContainerStyle={{paddingTop: 16}} 
            />
            
            {/* í”Œë¡œíŒ… ì±„íŒ…ë°© ìƒì„± ë²„íŠ¼ */}
            <TouchableOpacity
                style={{
                    position: 'absolute',
                    right: 24,
                    bottom: 32,
                    width: 56,
                    height: 56,
                    borderRadius: 28,
                    backgroundColor: currentColors.primary,
                    justifyContent: 'center',
                    alignItems: 'center',
                    zIndex: 10,
                    elevation: 8,
                    shadowColor: currentColors.primary,
                    shadowOffset: { width: 0, height: 4 },
                    shadowOpacity: 0.3,
                    shadowRadius: 8
                }}
                activeOpacity={0.85}
                onPress={() => navigation.navigate('CreateChatRoom')}
            >
                <Ionicons name="chatbubbles" size={28} color="#fff" />
            </TouchableOpacity>
        </SafeAreaView>
    );
}

function ChatRoomScreen({ route, navigation }) {
    const { chatId, chatType, chatTitle: initialChatTitle } = route.params;
    const [chatDetails, setChatDetails] = useState(null);
    const [messages, setMessages] = useState([]);
    const [newMessage, setNewMessage] = useState('');
    const [socket, setSocket] = useState(null);
    const [isConnected, setIsConnected] = useState(false);
    const [isSearchVisible, setIsSearchVisible] = useState(false);
    const [searchQuery, setSearchQuery] = useState('');
    const [searchResults, setSearchResults] = useState([]);
    const [isSearching, setIsSearching] = useState(false);
    const [isImagePickerVisible, setIsImagePickerVisible] = useState(false);
    const [chatMembers, setChatMembers] = useState([]);
    const [isTitleEditVisible, setIsTitleEditVisible] = useState(false);
    const [isMembersVisible, setIsMembersVisible] = useState(false);
    const [newTitle, setNewTitle] = useState('');
    const [chatTitle, setChatTitle] = useState(initialChatTitle);
    const flatListRef = useRef(null);
    const [isMenuVisible, setIsMenuVisible] = useState(false);
    useEffect(() => {
        navigation.setOptions({
          headerRight: () => (
            <View style={{ flexDirection: 'row', marginRight: 10 }}>
              <TouchableOpacity onPress={() => setIsSearchVisible(!isSearchVisible)} style={{ marginRight: 16 }}>
                <Ionicons name="search" size={24} color={currentColors.text} />
              </TouchableOpacity>
              <TouchableOpacity onPress={() => setIsMenuVisible(true)}>
                <Ionicons name="menu" size={28} color={currentColors.text} />
              </TouchableOpacity>
            </View>
          ),
        });
      }, [navigation, setIsSearchVisible, setIsMenuVisible, currentColors.text]);

    // WebSocket ì—°ê²° ë° ì‹¤ì‹œê°„ ì½ìŒ ì²˜ë¦¬ (ì„ì‹œë¡œ ë¹„í™œì„±í™”)
    useEffect(() => {
        // WebSocket ì—°ê²°ì´ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ì„ì‹œë¡œ ì—°ê²°ëœ ê²ƒìœ¼ë¡œ ì²˜ë¦¬
        setIsConnected(true);
        
        // ì‹¤ì œ WebSocket ì—°ê²°ì€ ë°±ì—”ë“œ êµ¬í˜„ í›„ í™œì„±í™”
        /*
        // WebSocket URL ìƒì„±
        let wsUrl = RENDER_SERVER_URL;
        if (wsUrl.startsWith('https://')) {
            wsUrl = wsUrl.replace('https://', 'wss://');
        } else if (wsUrl.startsWith('http://')) {
            wsUrl = wsUrl.replace('http://', 'ws://');
        }
        
        console.log('Attempting to connect to WebSocket:', wsUrl);
        
        const newSocket = io(wsUrl, {
            transports: ['polling', 'websocket'],
            timeout: 30000,
            forceNew: true,
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000
        });
        
        newSocket.on('connect', () => {
            console.log('Connected to WebSocket');
            setIsConnected(true);
            
            // ì±„íŒ…ë°©ì— ì°¸ì—¬
            newSocket.emit('join_chat', {
                chat_type: chatType,
                chat_id: chatId
            });
        });

        newSocket.on('disconnect', (reason) => {
            console.log('Disconnected from WebSocket:', reason);
            setIsConnected(false);
        });

        newSocket.on('connect_error', (error) => {
            console.log('WebSocket connection error:', error);
            setIsConnected(false);
        });

        newSocket.on('reconnect', (attemptNumber) => {
            console.log('Reconnected to WebSocket after', attemptNumber, 'attempts');
            setIsConnected(true);
            
            // ì¬ì—°ê²° ì‹œ ì±„íŒ…ë°©ì— ë‹¤ì‹œ ì°¸ì—¬
            newSocket.emit('join_chat', {
                chat_type: chatType,
                chat_id: chatId
            });
        });

        newSocket.on('reconnect_error', (error) => {
            console.log('WebSocket reconnection error:', error);
            setIsConnected(false);
        });

        newSocket.on('new_message', (message) => {
            console.log('New message received:', message);
            setMessages(prev => [...prev, message]);
        });

        // ì‹¤ì‹œê°„ ì½ìŒ ì²˜ë¦¬ ì´ë²¤íŠ¸
        newSocket.on('message_read', (data) => {
            console.log('Message read event received:', data);
            setMessages(prev => 
                prev.map(msg => 
                    msg.id === data.message_id 
                        ? { ...msg, unread_count: data.unread_count }
                        : msg
                )
            );
        });

        setSocket(newSocket);

        return () => {
            if (newSocket) {
                newSocket.emit('leave_chat', {
                    chat_type: chatType,
                    chat_id: chatId
                });
                newSocket.disconnect();
            }
        };
        */
    }, [chatId, chatType]);

    // ì±„íŒ…ë°© ì •ë³´ ë° ë©”ì‹œì§€ ë¡œë“œ
    useFocusEffect(useCallback(() => { 
        const loadChatData = async () => {
            try {
                // ì±„íŒ…ë°© ì •ë³´ ë¡œë“œ
                if (chatType === 'party') {
                    const response = await fetch(`${RENDER_SERVER_URL}/parties/${chatId}`);
                    const data = await response.json();
                    setChatDetails(data);
                    
                    // íŒŒí‹° ì°¸ê°€ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                    const membersResponse = await fetch(`${RENDER_SERVER_URL}/parties/${chatId}/members`);
                    if (membersResponse.ok) {
                        const membersData = await membersResponse.json();
                        setChatMembers(membersData);
                    }
                } else if (chatType === 'dangolpot') {
                    const response = await fetch(`${RENDER_SERVER_URL}/dangolpots/${chatId}`);
                    const data = await response.json();
                    setChatDetails(data);
                    
                    // ë‹¨ê³¨íŒŒí‹° ì°¸ê°€ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                    const membersResponse = await fetch(`${RENDER_SERVER_URL}/dangolpots/${chatId}/members`);
                    if (membersResponse.ok) {
                        const membersData = await membersResponse.json();
                        setChatMembers(membersData);
                    }
                } else if (chatType === 'custom') {
                    // ê°œì¸ ì±„íŒ…ì˜ ê²½ìš° ê¸°ë³¸ ì±„íŒ…ë°© ì •ë³´ ì„¤ì •
                    setChatDetails({
                        id: chatId,
                        title: chatTitle,
                        type: 'custom',
                        created_at: new Date().toISOString()
                    });
                    
                    // ê°œì¸ ì±„íŒ…ì˜ ê²½ìš° ì¹œêµ¬ ëª©ë¡ì—ì„œ ì°¸ê°€ì ê°€ì ¸ì˜¤ê¸°
                    const membersResponse = await fetch(`${RENDER_SERVER_URL}/friends?employee_id=${myEmployeeId}`);
                    if (membersResponse.ok) {
                        const friendsData = await membersResponse.json();
                        // ì±„íŒ…ë°© ì œëª©ì—ì„œ ì¹œêµ¬ ì´ë¦„ ì¶”ì¶œ (ì˜ˆ: "í™ê¸¸ë™ë‹˜ê³¼ì˜ ì±„íŒ…" -> "í™ê¸¸ë™")
                        const friendName = chatTitle.replace('ë‹˜ê³¼ì˜ ì±„íŒ…', '');
                        const friend = friendsData.find(f => f.nickname === friendName);
                        if (friend) {
                            setChatMembers([friend]);
                        }
                    }
                }

                // ë©”ì‹œì§€ ë¡œë“œ
                const messagesResponse = await fetch(`${RENDER_SERVER_URL}/chat/messages/${chatType}/${chatId}`);
                const messagesData = await messagesResponse.json();
                setMessages(messagesData);
            } catch (error) {
                console.error('Error loading chat data:', error);
        }
        };

        loadChatData();
    }, [chatId, chatType]));

    // ë©”ì‹œì§€ ì „ì†¡
    const sendMessage = async () => {
        if (!newMessage.trim()) return;

        const messageText = newMessage.trim();
        setNewMessage(''); // ì¦‰ì‹œ ì…ë ¥ì°½ ë¹„ìš°ê¸°

        try {
            console.log('Sending message:', messageText);
            
            // HTTP APIë¡œ ë©”ì‹œì§€ ì „ì†¡ (WebSocket ì—°ê²° ë¬¸ì œë¡œ ì¸í•´ HTTPë§Œ ì‚¬ìš©)
            console.log('Sending via HTTP API');
            const response = await fetch(`${RENDER_SERVER_URL}/chat/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
            chat_type: chatType,
            chat_id: chatId,
            sender_employee_id: myEmployeeId,
                    message: messageText
                })
            });

            if (response.ok) {
                const responseData = await response.json();
                console.log('Message sent via HTTP:', responseData);
                
                // ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ ë°ì´í„°ë¡œ ë¡œì»¬ì— ì¶”ê°€
                const newMsg = {
                    id: responseData.id || Date.now(),
                    sender_employee_id: myEmployeeId,
                    sender_nickname: myNickname,
                    message: messageText,
                    created_at: responseData.created_at || new Date().toISOString(),
                    chat_type: chatType,
                    chat_id: chatId,
                    unread_count: 0
                };
                setMessages(prev => [...prev, newMsg]);
            } else {
                const errorData = await response.json();
                console.error('Message send failed:', errorData);
                Alert.alert('ì˜¤ë¥˜', errorData.message || 'ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                setNewMessage(messageText); // ì‹¤íŒ¨ ì‹œ ë‹¤ì‹œ ì…ë ¥ì°½ì— ë³µì›
            }
        } catch (error) {
            console.error('ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            setNewMessage(messageText); // ì‹¤íŒ¨ ì‹œ ë‹¤ì‹œ ì…ë ¥ì°½ì— ë³µì›
        }
    };

    // ë©”ì‹œì§€ ê²€ìƒ‰
    const searchMessages = async () => {
        if (!searchQuery.trim()) {
            setSearchResults([]);
            return;
        }

        try {
            setIsSearching(true);
            const response = await fetch(`${RENDER_SERVER_URL}/chat/messages/search?employee_id=${myEmployeeId}&chat_type=${chatType}&chat_id=${chatId}&query=${encodeURIComponent(searchQuery.trim())}`);
            
            // ì‘ë‹µ ìƒíƒœ í™•ì¸
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            // ì‘ë‹µ íƒ€ì… í™•ì¸
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('ì„œë²„ì—ì„œ JSONì´ ì•„ë‹Œ ì‘ë‹µì„ ë°›ì•˜ìŠµë‹ˆë‹¤.');
            }
            
            const data = await response.json();
                setSearchResults(data);
        } catch (error) {
            console.error('ë©”ì‹œì§€ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            
            // ì‚¬ìš©ìì—ê²Œ ë” ëª…í™•í•œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
            if (error.message.includes('JSON')) {
                Alert.alert('ì˜¤ë¥˜', 'ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } else if (error.message.includes('HTTP')) {
                Alert.alert('ì˜¤ë¥˜', 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
            } else {
                Alert.alert('ì˜¤ë¥˜', 'ë©”ì‹œì§€ ê²€ìƒ‰ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
            
            setSearchResults([]);
        } finally {
            setIsSearching(false);
        }
    };

    // ì±„íŒ…ë°© ë‚˜ê°€ê¸°
    const leaveChat = async () => {
        Alert.alert('ì±„íŒ…ë°© ë‚˜ê°€ê¸°', 'ì •ë§ë¡œ ì´ ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?', [
            { text: 'ì·¨ì†Œ', style: 'cancel' },
            { 
                text: 'ë‚˜ê°€ê¸°', 
                style: 'destructive', 
                onPress: async () => {
                    try {
                        const response = await fetch(`${RENDER_SERVER_URL}/chat/leave`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                employee_id: myEmployeeId,
                                chat_type: chatType,
                                chat_id: chatId
                            })
                        });
                        const data = await response.json();
                        if (response.ok) {
                            Alert.alert('ì„±ê³µ', data.message);
                            navigation.goBack();
                        } else {
                            Alert.alert('ì˜¤ë¥˜', data.message || 'ì±„íŒ…ë°©ì„ ë‚˜ê°€ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    } catch (error) {
                        console.error('ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì˜¤ë¥˜:', error);
                        Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                }
            }
        ]);
    };

    // ì ì‹¬ ì•½ì† ì¡ê¸°
    const handleLunchScheduling = async () => {
        if (chatMembers.length === 0) {
            // ì°¸ê°€ì ì •ë³´ê°€ ì—†ìœ¼ë©´ ë¨¼ì € ê°€ì ¸ì˜¤ê¸°
            try {
                const response = await fetch(`${RENDER_SERVER_URL}/chat/room/members/${chatType}/${chatId}`);
                const data = await response.json();
                if (response.ok) {
                    setChatMembers(data);
                    // ì°¸ê°€ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ í›„ ì§€ëŠ¥í˜• ìŠ¤ì¼€ì¤„ë§ í™”ë©´ìœ¼ë¡œ ì´ë™
                    navigation.navigate('IntelligentScheduling', { 
                        chatMembers: data,
                        chatType: chatType,
                        chatId: chatId
                    });
                } else {
                    Alert.alert('ì˜¤ë¥˜', data.message || 'ì°¸ê°€ì ëª©ë¡ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì°¸ê°€ì ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
                Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        } else {
            // ì°¸ê°€ì ì •ë³´ê°€ ì´ë¯¸ ìˆìœ¼ë©´ ë°”ë¡œ ì´ë™
        navigation.navigate('IntelligentScheduling', { 
            chatMembers: chatMembers,
            chatType: chatType,
            chatId: chatId
        });
        }
    };

    // ì±„íŒ…ë°© ì œëª© ë³€ê²½
    const handleTitleChange = async () => {
        if (!newTitle.trim()) {
            Alert.alert('ì˜¤ë¥˜', 'ìƒˆ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            const response = await fetch(`${RENDER_SERVER_URL}/chat/room/title`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_type: chatType,
                    chat_id: chatId,
                    title: newTitle.trim(),
                    user_id: myEmployeeId
                })
            });

            const data = await response.json();
            if (response.ok) {
                Alert.alert('ì„±ê³µ', data.message);
                setChatTitle(newTitle.trim());
                setIsTitleEditVisible(false);
                setNewTitle('');
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'ì œëª© ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ì œëª© ë³€ê²½ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    };

    // ì°¸ê°€ì ëª©ë¡ ì¡°íšŒ
    const fetchMembers = async () => {
        try {
            const response = await fetch(`${RENDER_SERVER_URL}/chat/room/members/${chatType}/${chatId}`);
            const data = await response.json();
            if (response.ok) {
                setChatMembers(data);
                setIsMembersVisible(true);
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'ì°¸ê°€ì ëª©ë¡ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ì°¸ê°€ì ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    };

    // ì´ë¯¸ì§€ ì „ì†¡
    const sendImage = async (imageUri) => {
        try {
            // ì´ë¯¸ì§€ë¥¼ base64ë¡œ ë³€í™˜
            const response = await fetch(imageUri);
            const blob = await response.blob();
            const reader = new FileReader();
            
            reader.onload = async () => {
                const base64Data = reader.result;
                
                // ì„œë²„ì— ì´ë¯¸ì§€ ì—…ë¡œë“œ
                const uploadResponse = await fetch(`${RENDER_SERVER_URL}/chat/upload-image`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_data: base64Data,
                        chat_type: chatType,
                        chat_id: chatId,
                        sender_employee_id: myEmployeeId
                    })
                });
                
                const uploadData = await uploadResponse.json();
                if (uploadResponse.ok) {
                    // WebSocketìœ¼ë¡œ ì´ë¯¸ì§€ ë©”ì‹œì§€ ì „ì†¡
                    socket.emit('send_message', {
                        chat_type: chatType,
                        chat_id: chatId,
                        sender_employee_id: myEmployeeId,
                        message: '[ì´ë¯¸ì§€]',
                        message_type: 'image',
                        file_url: uploadData.file_url
                    });
                } else {
                    Alert.alert('ì˜¤ë¥˜', uploadData.message || 'ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            };
            
            reader.readAsDataURL(blob);
        } catch (error) {
            console.error('ì´ë¯¸ì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'ì´ë¯¸ì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    };

    // ë©”ì‹œì§€ ë Œë”ë§
    const renderMessage = ({ item }) => {
        const isMyMessage = item.sender_employee_id === myEmployeeId;
        
        // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ê°€ ì•„ë‹ˆê³  ì•„ì§ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ì¸ ê²½ìš° ì½ìŒ ì²˜ë¦¬
        if (!isMyMessage && item.unread_count > 0) {
            // HTTP APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì½ìŒ ì²˜ë¦¬
            fetch(`${RENDER_SERVER_URL}/chat/messages/read`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message_id: item.id,
                    user_id: myEmployeeId,
                    chat_type: chatType,
                    chat_id: chatId
                })
            }).catch(error => {
                console.error('ì½ìŒ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
            });
        }
        
        return (
            <View style={[styles.messageContainer, isMyMessage ? styles.myMessage : styles.otherMessage]}>
                {!isMyMessage && item.sender_nickname && (
                    <Text style={styles.messageSender}>{item.sender_nickname}</Text>
                )}
                <View style={[
                    styles.messageBubble,
                    isMyMessage ? styles.myMessageBubble : styles.otherMessageBubble,
                    { backgroundColor: isMyMessage ? currentColors.primary : currentColors.surface }
                ]}>
                    {item.message_type === 'image' && item.file_url ? (
                        <TouchableOpacity
                            onPress={() => {
                                Alert.alert('ì´ë¯¸ì§€ ë³´ê¸°', 'ì´ë¯¸ì§€ í™•ëŒ€ ë³´ê¸° ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
                            }}
                        >
                            <Image
                                source={{ uri: `${RENDER_SERVER_URL}${item.file_url}` }}
                                style={{ width: 200, height: 150, borderRadius: 12, marginBottom: 4 }}
                                resizeMode="cover"
                            />
                        </TouchableOpacity>
                    ) : (
                        <Text style={[
                            styles.messageText,
                            isMyMessage ? styles.myMessageText : styles.otherMessageText,
                            isMyMessage ? { color: '#FFFFFF' } : null
                        ]}>
                            {item.message}
                        </Text>
                    )}
                </View>
                <View style={{ flexDirection: 'row', alignItems: 'center', marginTop: 2 }}>
                    <Text style={styles.messageTime}>{item.created_at}</Text>
                    {isMyMessage && item.unread_count > 0 && (
                        <Text style={{ fontSize: 12, color: '#4FC3F7', marginLeft: 4 }}>{item.unread_count}</Text>
                    )}
                </View>
            </View>
        );
    };

    if (!chatDetails) {
    return (
        <SafeAreaView style={styles.safeArea}>
                <View style={{flex: 1, justifyContent: 'center', alignItems: 'center'}}>
                    <ActivityIndicator size="large" color={currentColors.primary}/>
            </View>
            </SafeAreaView>
        );
    }

    return (
        <SafeAreaView style={styles.safeArea}>
            <KeyboardAvoidingView 
                style={{flex: 1, backgroundColor: currentColors.background}}
                behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
                keyboardVerticalOffset={Platform.OS === 'ios' ? 90 : 0}
            >
                {/* í—¤ë” ì•¡ì…˜ ë²„íŠ¼ë“¤ */}

                {/* ì‚¼ì„ (ë©”ë‰´) ì•„ì´ì½˜ì„ ëˆ„ë¥´ë©´ ì—´ë¦¬ëŠ” ë©”ë‰´ ëª¨ë‹¬ ì¶”ê°€ */}
                <Modal
                    visible={isMenuVisible}
                    transparent={true}
                    animationType="fade"
                    onRequestClose={() => setIsMenuVisible(false)}
                >
                    <TouchableOpacity style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.3)' }} activeOpacity={1} onPress={() => setIsMenuVisible(false)}>
                        <View style={{ position: 'absolute', top: 60, right: 16, backgroundColor: currentColors.surface, borderRadius: 12, padding: 12, minWidth: 160, elevation: 8 }}>
                            <TouchableOpacity style={{ paddingVertical: 12 }} onPress={() => { setIsMenuVisible(false); setIsTitleEditVisible(true); }}>
                                <Text style={{ fontSize: 16, color: currentColors.text }}>ì±„íŒ…ë°© ì œëª© ë³€ê²½</Text>
                    </TouchableOpacity>
                            <View style={{ height: 1, backgroundColor: currentColors.lightGray, marginVertical: 4 }} />
                            <TouchableOpacity style={{ paddingVertical: 12 }} onPress={() => { setIsMenuVisible(false); fetchMembers(); }}>
                                <Text style={{ fontSize: 16, color: currentColors.text }}>ì°¸ê°€ì ëª©ë¡</Text>
                            </TouchableOpacity>
                            <View style={{ height: 1, backgroundColor: currentColors.lightGray, marginVertical: 4 }} />
                            <TouchableOpacity style={{ paddingVertical: 12 }} onPress={() => { setIsMenuVisible(false); handleLunchScheduling(); }}>
                                <Text style={{ fontSize: 16, color: currentColors.text }}>ìƒˆë¡œìš´ ì•½ì† ì¡ê¸°</Text>
                    </TouchableOpacity>
                </View>
                    </TouchableOpacity>
                </Modal>

                {/* ê²€ìƒ‰ ì˜ì—­ */}
                {isSearchVisible && (
                    <View style={{
                        backgroundColor: currentColors.surface,
                        paddingHorizontal: 16,
                        paddingVertical: 12,
                        borderBottomWidth: 1,
                        borderBottomColor: currentColors.lightGray
                    }}>
                        <View style={{
                            flexDirection: 'row',
                            alignItems: 'center'
                        }}>
                            <TextInput
                                style={{
                                    flex: 1,
                                    backgroundColor: currentColors.background,
                                    borderRadius: 20,
                                    paddingHorizontal: 16,
                                    paddingVertical: 8,
                                    marginRight: 8,
                                    fontSize: 14,
                                    color: currentColors.text,
                                    borderWidth: 1,
                                    borderColor: currentColors.lightGray
                                }}
                                value={searchQuery}
                                onChangeText={setSearchQuery}
                                placeholder="ë©”ì‹œì§€ ê²€ìƒ‰..."
                                placeholderTextColor={currentColors.textSecondary}
                                onSubmitEditing={searchMessages}
                            />
                            <TouchableOpacity
                                style={{
                                    backgroundColor: currentColors.primary,
                                    borderRadius: 20,
                                    paddingHorizontal: 12,
                                    paddingVertical: 8
                                }}
                                onPress={searchMessages}
                                disabled={isSearching}
                            >
                                {isSearching ? (
                                    <ActivityIndicator size="small" color="#FFFFFF" />
                                ) : (
                                    <Ionicons name="search" size={16} color="#FFFFFF" />
                                )}
                            </TouchableOpacity>
                            <TouchableOpacity
                                style={{
                                    backgroundColor: currentColors.lightGray,
                                    borderRadius: 20,
                                    paddingHorizontal: 12,
                                    paddingVertical: 8,
                                    marginLeft: 8
                                }}
                                onPress={() => {
                                    setIsSearchVisible(false);
                                    setSearchQuery('');
                                    setSearchResults([]);
                                }}
                            >
                                <Ionicons name="close" size={16} color={currentColors.text} />
                            </TouchableOpacity>
                        </View>
                        
                        {/* ê²€ìƒ‰ ê²°ê³¼ */}
                        {searchResults.length > 0 && (
                            <View style={{marginTop: 8}}>
                                <Text style={{fontSize: 12, color: currentColors.textSecondary, marginBottom: 4}}>
                                    ê²€ìƒ‰ ê²°ê³¼: {searchResults.length}ê°œ
                                </Text>
                                <FlatList
                                    data={searchResults}
                                    keyExtractor={(item, index) => `search-${item.id}-${index}`}
                                    renderItem={renderMessage}
                                    style={{maxHeight: 200}}
                                    showsVerticalScrollIndicator={false}
                                />
                            </View>
                        )}
                    </View>
                )}

                {/* ë©”ì‹œì§€ ëª©ë¡ */}
                <FlatList
                    ref={flatListRef}
                    data={messages}
                    keyExtractor={(item, index) => `${item.id}-${index}`}
                    renderItem={renderMessage}
                    style={{flex: 1, backgroundColor: currentColors.background}}
                    contentContainerStyle={{paddingHorizontal: 16, paddingVertical: 8}}
                    onContentSizeChange={() => flatListRef.current?.scrollToEnd({ animated: true })}
                    onLayout={() => flatListRef.current?.scrollToEnd({ animated: true })}
                    onViewableItemsChanged={({ viewableItems }) => {
                        // í™”ë©´ì— ë³´ì´ëŠ” ë©”ì‹œì§€ë“¤ ì¤‘ ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ê°€ ì•„ë‹Œ ê²ƒë“¤ì„ ì½ìŒ ì²˜ë¦¬
                        const unreadMessages = viewableItems
                            .map(item => item.item)
                            .filter(msg => msg.sender_employee_id !== myEmployeeId && msg.unread_count > 0);
                        
                        unreadMessages.forEach(msg => {
                            // HTTP APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì½ìŒ ì²˜ë¦¬
                            fetch(`${RENDER_SERVER_URL}/chat/messages/read`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    message_id: msg.id,
                                    user_id: myEmployeeId,
                                    chat_type: chatType,
                                    chat_id: chatId
                                })
                            }).catch(error => {
                                console.error('ì½ìŒ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                            });
                        });
                    }}
                    viewabilityConfig={{
                        itemVisiblePercentThreshold: 50
                    }}
                />

                {/* ì œëª© ë³€ê²½ ëª¨ë‹¬ */}
                <Modal
                    visible={isTitleEditVisible}
                    transparent={true}
                    animationType="slide"
                    onRequestClose={() => setIsTitleEditVisible(false)}
                >
                    <View style={{
                        flex: 1,
                        backgroundColor: 'rgba(0, 0, 0, 0.5)',
                        justifyContent: 'center',
                        alignItems: 'center',
                        paddingHorizontal: 20
                    }}>
                        <View style={{
                            backgroundColor: currentColors.surface,
                            borderRadius: 12,
                            padding: 20,
                            width: '100%',
                            maxWidth: 300
                        }}>
                            <Text style={{
                                fontSize: 18,
                                fontWeight: 'bold',
                                color: currentColors.text,
                                marginBottom: 16,
                                textAlign: 'center'
                            }}>
                                ì±„íŒ…ë°© ì œëª© ë³€ê²½
                            </Text>
                            
                            <TextInput
                                style={{
                                    backgroundColor: currentColors.background,
                                    borderRadius: 8,
                                    paddingHorizontal: 12,
                                    paddingVertical: 8,
                                    fontSize: 16,
                                    color: currentColors.text,
                                    borderWidth: 1,
                                    borderColor: currentColors.lightGray,
                                    marginBottom: 16
                                }}
                                value={newTitle}
                                onChangeText={setNewTitle}
                                placeholder="ìƒˆ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                                placeholderTextColor={currentColors.textSecondary}
                            />
                            
                            <View style={{
                                flexDirection: 'row',
                                justifyContent: 'space-between'
                            }}>
                                <TouchableOpacity
                                    style={{
                                        backgroundColor: currentColors.lightGray,
                                        borderRadius: 8,
                                        paddingHorizontal: 16,
                                        paddingVertical: 8,
                                        flex: 1,
                                        marginRight: 8
                                    }}
                                    onPress={() => {
                                        setIsTitleEditVisible(false);
                                        setNewTitle('');
                                    }}
                                >
                                    <Text style={{
                                        color: currentColors.text,
                                        fontSize: 14,
                                        fontWeight: '600',
                                        textAlign: 'center'
                                    }}>
                                        ì·¨ì†Œ
                                    </Text>
                                </TouchableOpacity>
                                
                                <TouchableOpacity
                                    style={{
                                        backgroundColor: currentColors.primary,
                                        borderRadius: 8,
                                        paddingHorizontal: 16,
                                        paddingVertical: 8,
                                        flex: 1,
                                        marginLeft: 8
                                    }}
                                    onPress={handleTitleChange}
                                >
                                    <Text style={{
                                        color: '#FFFFFF',
                                        fontSize: 14,
                                        fontWeight: '600',
                                        textAlign: 'center'
                                    }}>
                                        ë³€ê²½
                                    </Text>
                                </TouchableOpacity>
                            </View>
                        </View>
                    </View>
                </Modal>

                {/* ì°¸ê°€ì ëª©ë¡ ëª¨ë‹¬ */}
                <Modal
                    visible={isMembersVisible}
                    transparent={true}
                    animationType="slide"
                    onRequestClose={() => setIsMembersVisible(false)}
                >
                    <View style={{
                        flex: 1,
                        backgroundColor: 'rgba(0, 0, 0, 0.5)',
                        justifyContent: 'center',
                        alignItems: 'center',
                        paddingHorizontal: 20
                    }}>
                        <View style={{
                            backgroundColor: currentColors.surface,
                            borderRadius: 12,
                            padding: 20,
                            width: '100%',
                            maxWidth: 350,
                            maxHeight: '80%'
                        }}>
                            {/* ì°¸ê°€ì ëª©ë¡ íƒ€ì´í‹€ ì¸ì›ìˆ˜ ê³„ì‚° */}
                            {(() => {
                                const leader = chatMembers.find(m => m.is_host);
                                const memberCount = (leader ? 1 : 0) + chatMembers.filter(m => !leader || m.employee_id !== leader.employee_id).length;
                                return (
                                    <Text style={{
                                        fontSize: 18,
                                        fontWeight: 'bold',
                                        color: currentColors.text,
                                        marginBottom: 16,
                                        textAlign: 'center'
                                    }}>
                                        ì°¸ê°€ì ëª©ë¡ ({memberCount}ëª…)
                                    </Text>
                                );
                            })()}
                            
                            {/* íŒŸì¥(í˜¸ìŠ¤íŠ¸)ë§Œ ë§¨ ìœ„ì— í•œ ë²ˆ í‘œì‹œ */}
                            {(() => {
                                const leader = chatMembers.find(m => m.is_host);
                                if (!leader) return null;
                                return (
                                    <View style={{
                                        flexDirection: 'row',
                                        alignItems: 'center',
                                        paddingVertical: 8,
                                        paddingHorizontal: 12,
                                        backgroundColor: currentColors.background,
                                        borderRadius: 8,
                                        marginBottom: 8
                                    }}>
                                        <View style={{
                                            width: 40,
                                            height: 40,
                                            borderRadius: 20,
                                            backgroundColor: currentColors.yellow,
                                            justifyContent: 'center',
                                            alignItems: 'center',
                                            marginRight: 12
                                        }}>
                                            <Text style={{
                                                color: currentColors.deepBlue,
                                                fontSize: 16,
                                                fontWeight: 'bold'
                                            }}>
                                                {leader.nickname ? leader.nickname.charAt(0) : '?'}
                                            </Text>
                                        </View>
                                        <View style={{ flex: 1 }}>
                                            <Text style={{
                                                fontSize: 16,
                                                fontWeight: '600',
                                                color: currentColors.text
                                            }}>
                                                {leader.nickname || 'ì•Œ ìˆ˜ ì—†ìŒ'}
                                            </Text>
                                        </View>
                                        <View style={{
                                            backgroundColor: currentColors.yellow,
                                            borderRadius: 12,
                                            paddingHorizontal: 8,
                                            paddingVertical: 4
                                        }}>
                                            <Text style={{
                                                fontSize: 10,
                                                fontWeight: 'bold',
                                                color: currentColors.deepBlue
                                            }}>
                                                íŒŸì¥
                                            </Text>
                                        </View>
                                    </View>
                                );
                            })()}
                            {/* ì¼ë°˜ ë©¤ë²„ë§Œ ë¦¬ìŠ¤íŠ¸ë¡œ í‘œì‹œ (íŒŸì¥ employee_idì™€ ë‹¤ë¥¸ ë©¤ë²„ë§Œ) */}
                            <FlatList
                                data={chatMembers.filter(m => {
                                    const leader = chatMembers.find(x => x.is_host);
                                    return !leader || m.employee_id !== leader.employee_id;
                                })}
                                keyExtractor={(item, index) => `member-${item.employee_id}-${index}`}
                                renderItem={({ item }) => (
                                    <View style={{
                                        flexDirection: 'row',
                                        alignItems: 'center',
                                        paddingVertical: 8,
                                        paddingHorizontal: 12,
                                        backgroundColor: currentColors.background,
                                        borderRadius: 8,
                                        marginBottom: 8
                                    }}>
                                        <View style={{
                                            width: 40,
                                            height: 40,
                                            borderRadius: 20,
                                            backgroundColor: currentColors.primary,
                                            justifyContent: 'center',
                                            alignItems: 'center',
                                            marginRight: 12
                                        }}>
                                            <Text style={{
                                                color: '#FFFFFF',
                                                fontSize: 16,
                                                fontWeight: 'bold'
                                            }}>
                                                {item.nickname ? item.nickname.charAt(0) : '?'}
                                            </Text>
                                        </View>
                                        <View style={{ flex: 1 }}>
                                            <Text style={{
                                                fontSize: 16,
                                                fontWeight: '600',
                                                color: currentColors.text
                                            }}>
                                                {item.nickname || 'ì•Œ ìˆ˜ ì—†ìŒ'}
                                            </Text>
                                        </View>
                                    </View>
                                )}
                                showsVerticalScrollIndicator={false}
                            />
                            
                            <TouchableOpacity
                                style={{
                                    backgroundColor: currentColors.primary,
                                    borderRadius: 8,
                                    paddingHorizontal: 16,
                                    paddingVertical: 12,
                                    marginTop: 16
                                }}
                                onPress={() => setIsMembersVisible(false)}
                            >
                                <Text style={{
                                    color: '#FFFFFF',
                                    fontSize: 16,
                                    fontWeight: '600',
                                    textAlign: 'center'
                                }}>
                                    ë‹«ê¸°
                                </Text>
                            </TouchableOpacity>
                        </View>
                    </View>
                </Modal>

                {/* ë©”ì‹œì§€ ì…ë ¥ ì˜ì—­ */}
                <View style={{
                    backgroundColor: currentColors.surface,
                    borderTopWidth: 1,
                    borderTopColor: currentColors.lightGray,
                    paddingHorizontal: 16,
                    paddingVertical: 12,
                    flexDirection: 'row',
                    alignItems: 'flex-end'
                }}>
                    <TouchableOpacity
                        style={{
                            backgroundColor: currentColors.primary,
                            borderRadius: 20,
                            width: 40,
                            height: 40,
                            justifyContent: 'center',
                            alignItems: 'center',
                            marginRight: 8
                        }}
                        onPress={() => setIsImagePickerVisible(true)}
                    >
                        <Ionicons 
                            name="camera" 
                            size={20} 
                            color="#FFFFFF" 
                        />
                    </TouchableOpacity>
                    
                    <TextInput
                        style={{
                            flex: 1,
                            backgroundColor: currentColors.background,
                            borderRadius: 20,
                            paddingHorizontal: 16,
                            paddingVertical: 10,
                            marginRight: 8,
                            fontSize: 16,
                            color: currentColors.text,
                            maxHeight: 100,
                            borderWidth: 1,
                            borderColor: currentColors.lightGray
                        }}
                        value={newMessage}
                        onChangeText={setNewMessage}
                        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                        placeholderTextColor={currentColors.textSecondary}
                        multiline
                        maxLength={500}
                    />
                    <TouchableOpacity
                        style={{
                            backgroundColor: !newMessage.trim() ? currentColors.lightGray : currentColors.primary,
                            borderRadius: 20,
                            width: 40,
                            height: 40,
                            justifyContent: 'center',
                            alignItems: 'center'
                        }}
                        onPress={sendMessage}
                        disabled={!newMessage.trim()}
                    >
                        <Ionicons 
                            name="send" 
                            size={20} 
                            color={!newMessage.trim() ? currentColors.textSecondary : '#FFFFFF'} 
                        />
                    </TouchableOpacity>
                </View>

                {/* ì—°ê²° ìƒíƒœ í‘œì‹œ (ì„ì‹œë¡œ ë¹„í™œì„±í™”) */}
                {false && !isConnected && (
                    <View style={{
                        backgroundColor: currentColors.warning,
                        paddingVertical: 8,
                        paddingHorizontal: 16,
                        alignItems: 'center'
                    }}>
                        <Text style={{color: '#FFFFFF', fontSize: 14, fontWeight: '600'}}>ì—°ê²° ì¤‘...</Text>
                    </View>
                )}

                {/* ì´ë¯¸ì§€ ì„ íƒ ëª¨ë‹¬ */}
                <Modal
                    visible={isImagePickerVisible}
                    transparent={true}
                    animationType="slide"
                    onRequestClose={() => setIsImagePickerVisible(false)}
                >
                    <View style={{
                        flex: 1,
                        backgroundColor: 'rgba(0, 0, 0, 0.5)',
                        justifyContent: 'flex-end'
                    }}>
                        <View style={{
                            backgroundColor: currentColors.surface,
                            borderTopLeftRadius: 20,
                            borderTopRightRadius: 20,
                            padding: 20
                        }}>
                            <Text style={{
                                fontSize: 18,
                                fontWeight: 'bold',
                                color: currentColors.text,
                                marginBottom: 20,
                                textAlign: 'center'
                            }}>
                                ì´ë¯¸ì§€ ì„ íƒ
                            </Text>
                            
                            <View style={{
                                flexDirection: 'row',
                                justifyContent: 'space-around',
                                marginBottom: 20
                            }}>
                                <TouchableOpacity
                                    style={{
                                        backgroundColor: currentColors.primary,
                                        borderRadius: 12,
                                        paddingVertical: 12,
                                        paddingHorizontal: 20,
                                        alignItems: 'center',
                                        flex: 1,
                                        marginRight: 10
                                    }}
                                    onPress={() => {
                                        setIsImagePickerVisible(false);
                                        // ì¹´ë©”ë¼ë¡œ ì´¬ì˜ (êµ¬í˜„ ì˜ˆì •)
                                        Alert.alert('ì¹´ë©”ë¼', 'ì¹´ë©”ë¼ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
                                    }}
                                >
                                    <Ionicons name="camera" size={24} color="#FFFFFF" />
                                    <Text style={{color: '#FFFFFF', marginTop: 4, fontSize: 12}}>ì¹´ë©”ë¼</Text>
                                </TouchableOpacity>
                                
                                <TouchableOpacity
                                    style={{
                                        backgroundColor: currentColors.primary,
                                        borderRadius: 12,
                                        paddingVertical: 12,
                                        paddingHorizontal: 20,
                                        alignItems: 'center',
                                        flex: 1,
                                        marginLeft: 10
                                    }}
                                    onPress={() => {
                                        setIsImagePickerVisible(false);
                                        // ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒ (êµ¬í˜„ ì˜ˆì •)
                                        Alert.alert('ê°¤ëŸ¬ë¦¬', 'ê°¤ëŸ¬ë¦¬ ì„ íƒ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
                                    }}
                                >
                                    <Ionicons name="images" size={24} color="#FFFFFF" />
                                    <Text style={{color: '#FFFFFF', marginTop: 4, fontSize: 12}}>ê°¤ëŸ¬ë¦¬</Text>
                                </TouchableOpacity>
                            </View>
                            
                            <TouchableOpacity
                                style={{
                                    backgroundColor: currentColors.gray,
                                    borderRadius: 12,
                                    paddingVertical: 12,
                                    alignItems: 'center'
                                }}
                                onPress={() => setIsImagePickerVisible(false)}
                            >
                                <Text style={{color: currentColors.white, fontSize: 16, fontWeight: '600'}}>ì·¨ì†Œ</Text>
                            </TouchableOpacity>
                        </View>
                    </View>
                </Modal>
            </KeyboardAvoidingView>
        </SafeAreaView>
    );
}


// --- ë‚´ ì •ë³´ íƒ­ ---
function MyProfileScreen({ navigation }) {
    const [profile, setProfile] = useState(null);
    
    useFocusEffect(useCallback(() => { fetch(`${RENDER_SERVER_URL}/users/${myEmployeeId}`).then(res => res.json()).then(setProfile); }, []));

    useEffect(() => {
        navigation.setOptions({
            headerRight: () => (
                <View style={{ flexDirection: 'row', marginRight: 15 }}>
                    <TouchableOpacity style={{ marginRight: 15 }} onPress={() => navigation.navigate('Settings')}>
                        <Ionicons name="settings-outline" size={26} color={COLORS.primary} />
                    </TouchableOpacity>
                    <TouchableOpacity onPress={() => navigation.navigate('ProfileEdit')}>
                        <Ionicons name="create-outline" size={26} color={COLORS.primary} />
                    </TouchableOpacity>
                </View>
            ),
        });
    }, [navigation]);

    if (!profile) return <View style={styles.centerView}><ActivityIndicator color={COLORS.primary} /></View>;
    
    return (
        <SafeAreaView style={styles.safeArea}>
            <ScrollView contentContainerStyle={{paddingVertical: 16}}>
                <View style={styles.profileCard}>
                    <View style={styles.profileInfoRow}><Ionicons name="person-circle-outline" size={24} color={COLORS.gray} /><Text style={styles.profileViewText}>{profile.nickname}</Text></View>
                </View>
                <View style={styles.profileCard}><Text style={styles.cardTitle}>ì ì‹¬ ì„±í–¥</Text><Text style={styles.profileViewTags}>{profile.lunch_preference || 'ë¯¸ì§€ì •'}</Text></View>
                <View style={styles.profileCard}><Text style={styles.cardTitle}>ì£¼ì¢…ëª©</Text><Text style={styles.profileViewTags}>{profile.main_dish_genre || 'ë¯¸ì§€ì •'}</Text></View>
                <View style={styles.profileCard}><Text style={styles.cardTitle}>ì•Œë ˆë¥´ê¸° ì •ë³´</Text><Text style={styles.profileViewTags}>{(profile.allergies && profile.allergies.length > 0) ? profile.allergies.join(', ') : 'ë¯¸ì§€ì •'}</Text></View>
                <View style={styles.profileCard}><Text style={styles.cardTitle}>ì„ í˜¸ ì‹œê°„ëŒ€</Text><Text style={styles.profileViewTags}>{profile.preferred_time || 'ë¯¸ì§€ì •'}</Text></View>
            </ScrollView>
        </SafeAreaView>
    );
}

function ProfileEditScreen({ navigation }) {
    const [nickname, setNickname] = useState('');
    const [lunchPreference, setLunchPreference] = useState([]);
    const [mainDishGenre, setMainDishGenre] = useState([]);
    const [allergies, setAllergies] = useState([]);
    const [preferredTime, setPreferredTime] = useState('');
    const [notificationPreferences, setNotificationPreferences] = useState([]);
    
    const [isPreferenceModalVisible, setPreferenceModalVisible] = useState(false);
    const [isGenreModalVisible, setGenreModalVisible] = useState(false);
    const [isAllergiesModalVisible, setAllergiesModalVisible] = useState(false);
    const [isTimeModalVisible, setTimeModalVisible] = useState(false);
    const [isNotificationModalVisible, setNotificationModalVisible] = useState(false);
    
    const LUNCH_PREFERENCE_OPTIONS = ['ê°€ì„±ë¹„ ì¢‹ì€ ê³³', 'ë§›ì§‘ íƒë°©', 'ê±´ê°•í•œ ì‹ì‚¬', 'ë¹ ë¥¸ ì‹ì‚¬', 'ìƒˆë¡œìš´ ë©”ë‰´ ë„ì „', 'ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜', 'í˜¼ì ì¡°ìš©íˆ', 'ë¶„ìœ„ê¸° ì¢‹ì€ ê³³'];
    const MAIN_DISH_GENRE_OPTIONS = ['í•œì‹', 'ì¤‘ì‹', 'ì¼ì‹', 'ì–‘ì‹', 'ë¶„ì‹', 'ì¹´í˜', 'íŒ¨ìŠ¤íŠ¸í‘¸ë“œ'];
    const ALLERGIES_OPTIONS = ['ì—†ìŒ', 'ê°‘ê°ë¥˜', 'ê²¬ê³¼ë¥˜', 'ìš°ìœ ', 'ê³„ë€', 'ë°€', 'ëŒ€ë‘', 'ìƒì„ '];
    const TIME_OPTIONS = ['11:30', '12:00', '12:30', '13:00', '13:30'];
    const NOTIFICATION_OPTIONS = ['ìƒˆë¡œìš´ íŒŒí‹° ì´ˆëŒ€', 'ì¹œêµ¬ ìš”ì²­', 'ì ì‹¬ ì‹œê°„ ì•Œë¦¼', 'ë§›ì§‘ ì¶”ì²œ'];

    useFocusEffect(useCallback(() => { 
        const loadUserData = async () => {
            try {
                const userResponse = await fetch(`${RENDER_SERVER_URL}/users/${myEmployeeId}`);
                const userData = await userResponse.json();
                
                setNickname(userData.nickname || ''); 
                setLunchPreference((userData.lunch_preference || '').split(',').filter(Boolean)); 
                setMainDishGenre((userData.main_dish_genre || '').split(',').filter(Boolean));
                
                const preferencesResponse = await fetch(`${RENDER_SERVER_URL}/users/${myEmployeeId}/preferences`);
                if (preferencesResponse.ok) {
                    const preferencesData = await preferencesResponse.json();
                    setAllergies(preferencesData.allergies || []);
                    setPreferredTime(preferencesData.preferredTime || '');
                    setNotificationPreferences(preferencesData.notifications || []);
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        };
        
        loadUserData();
    }, []));

    const handleSaveProfile = async () => {
        try {
            await fetch(`${RENDER_SERVER_URL}/users/${myEmployeeId}`, { 
                method: 'PUT', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ 
                    nickname, 
                    lunch_preference: lunchPreference.join(','), 
                    main_dish_genre: mainDishGenre.join(',') 
                }) 
            });
            
            await fetch(`${RENDER_SERVER_URL}/users/${myEmployeeId}/preferences`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    allergies,
                    preferredTime,
                    frequentAreas: [],
                    notifications: notificationPreferences
                })
            });
            
            Alert.alert("ì €ì¥ ì™„ë£Œ", "í”„ë¡œí•„ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
            navigation.goBack();
        } catch (error) {
            console.error('í”„ë¡œí•„ ì €ì¥ ì‹¤íŒ¨:', error);
            Alert.alert("ì˜¤ë¥˜", "í”„ë¡œí•„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    };

    return (
        <SafeAreaView style={styles.safeArea}>
            <ScrollView contentContainerStyle={styles.formContainer}>
                <Text style={styles.inputLabel}>ë‹‰ë„¤ì„</Text><TextInput style={styles.input} placeholderTextColor={COLORS.gray} value={nickname} onChangeText={setNickname} />
                <Text style={styles.inputLabel}>ì ì‹¬ ì„±í–¥ (ìµœëŒ€ 3ê°œ)</Text><TouchableOpacity style={styles.input} onPress={() => setPreferenceModalVisible(true)}><Text style={lunchPreference.length > 0 ? styles.inputText : styles.placeholderText}>{lunchPreference.length > 0 ? lunchPreference.join(', ') : "ì ì‹¬ ì„±í–¥ ì„ íƒ"}</Text></TouchableOpacity>
                <Text style={styles.inputLabel}>ì£¼ì¢…ëª© (ìµœëŒ€ 3ê°œ)</Text><TouchableOpacity style={styles.input} onPress={() => setGenreModalVisible(true)}><Text style={mainDishGenre.length > 0 ? styles.inputText : styles.placeholderText}>{mainDishGenre.length > 0 ? mainDishGenre.join(', ') : "ì£¼ì¢…ëª© ì„ íƒ"}</Text></TouchableOpacity>
                
                <Text style={styles.inputLabel}>ì•Œë ˆë¥´ê¸° ì •ë³´ (ìµœëŒ€ 3ê°œ)</Text>
                <TouchableOpacity style={styles.input} onPress={() => setAllergiesModalVisible(true)}>
                    <Text style={allergies.length > 0 ? styles.inputText : styles.placeholderText}>{allergies.length > 0 ? allergies.join(', ') : "ì•Œë ˆë¥´ê¸° ì •ë³´ ì„ íƒ"}</Text>
                </TouchableOpacity>
                
                <Text style={styles.inputLabel}>ì„ í˜¸ ì‹œê°„ëŒ€</Text>
                <TouchableOpacity style={styles.input} onPress={() => setTimeModalVisible(true)}>
                    <Text style={preferredTime ? styles.inputText : styles.placeholderText}>{preferredTime || "ì„ í˜¸ ì‹œê°„ëŒ€ ì„ íƒ"}</Text>
                </TouchableOpacity>
                
                <TouchableOpacity style={styles.submitButton} onPress={handleSaveProfile}><Text style={[styles.submitButtonText, {color: '#FFFFFF'}]}>í”„ë¡œí•„ ì €ì¥</Text></TouchableOpacity>
                <SelectionModal visible={isPreferenceModalVisible} title="ì ì‹¬ ì„±í–¥ ì„ íƒ (ìµœëŒ€ 3ê°œ)" options={LUNCH_PREFERENCE_OPTIONS} selected={lunchPreference} onSelect={setLunchPreference} onClose={() => setPreferenceModalVisible(false)} isMultiSelect={true} styles={styles} />
                <SelectionModal visible={isGenreModalVisible} title="ì£¼ì¢…ëª© ì„ íƒ (ìµœëŒ€ 3ê°œ)" options={MAIN_DISH_GENRE_OPTIONS} selected={mainDishGenre} onSelect={setMainDishGenre} onClose={() => setGenreModalVisible(false)} isMultiSelect={true} styles={styles} />
                <SelectionModal visible={isAllergiesModalVisible} title="ì•Œë ˆë¥´ê¸° ì •ë³´ ì„ íƒ (ìµœëŒ€ 3ê°œ)" options={ALLERGIES_OPTIONS} selected={allergies} onSelect={setAllergies} onClose={() => setAllergiesModalVisible(false)} isMultiSelect={true} styles={styles} />
                <SelectionModal visible={isTimeModalVisible} title="ì„ í˜¸ ì‹œê°„ëŒ€ ì„ íƒ" options={TIME_OPTIONS} selected={preferredTime} onSelect={setPreferredTime} onClose={() => setTimeModalVisible(false)} styles={styles} />
            </ScrollView>
        </SafeAreaView>
    );
}

// --- ì¹œêµ¬ ê´€ë¦¬ í™”ë©´ë“¤ ---
function FriendListScreen({ navigation }) {
    const [friends, setFriends] = useState([]);
    const [isLoading, setIsLoading] = useState(true);

    useFocusEffect(useCallback(() => {
        fetchFriends();
    }, []));

    const fetchFriends = async () => {
        try {
            setIsLoading(true);
            const response = await fetch(`${RENDER_SERVER_URL}/friends?employee_id=${myEmployeeId}`);
            const data = await response.json();
            if (response.ok) {
                setFriends(data);
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'ì¹œêµ¬ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ì¹œêµ¬ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
            setIsLoading(false);
        }
    };

    const handleUnfriend = async (friendId) => {
        Alert.alert(
            'ì¹œêµ¬ ì‚­ì œ',
            'ì •ë§ë¡œ ì´ ì¹œêµ¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
            [
                { text: 'ì·¨ì†Œ', style: 'cancel' },
                { 
                    text: 'ì‚­ì œ', 
                    style: 'destructive', 
                    onPress: async () => {
                        try {
                            const response = await fetch(`${RENDER_SERVER_URL}/friends/${myEmployeeId}/${friendId}`, {
                                method: 'DELETE'
                            });
                            const data = await response.json();
                            if (response.ok) {
                                Alert.alert('ì„±ê³µ', 'ì¹œêµ¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                fetchFriends();
                            } else {
                                Alert.alert('ì˜¤ë¥˜', data.message || 'ì¹œêµ¬ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                            }
                        } catch (error) {
                            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        }
                    }
                }
            ]
        );
    };

    if (isLoading) {
        return (
            <SafeAreaView style={styles.safeArea}>
                <View style={styles.centerView}>
                    <ActivityIndicator size="large" color={COLORS.primary} />
                </View>
            </SafeAreaView>
        );
    }

    return (
        <SafeAreaView style={styles.safeArea}>
            <FlatList
                data={friends}
                keyExtractor={(item, index) => `friend-${item.employee_id}-${index}`}
                ListEmptyComponent={<Text style={styles.noDataMessage}>ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</Text>}
                renderItem={({ item }) => (
                    <TouchableOpacity 
                        style={styles.friendItem}
                        onPress={() => navigation.navigate('FriendProfile', { friend: item })}
                    >
                        <View style={styles.friendInfo}>
                            <Text style={styles.friendName}>{item.nickname}</Text>
                            <Text style={styles.friendDepartment}>{item.department}</Text>
                        </View>
                        <TouchableOpacity
                            style={styles.unfriendButton}
                            onPress={() => handleUnfriend(item.employee_id)}
                        >
                            <Text style={styles.unfriendButtonText}>ì‚­ì œ</Text>
                        </TouchableOpacity>
                    </TouchableOpacity>
                )}
                contentContainerStyle={{paddingTop: 16}}
            />
        </SafeAreaView>
    );
}

function FriendRequestsScreen({ navigation }) {
    const [requests, setRequests] = useState([]);
    const [isLoading, setIsLoading] = useState(true);

    useFocusEffect(useCallback(() => {
        fetchRequests();
    }, []));

    const fetchRequests = async () => {
        try {
            setIsLoading(true);
            const response = await fetch(`${RENDER_SERVER_URL}/friends/requests?employee_id=${myEmployeeId}`);
            const data = await response.json();
            if (response.ok) {
                setRequests(data);
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'ì¹œêµ¬ ìš”ì²­ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ì¹œêµ¬ ìš”ì²­ ì¡°íšŒ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
            setIsLoading(false);
        }
    };

    const handleAcceptRequest = async (requestId) => {
        try {
            const response = await fetch(`${RENDER_SERVER_URL}/friends/requests/${requestId}/accept`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ employee_id: myEmployeeId })
            });
            const data = await response.json();
            if (response.ok) {
                Alert.alert('ì„±ê³µ', 'ì¹œêµ¬ ìš”ì²­ì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤.');
                fetchRequests();
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'ì¹œêµ¬ ìš”ì²­ ìˆ˜ë½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    };

    const handleRejectRequest = async (requestId) => {
        try {
            const response = await fetch(`${RENDER_SERVER_URL}/friends/requests/${requestId}/reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ employee_id: myEmployeeId })
            });
            const data = await response.json();
            if (response.ok) {
                Alert.alert('ì„±ê³µ', 'ì¹œêµ¬ ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.');
                fetchRequests();
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'ì¹œêµ¬ ìš”ì²­ ê±°ì ˆì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    };

    if (isLoading) {
        return (
            <SafeAreaView style={styles.safeArea}>
                <View style={styles.centerView}>
                    <ActivityIndicator size="large" color={COLORS.primary} />
                </View>
            </SafeAreaView>
        );
    }

    return (
        <SafeAreaView style={styles.safeArea}>
            <FlatList
                data={requests}
                keyExtractor={item => item.id.toString()}
                ListEmptyComponent={<Text style={styles.noDataMessage}>ì¹œêµ¬ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</Text>}
                renderItem={({ item }) => (
                    <View style={styles.requestItem}>
                        <View style={styles.requestInfo}>
                            <Text style={styles.requestName}>{item.sender_nickname}</Text>
                            <Text style={styles.requestDepartment}>{item.sender_department}</Text>
                            <Text style={styles.requestDate}>{item.created_at}</Text>
                        </View>
                        <View style={styles.requestActions}>
                            <TouchableOpacity
                                style={[styles.requestButton, styles.acceptButton]}
                                onPress={() => handleAcceptRequest(item.id)}
                            >
                                <Text style={styles.acceptButtonText}>ìˆ˜ë½</Text>
                            </TouchableOpacity>
                            <TouchableOpacity
                                style={[styles.requestButton, styles.rejectButton]}
                                onPress={() => handleRejectRequest(item.id)}
                            >
                                <Text style={styles.rejectButtonText}>ê±°ì ˆ</Text>
                            </TouchableOpacity>
                        </View>
                    </View>
                )}
                contentContainerStyle={{paddingTop: 16}}
            />
        </SafeAreaView>
    );
}

function SearchUsersScreen({ navigation }) {
    const [searchQuery, setSearchQuery] = useState('');
    const [searchResults, setSearchResults] = useState([]);
    const [isLoading, setIsLoading] = useState(false);

    const handleSearch = async () => {
        if (!searchQuery.trim()) return;

        try {
            setIsLoading(true);
            const response = await fetch(`${RENDER_SERVER_URL}/users/search?query=${encodeURIComponent(searchQuery.trim())}&employee_id=${myEmployeeId}`);
            const data = await response.json();
            if (response.ok) {
                setSearchResults(data);
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ì‚¬ìš©ì ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
            setIsLoading(false);
        }
    };

    const handleSendFriendRequest = async (targetEmployeeId) => {
        try {
            const response = await fetch(`${RENDER_SERVER_URL}/friends/requests`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sender_employee_id: myEmployeeId,
                    recipient_employee_id: targetEmployeeId
                })
            });
            const data = await response.json();
            if (response.ok) {
                Alert.alert('ì„±ê³µ', 'ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.');
                handleSearch(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'ì¹œêµ¬ ìš”ì²­ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    };

    return (
        <SafeAreaView style={styles.safeArea}>
            <View style={styles.searchContainer}>
                <TextInput
                    style={styles.searchInput}
                    placeholder="ì´ë¦„ ë˜ëŠ” ë¶€ì„œë¡œ ê²€ìƒ‰..."
                    placeholderTextColor={COLORS.gray}
                    value={searchQuery}
                    onChangeText={setSearchQuery}
                    onSubmitEditing={handleSearch}
                />
                <TouchableOpacity
                    style={styles.searchButton}
                    onPress={handleSearch}
                >
                    <Ionicons name="search" size={20} color={COLORS.white} />
                </TouchableOpacity>
            </View>

            {isLoading ? (
                <View style={styles.centerView}>
                    <ActivityIndicator size="large" color={COLORS.primary} />
                </View>
            ) : (
                <FlatList
                    data={searchResults}
                    keyExtractor={(item, index) => `search-${item.employee_id}-${index}`}
                    ListEmptyComponent={
                        searchQuery.trim() ? (
                            <Text style={styles.noDataMessage}>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</Text>
                        ) : (
                            <Text style={styles.noDataMessage}>ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</Text>
                        )
                    }
                    renderItem={({ item }) => (
                        <View style={styles.searchResultItem}>
                            <View style={styles.searchResultInfo}>
                                <Text style={styles.searchResultName}>{item.nickname}</Text>
                                <Text style={styles.searchResultDepartment}>{item.department}</Text>
                            </View>
                            <TouchableOpacity
                                style={[
                                    styles.addFriendButton,
                                    item.is_friend && styles.addFriendButtonDisabled,
                                    item.request_sent && styles.addFriendButtonPending
                                ]}
                                onPress={() => handleSendFriendRequest(item.employee_id)}
                                disabled={item.is_friend || item.request_sent}
                            >
                                <Text style={[
                                    styles.addFriendButtonText,
                                    item.is_friend && styles.addFriendButtonTextDisabled,
                                    item.request_sent && styles.addFriendButtonTextPending
                                ]}>
                                    {item.is_friend ? 'ì¹œêµ¬' : (item.request_sent ? 'ìš”ì²­ë¨' : 'ì¹œêµ¬ ì¶”ê°€')}
                                </Text>
                            </TouchableOpacity>
                        </View>
                    )}
                    contentContainerStyle={{paddingTop: 16}}
                />
            )}
        </SafeAreaView>
    );
}

function CreateChatRoomScreen({ navigation }) {
    const [friends, setFriends] = useState([]);
    const [selectedFriends, setSelectedFriends] = useState(new Set());
    const [chatTitle, setChatTitle] = useState('');
    const [isLoading, setIsLoading] = useState(true);

    useFocusEffect(useCallback(() => {
        fetchFriends();
    }, []));

    const fetchFriends = async () => {
        try {
            setIsLoading(true);
            const response = await fetch(`${RENDER_SERVER_URL}/friends?employee_id=${myEmployeeId}`);
            const data = await response.json();
            if (response.ok) {
                setFriends(data);
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'ì¹œêµ¬ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ì¹œêµ¬ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
            setIsLoading(false);
        }
    };

    const handleCreateChatRoom = async () => {
        if (selectedFriends.size === 0) {
            Alert.alert('ì•Œë¦¼', 'ìµœì†Œ í•œ ëª…ì˜ ì¹œêµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        if (!chatTitle.trim()) {
            Alert.alert('ì•Œë¦¼', 'ì±„íŒ…ë°© ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            const response = await fetch(`${RENDER_SERVER_URL}/chat/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: chatTitle.trim(),
                    creator_employee_id: myEmployeeId,
                    participant_employee_ids: Array.from(selectedFriends)
                })
            });
            const data = await response.json();
            if (response.ok) {
                Alert.alert('ì„±ê³µ', 'ì±„íŒ…ë°©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                navigation.navigate('ChatRoom', {
                    chatId: data.chat_id,
                    chatType: 'group',
                    chatTitle: chatTitle.trim()
                });
            } else {
                Alert.alert('ì˜¤ë¥˜', data.message || 'ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    };

    const toggleFriendSelection = (friendId) => {
        const newSelected = new Set(selectedFriends);
        if (newSelected.has(friendId)) {
            newSelected.delete(friendId);
        } else {
            newSelected.add(friendId);
        }
        setSelectedFriends(newSelected);
    };

    if (isLoading) {
        return (
            <SafeAreaView style={styles.safeArea}>
                <View style={{flex: 1, justifyContent: 'center', alignItems: 'center'}}>
                    <ActivityIndicator size="large" color={currentColors.primary} />
                </View>
            </SafeAreaView>
        );
    }

    return (
        <SafeAreaView style={styles.safeArea}>
            <ScrollView style={{flex: 1, backgroundColor: currentColors.background}} contentContainerStyle={{padding: 16}}>
                <Text style={{fontSize: 18, fontWeight: 'bold', color: currentColors.text, marginBottom: 8}}>ì±„íŒ…ë°© ì œëª© *</Text>
                <TextInput
                    style={{
                        backgroundColor: currentColors.surface,
                        borderRadius: 12,
                        paddingHorizontal: 16,
                        paddingVertical: 12,
                        fontSize: 16,
                        color: currentColors.text,
                        borderWidth: 1,
                        borderColor: currentColors.lightGray,
                        marginBottom: 24
                    }}
                    placeholder="ì±„íŒ…ë°© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                    placeholderTextColor={currentColors.textSecondary}
                    value={chatTitle}
                    onChangeText={setChatTitle}
                />

                <Text style={{fontSize: 18, fontWeight: 'bold', color: currentColors.text, marginBottom: 12}}>ì°¸ì—¬í•  ì¹œêµ¬ ì„ íƒ *</Text>
                <Text style={{fontSize: 14, color: currentColors.textSecondary, marginBottom: 8}}>
                    ì„ íƒëœ ì¹œêµ¬: {selectedFriends.size}ëª…
                </Text>
                <FlatList
                    data={friends}
                    keyExtractor={(item, index) => `create-chat-${item.employee_id}-${index}`}
                    renderItem={({ item }) => (
                        <TouchableOpacity
                            style={{
                                backgroundColor: selectedFriends.has(item.employee_id) ? currentColors.primaryLight : currentColors.surface,
                                borderRadius: 16,
                                padding: 16,
                                marginBottom: 8,
                                flexDirection: 'row',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                elevation: 1,
                                shadowColor: currentColors.primary,
                                shadowOffset: { width: 0, height: 1 },
                                shadowOpacity: 0.1,
                                shadowRadius: 2,
                                borderWidth: 1,
                                borderColor: selectedFriends.has(item.employee_id) ? currentColors.primary : currentColors.lightGray
                            }}
                            onPress={() => toggleFriendSelection(item.employee_id)}
                        >
                            <View style={{flex: 1}}>
                                <Text style={{
                                    fontSize: 16,
                                    fontWeight: 'bold',
                                    color: selectedFriends.has(item.employee_id) ? currentColors.primary : currentColors.text,
                                    marginBottom: 4
                                }}>{item.nickname}</Text>
                                <Text style={{
                                    fontSize: 14,
                                    color: selectedFriends.has(item.employee_id) ? currentColors.primary : currentColors.textSecondary
                                }}>{item.department}</Text>
                            </View>
                            {selectedFriends.has(item.employee_id) && (
                                <Ionicons name="checkmark-circle" size={24} color={currentColors.primary} />
                            )}
                        </TouchableOpacity>
                    )}
                    scrollEnabled={false}
                />

                <TouchableOpacity
                    style={{
                        backgroundColor: (selectedFriends.size === 0 || !chatTitle.trim()) ? currentColors.lightGray : currentColors.primary,
                        borderRadius: 12,
                        paddingVertical: 16,
                        paddingHorizontal: 24,
                        alignItems: 'center',
                        marginTop: 24,
                        elevation: 2,
                        shadowColor: currentColors.primary,
                        shadowOffset: { width: 0, height: 2 },
                        shadowOpacity: 0.2,
                        shadowRadius: 4
                    }}
                    onPress={handleCreateChatRoom}
                    disabled={selectedFriends.size === 0 || !chatTitle.trim()}
                >
                    <Text style={{
                        color: (selectedFriends.size === 0 || !chatTitle.trim()) ? currentColors.textSecondary : '#FFFFFF',
                        fontSize: 16,
                        fontWeight: 'bold'
                    }}>ì±„íŒ…ë°© ìƒì„±</Text>
                </TouchableOpacity>
            </ScrollView>
        </SafeAreaView>
    );
}

// --- ë‚´ë¹„ê²Œì´ì…˜ ìŠ¤íƒ ---
const commonScreenOptions = {
    headerStyle: { backgroundColor: COLORS.white, elevation: 0, shadowOpacity: 0, borderBottomWidth: 1, borderBottomColor: COLORS.lightGray },
    headerTitleStyle: { fontWeight: 'bold', color: COLORS.black },
    headerBackTitleVisible: false,
    headerTintColor: COLORS.black,
};

const HomeStack = () => <Stack.Navigator><Stack.Screen name="HomeScreen" component={HomeScreen} options={{ headerShown: false }} /></Stack.Navigator>;

const RestaurantsStack = () => (
    <Stack.Navigator screenOptions={commonScreenOptions}>
        <Stack.Screen name="RestaurantsList" component={RestaurantsScreen} options={{ title: 'ë§›ì§‘' }} />
        <Stack.Screen name="RestaurantDetail" component={RestaurantDetailScreen} options={{ title: '' }} />
        <Stack.Screen name="AddRestaurant" component={AddRestaurantScreen} options={{ title: 'ìƒˆ ë§›ì§‘ ì¶”ê°€' }} />
    </Stack.Navigator>
);

const PartiesStack = () => (
    <Stack.Navigator screenOptions={commonScreenOptions}>
        <Stack.Screen name="PartiesScreen" component={PartiesContainerScreen} options={{ title: 'íŒŒí‹°' }}/>
        <Stack.Screen name="PartyDetail" component={PartyDetailScreen} options={{ title: 'íŒŒí‹° ì •ë³´' }}/>
        <Stack.Screen name="DangolPotDetail" component={DangolPotDetailScreen} options={{ title: 'ë‹¨ê³¨íŒŒí‹° ì •ë³´' }}/>
        <Stack.Screen name="CreateParty" component={CreatePartyScreen} options={{ title: 'ìƒˆ íŒŒí‹° ë§Œë“¤ê¸°' }}/>
        <Stack.Screen name="CreateDangolPot" component={CreateDangolPotScreen} options={{ title: 'ìƒˆ ë‹¨ê³¨íŒŒí‹° ë§Œë“¤ê¸°' }}/>
        <Stack.Screen name="EditDangolPot" component={EditDangolPotScreen} options={{ title: 'ë‹¨ê³¨íŒŒí‹° ì •ë³´ ìˆ˜ì •' }} />
        <Stack.Screen name="CreatePersonalSchedule" component={CreatePersonalScheduleScreen} options={{ title: 'ê°œì¸ ì ì‹¬ ì•½ì† ì¶”ê°€' }} />
        <Stack.Screen name="EditPersonalSchedule" component={EditPersonalScheduleScreen} options={{ title: 'ê°œì¸ ì ì‹¬ ì•½ì† ìˆ˜ì •' }} />
        <Stack.Screen name="EditParty" component={EditPartyScreen} options={{ title: 'íŒŒí‹° ì •ë³´ ìˆ˜ì •' }} />
        <Stack.Screen name="SelectLunchDateScreen" component={SelectLunchDateScreen} options={{ title: 'ëœë¤ ëŸ°ì¹˜ ë‚ ì§œ ì„ íƒ' }} />
        <Stack.Screen name="RandomLunch" component={RandomLunchScreen} options={{ title: 'ëœë¤ ëŸ°ì¹˜' }} />
        <Stack.Screen name="MyProposalsScreen" component={MyProposalsScreen} options={{ title: 'ë‚´ ì œì•ˆ' }} />
        <Stack.Screen name="IntelligentScheduling" component={IntelligentSchedulingScreen} options={{ title: 'ì§€ëŠ¥í˜• ìŠ¤ì¼€ì¤„ë§' }} />
    </Stack.Navigator>
);

const CommunicationStack = () => (
    <Stack.Navigator screenOptions={commonScreenOptions}>
        <Stack.Screen name="ChatList" component={ChatListScreen} options={{ title: 'ì†Œí†µ' }}/>
        <Stack.Screen name="ChatRoom" component={ChatRoomScreen} options={({ route }) => ({ title: route.params.chatTitle })}/>
        <Stack.Screen name="CreateChatRoom" component={CreateChatRoomScreen} options={{ title: 'ì±„íŒ…ë°© ìƒì„±' }}/>
        <Stack.Screen name="FriendList" component={FriendListScreen} options={{ title: 'ì¹œêµ¬ ëª©ë¡' }}/>
        <Stack.Screen name="FriendRequests" component={FriendRequestsScreen} options={{ title: 'ì¹œêµ¬ ìš”ì²­' }}/>
        <Stack.Screen name="SearchUsers" component={SearchUsersScreen} options={{ title: 'ì‚¬ìš©ì ê²€ìƒ‰' }}/>
        <Stack.Screen name="IntelligentScheduling" component={IntelligentSchedulingScreen} options={{ title: 'ì§€ëŠ¥í˜• ìŠ¤ì¼€ì¤„ë§' }}/>
        <Stack.Screen name="Notifications" component={NotificationsScreen} options={{ title: 'ì•Œë¦¼' }}/>
        <Stack.Screen name="ReviewDetail" component={ReviewDetailScreen} options={{ title: 'ë¦¬ë·° ìƒì„¸' }}/>
    </Stack.Navigator>
);

const ProfileStack = () => (
    <Stack.Navigator screenOptions={commonScreenOptions}>
        <Stack.Screen name="MyProfile" component={MyProfileScreen} options={{ title: 'ë‚´ ì •ë³´' }}/>
        <Stack.Screen name="ProfileEdit" component={ProfileEditScreen} options={{ title: 'ë‚´ ì •ë³´ ìˆ˜ì •' }}/>
    </Stack.Navigator>
);

// --- ì˜¨ë³´ë”© í™”ë©´ ---
function OnboardingScreen({ navigation }) {
    const [currentStep, setCurrentStep] = useState(0);
    const [userPreferences, setUserPreferences] = useState({
        nickname: '',
        foodPreferences: [],
        lunchStyle: [],
        allergies: [],
        preferredTime: ''
    });
    const [nicknameError, setNicknameError] = useState('');
    const [checkingNickname, setCheckingNickname] = useState(false);
    const onboardingSteps = [
        {
            title: 'ë‹‰ë„¤ì„ ì„¤ì •',
            description: 'ì•±ì—ì„œ ì‚¬ìš©í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”',
            type: 'input',
            key: 'nickname'
        },
        {
            title: 'ì ì‹¬ ì„ í˜¸ë„ ì„¤ì •',
            description: 'ì¢‹ì•„í•˜ëŠ” ìŒì‹ ì¢…ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”',
            type: 'multiSelect',
            options: ['í•œì‹', 'ì¤‘ì‹', 'ì¼ì‹', 'ì–‘ì‹', 'ë¶„ì‹', 'ì¹´í˜', 'íŒ¨ìŠ¤íŠ¸í‘¸ë“œ'],
            key: 'foodPreferences'
        },
        {
            title: 'ì ì‹¬ ì„±í–¥',
            description: 'ë‹¹ì‹ ì˜ ì ì‹¬ ìŠ¤íƒ€ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”',
            type: 'multiSelect',
            options: ['ê°€ì„±ë¹„ ì¢‹ì€ ê³³', 'ë§›ì§‘ íƒë°©', 'ê±´ê°•í•œ ì‹ì‚¬', 'ë¹ ë¥¸ ì‹ì‚¬', 'ìƒˆë¡œìš´ ë©”ë‰´ ë„ì „', 'ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜', 'í˜¼ì ì¡°ìš©íˆ', 'ë¶„ìœ„ê¸° ì¢‹ì€ ê³³'],
            key: 'lunchStyle'
        },
        {
            title: 'ì•Œë ˆë¥´ê¸° ì •ë³´',
            description: 'ì•Œë ˆë¥´ê¸°ê°€ ìˆëŠ” ìŒì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”',
            type: 'multiSelect',
            options: ['ì—†ìŒ', 'ê°‘ê°ë¥˜', 'ê²¬ê³¼ë¥˜', 'ìš°ìœ ', 'ê³„ë€', 'ë°€', 'ëŒ€ë‘', 'ìƒì„ '],
            key: 'allergies'
        },
        {
            title: 'ì„ í˜¸ ì‹œê°„ëŒ€',
            description: 'ì£¼ë¡œ ì ì‹¬ì„ ë¨¹ëŠ” ì‹œê°„ëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”',
            type: 'singleSelect',
            options: ['11:30', '11:45', '12:00', '12:15', '12:30'],
            key: 'preferredTime'
        }
    ];
    const handleNext = async () => {
        if (onboardingSteps[currentStep].key === 'nickname') {
            // ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬
            setCheckingNickname(true);
            setNicknameError('');
            const nickname = userPreferences.nickname.trim();
            if (!nickname) {
                setNicknameError('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                setCheckingNickname(false);
                return;
            }
            try {
                const res = await fetch(`${RENDER_SERVER_URL}/users/check-nickname?nickname=${encodeURIComponent(nickname)}`);
                const data = await res.json();
                if (data.exists) {
                    setNicknameError('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    setCheckingNickname(false);
                    return;
                }
            } catch (e) {
                setNicknameError('ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                setCheckingNickname(false);
                return;
            }
            setCheckingNickname(false);
        }
        if (currentStep < onboardingSteps.length - 1) {
            setCurrentStep(currentStep + 1);
        } else {
            // ì˜¨ë³´ë”© ì™„ë£Œ, ì‚¬ìš©ì ì„¤ì • ì €ì¥
            saveUserPreferences();
            navigation.replace('MainApp');
        }
    };
    const handleBack = () => {
        if (currentStep > 0) {
            setCurrentStep(currentStep - 1);
        }
    };
    const handleOptionSelect = (option) => {
        const currentKey = onboardingSteps[currentStep].key;
        const currentStepData = onboardingSteps[currentStep];
        if (currentStepData.type === 'multiSelect') {
            setUserPreferences(prev => ({
                ...prev,
                [currentKey]: prev[currentKey].includes(option)
                    ? prev[currentKey].filter(item => item !== option)
                    : [...prev[currentKey], option]
            }));
        } else {
            setUserPreferences(prev => ({
                ...prev,
                [currentKey]: option
            }));
        }
    };
    const saveUserPreferences = async () => {
        try {
            // ì‚¬ìš©ì ê¸°ë³¸ ì •ë³´ ì €ì¥
            const userData = {
                nickname: userPreferences.nickname,
                lunch_preference: userPreferences.lunchStyle?.join(', ') || '',
                main_dish_genre: userPreferences.foodPreferences?.join(', ') || '',
                main_dish: userPreferences.foodPreferences?.join(', ') || '', // ì£¼ì¢…ëª©ìœ¼ë¡œ ìŒì‹ ì„ í˜¸ë„ ì €ì¥
            };
            await fetch(`${RENDER_SERVER_URL}/users/${myEmployeeId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });
            // ì‚¬ìš©ì ì„ í˜¸ë„ ì •ë³´ ì €ì¥
            const preferencesData = {
                foodPreferences: userPreferences.foodPreferences || [],
                allergies: userPreferences.allergies || [],
                preferredTime: userPreferences.preferredTime || '',
                frequentAreas: []
            };
            await fetch(`${RENDER_SERVER_URL}/users/${myEmployeeId}/preferences`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(preferencesData)
            });
            
            // AsyncStorageì— ì˜¨ë³´ë”© ì™„ë£Œ ìƒíƒœ ì €ì¥
            await AsyncStorage.setItem('onboardingCompleted', 'true');
            global.hasCompletedOnboarding = true;
        } catch (error) {
            console.error('ì‚¬ìš©ì ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', error);
        }
    };
    const currentStepData = onboardingSteps[currentStep];
    const selectedOptions = userPreferences[currentStepData.key] || [];
    return (
        <SafeAreaView style={{flex: 1, backgroundColor: COLORS.light.background}}>
            <View style={{padding: 20, alignItems: 'center'}}>
                <View style={{flexDirection: 'row', marginBottom: 20}}>
                    {onboardingSteps.map((_, index) => (
                        <View
                            key={index}
                            style={{
                                width: 8,
                                height: 8,
                                borderRadius: 4,
                                backgroundColor: index <= currentStep ? COLORS.light.primary : COLORS.light.lightGray,
                                marginHorizontal: 4
                            }}
                        />
                    ))}
                </View>
                <Text style={{color: COLORS.light.textSecondary, fontSize: 14}}>
                    {currentStep + 1} / {onboardingSteps.length}
                </Text>
            </View>
            <View style={{flex: 1, padding: 20}}>
                <Text style={{fontSize: 24, fontWeight: 'bold', color: COLORS.light.text, marginBottom: 10, textAlign: 'center'}}>{currentStepData.title}</Text>
                <Text style={{fontSize: 16, color: COLORS.light.textSecondary, marginBottom: 30, textAlign: 'center'}}>{currentStepData.description}</Text>
                {currentStepData.type === 'input' ? (
                    <View style={{alignItems: 'center'}}>
                        <TextInput
                            style={{
                                width: '100%',
                                borderWidth: 1,
                                borderColor: nicknameError ? COLORS.red : COLORS.light.border,
                                borderRadius: 12,
                                padding: 16,
                                fontSize: 18,
                                marginBottom: 8,
                                color: COLORS.light.text,
                                backgroundColor: '#FFFFFF'
                            }}
                            placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
                            placeholderTextColor={COLORS.light.textSecondary}
                            value={userPreferences.nickname}
                            onChangeText={text => setUserPreferences(prev => ({ ...prev, nickname: text }))}
                            editable={!checkingNickname}
                        />
                        {nicknameError ? <Text style={{color: COLORS.red, marginBottom: 8}}>{nicknameError}</Text> : null}
                    </View>
                ) : (
                    <ScrollView style={{flex: 1}} showsVerticalScrollIndicator={false}>
                        {currentStepData.options.map((option) => (
                            <TouchableOpacity
                                key={option}
                                style={{
                                    backgroundColor: selectedOptions.includes(option) ? COLORS.light.primary : COLORS.light.surface,
                                    padding: 16,
                                    borderRadius: 12,
                                    marginBottom: 10,
                                    flexDirection: 'row',
                                    justifyContent: 'space-between',
                                    alignItems: 'center',
                                    borderWidth: 1,
                                    borderColor: selectedOptions.includes(option) ? COLORS.light.primary : COLORS.light.border
                                }}
                                onPress={() => handleOptionSelect(option)}
                            >
                                <Text style={{
                                    fontSize: 16,
                                    color: selectedOptions.includes(option) ? COLORS.light.surface : COLORS.light.text
                                }}>
                                    {option}
                                </Text>
                                {selectedOptions.includes(option) && (
                                    <Ionicons name="checkmark-circle" size={20} color={COLORS.light.surface} />
                                )}
                            </TouchableOpacity>
                        ))}
                    </ScrollView>
                )}
            </View>
            <View style={{flexDirection: 'row', justifyContent: 'space-between', padding: 20, backgroundColor: COLORS.light.surface}}>
                {currentStep > 0 && (
                    <TouchableOpacity style={{padding: 12, borderRadius: 8, borderWidth: 1, borderColor: COLORS.light.border}} onPress={handleBack}>
                        <Text style={{fontSize: 16, color: COLORS.light.textSecondary}}>ì´ì „</Text>
                    </TouchableOpacity>
                )}
                <TouchableOpacity style={{padding: 12, borderRadius: 8, backgroundColor: COLORS.light.primary, flex: 1, marginLeft: currentStep > 0 ? 12 : 0, alignItems: 'center'}} onPress={handleNext} disabled={checkingNickname}>
                    <Text style={{fontSize: 16, color: COLORS.light.surface, fontWeight: 'bold'}}>{currentStep === onboardingSteps.length - 1 ? 'ì™„ë£Œ' : 'ë‹¤ìŒ'}</Text>
                </TouchableOpacity>
            </View>
        </SafeAreaView>
    );
}

// --- ì•Œë¦¼ í™”ë©´ ---
function NotificationsScreen({ navigation }) {
    const [notifications, setNotifications] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        fetchNotifications();
    }, []);

    const fetchNotifications = async () => {
        try {
            setLoading(true);
            const response = await fetch(`${API_BASE_URL}/notifications/${myEmployeeId}`);
            if (response.ok) {
                const data = await response.json();
                setNotifications(data);
            } else {
                // ì„œë²„ ì‘ë‹µì´ ì—†ì„ ë•ŒëŠ” ëª©ì—… ë°ì´í„° ì‚¬ìš©
                const mockNotifications = [
                    {
                        id: 1,
                        type: 'party_invite',
                        title: 'ìƒˆë¡œìš´ íŒŒí‹° ì´ˆëŒ€',
                        message: 'ìƒˆë¡œìš´ íŒŒí‹°ì— ì´ˆëŒ€ë˜ì—ˆìŠµë‹ˆë‹¤',
                        data: { partyId: 1, partyTitle: 'ì ì‹¬ ëª¨ì„' },
                        timestamp: new Date(Date.now() - 1000 * 60 * 30), // 30ë¶„ ì „
                        read: false
                    },
                    {
                        id: 2,
                        type: 'friend_request',
                        title: 'ì¹œêµ¬ ìš”ì²­',
                        message: 'ìƒˆë¡œìš´ ì¹œêµ¬ ìš”ì²­ì´ ìˆìŠµë‹ˆë‹¤',
                        data: { requesterId: 'USER002', requesterName: 'ê¹€ì² ìˆ˜' },
                        timestamp: new Date(Date.now() - 1000 * 60 * 60 * 2), // 2ì‹œê°„ ì „
                        read: true
                    }
                ];
                setNotifications(mockNotifications);
            }
        } catch (error) {
            console.error('ì•Œë¦¼ ì¡°íšŒ ì‹¤íŒ¨:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleNotificationPress = (notification) => {
        // ì•Œë¦¼ íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥¸ í™”ë©´ìœ¼ë¡œ ì´ë™
        switch (notification.type) {
            case 'party_invite':
                navigation.navigate('íŒŒí‹°', { screen: 'PartyDetail', params: { partyId: notification.data.partyId } });
                break;
            case 'friend_request':
                navigation.navigate('ë‚´ ì •ë³´', { screen: 'FriendRequests' });
                break;
            case 'lunch_reminder':
                navigation.navigate('í™ˆ');
                break;
            default:
                break;
        }
    };

    const renderNotificationItem = ({ item }) => (
        <TouchableOpacity 
            style={[
                styles.notificationItem,
                !item.read && styles.unreadNotification
            ]}
            onPress={() => handleNotificationPress(item)}
        >
            <View style={styles.notificationIcon}>
                {item.type === 'party_invite' && <Ionicons name="people" size={20} color={currentColors.primary} />}
                {item.type === 'friend_request' && <Ionicons name="person-add" size={20} color={currentColors.secondary} />}
                {item.type === 'lunch_reminder' && <Ionicons name="restaurant" size={20} color={currentColors.accent} />}
            </View>
            <View style={styles.notificationContent}>
                <Text style={styles.notificationMessage}>{item.message}</Text>
                <Text style={styles.notificationTime}>
                    {new Date(item.timestamp).toLocaleString('ko-KR')}
                </Text>
            </View>
            {!item.read && <View style={styles.unreadDot} />}
        </TouchableOpacity>
    );

    return (
        <SafeAreaView style={styles.safeArea}>
            <View style={styles.header}>
                <Text style={styles.headerTitle}>ì•Œë¦¼</Text>
                <TouchableOpacity onPress={() => setNotifications([])}>
                    <Text style={styles.clearButton}>ëª¨ë‘ ì§€ìš°ê¸°</Text>
                </TouchableOpacity>
            </View>
            
            {loading ? (
                <ActivityIndicator size="large" style={{marginTop: 20}} color={currentColors.primary} />
            ) : (
                <FlatList
                    data={notifications}
                    keyExtractor={item => item.id.toString()}
                    renderItem={renderNotificationItem}
                    ListEmptyComponent={
                        <View style={styles.emptyContainer}>
                            <Ionicons name="notifications-off" size={64} color={currentColors.gray} />
                            <Text style={styles.emptyText}>ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</Text>
                        </View>
                    }
                    contentContainerStyle={{paddingTop: 16}}
                />
            )}
        </SafeAreaView>
    );
}

// --- ë¦¬ë·° ìƒì„¸ í™”ë©´ ---
function ReviewDetailScreen({ route, navigation }) {
    const { review } = route.params;
    const [likes, setLikes] = useState(review.likes || 0);
    const [hasLiked, setHasLiked] = useState(false);

    const handleLike = async () => {
        try {
            const response = await fetch(`${API_BASE_URL}/reviews/${review.id}/like`, {
                method: 'POST'
            });
            const data = await response.json();
            setLikes(data.likes);
            setHasLiked(true);
        } catch (error) {
            console.error('ì¢‹ì•„ìš” ì‹¤íŒ¨:', error);
        }
    };

    return (
        <SafeAreaView style={styles.container}>
            <View style={styles.header}>
                <TouchableOpacity onPress={() => navigation.goBack()}>
                    <Ionicons name="arrow-back" size={24} color={currentColors.text} />
                </TouchableOpacity>
                <Text style={styles.headerTitle}>ë¦¬ë·° ìƒì„¸</Text>
                <View style={{width: 24}} />
            </View>
            
            <ScrollView style={styles.reviewDetailContainer}>
                <View style={styles.reviewDetailCard}>
                    <View style={styles.reviewHeader}>
                        <Text style={styles.reviewAuthor}>{review.nickname}</Text>
                        <View style={styles.ratingContainer}>
                            {[1, 2, 3, 4, 5].map(star => (
                                <Ionicons
                                    key={star}
                                    name={star <= review.rating ? "star" : "star-outline"}
                                    size={16}
                                    color={star <= review.rating ? currentColors.yellow : currentColors.gray}
                                />
                            ))}
                        </View>
                    </View>
                    
                    {review.photo_url && (
                        <View style={styles.reviewPhotoContainer}>
                            <Image
                                source={{ uri: review.photo_url }}
                                style={styles.reviewPhoto}
                                resizeMode="cover"
                            />
                        </View>
                    )}
                    
                    {review.tags && (
                        <View style={styles.tagsContainer}>
                            {review.tags.split(',').map((tag, index) => (
                                <View key={index} style={styles.tagItem}>
                                    <Text style={styles.tagText}>{tag.trim()}</Text>
                                </View>
                            ))}
                        </View>
                    )}
                    
                    {review.comment && (
                        <Text style={styles.reviewComment}>{review.comment}</Text>
                    )}
                    
                    <View style={styles.reviewActions}>
                        <TouchableOpacity
                            style={[styles.likeButton, hasLiked && styles.likedButton]}
                            onPress={handleLike}
                            disabled={hasLiked}
                        >
                            <Ionicons
                                name={hasLiked ? "heart" : "heart-outline"}
                                size={20}
                                color={hasLiked ? currentColors.red : currentColors.gray}
                            />
                            <Text style={[styles.likeCount, hasLiked && styles.likedText]}>
                                {likes}
                            </Text>
                        </TouchableOpacity>
                    </View>
                </View>
            </ScrollView>
        </SafeAreaView>
    );
}

// --- ì§€ëŠ¥í˜• ìŠ¤ì¼€ì¤„ë§ í™”ë©´ ---
function IntelligentSchedulingScreen({ navigation, route }) {
    const { chatMembers, chatType, chatId } = route.params || {};
    const [selectedFriends, setSelectedFriends] = useState([]);
    const [friends, setFriends] = useState([]);
    const [suggestedDates, setSuggestedDates] = useState([]);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if (chatMembers && chatMembers.length > 0) {
            // ì±„íŒ…ë°©ì—ì„œ ì „ë‹¬ë°›ì€ ì°¸ê°€ì ì •ë³´ ì‚¬ìš©
            setFriends(chatMembers);
            setSelectedFriends(chatMembers.map(member => member.employee_id));
        } else {
            // ì¼ë°˜ì ì¸ ê²½ìš° ì¹œêµ¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            fetchFriends();
        }
    }, [chatMembers]);

    const fetchFriends = async () => {
        try {
            const response = await fetch(`${RENDER_SERVER_URL}/friends?employee_id=${myEmployeeId}`);
            if (response.ok) {
                const data = await response.json();
                setFriends(data);
            }
        } catch (error) {
            console.error('ì¹œêµ¬ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
        }
    };

    const handleFriendToggle = (friendId) => {
        setSelectedFriends(prev => 
            prev.includes(friendId) 
                ? prev.filter(id => id !== friendId)
                : [...prev, friendId]
        );
    };

    const handleSuggestDates = async () => {
        if (selectedFriends.length < 1) {
            Alert.alert('ì¹œêµ¬ ì„ íƒ', 'ìµœì†Œ 1ëª…ì˜ ì¹œêµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

        setLoading(true);
        try {
            console.log('ì„ íƒëœ ì°¸ê°€ìë“¤:', selectedFriends);
            
            const response = await fetch(`${RENDER_SERVER_URL}/intelligent/suggest-dates`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    participant_ids: selectedFriends
                })
    });

            if (response.ok) {
    const data = await response.json();
                console.log('ë‚ ì§œ ì œì•ˆ ê²°ê³¼:', data);
                setSuggestedDates(data);
                
                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                if (data.type === 'common' && data.dates && data.dates.length > 0) {
                    Alert.alert('ì„±ê³µ', `${data.dates.length}ê°œì˜ ê³µí†µ ê°€ëŠ¥ ë‚ ì§œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤!`);
                } else if (data.type === 'alternative') {
                    Alert.alert('ì•Œë¦¼', 'ì™„ì „íˆ ê³µí†µëœ ë‚ ì§œëŠ” ì—†ì§€ë§Œ, ëŒ€ì•ˆì„ ì œì‹œí•©ë‹ˆë‹¤.');
                }
            } else {
                const errorData = await response.json();
                console.error('ì„œë²„ ì˜¤ë¥˜:', errorData);
                Alert.alert('ì˜¤ë¥˜', errorData.message || 'ë‚ ì§œ ì œì•ˆì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            
        } catch (error) {
            console.error('ë‚ ì§œ ì œì•ˆ ì‹¤íŒ¨:', error);
            Alert.alert('ì˜¤ë¥˜', 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
            setLoading(false);
        }
    };

    const renderFriendItem = ({ item }) => (
        <TouchableOpacity 
            style={{
                flexDirection: 'row',
                alignItems: 'center',
                paddingVertical: 12,
                paddingHorizontal: 16,
                backgroundColor: selectedFriends.includes(item.employee_id) ? currentColors.primaryLight : 'transparent',
                borderRadius: 12,
                marginBottom: 8,
                borderWidth: 1,
                borderColor: selectedFriends.includes(item.employee_id) ? currentColors.primary : currentColors.lightGray
            }}
            onPress={() => handleFriendToggle(item.employee_id)}
        >
            <View style={{flex: 1}}>
                <Text style={{
                    fontSize: 16,
                    fontWeight: 'bold',
                    color: currentColors.text,
                    marginBottom: 4
                }}>
                    {item.nickname}
                    {item.is_host && (
                        <Text style={{
                            fontSize: 12,
                            color: currentColors.primary,
                            marginLeft: 8
                        }}>
                            (íŒŸì¥)
                        </Text>
                    )}
                </Text>
                <Text style={{
                    fontSize: 14,
                    color: currentColors.textSecondary
                }}>
                    {item.lunch_preference || 'ì„ í˜¸ë„ ì •ë³´ ì—†ìŒ'}
                </Text>
            </View>
            {selectedFriends.includes(item.employee_id) && (
                <Ionicons name="checkmark-circle" size={24} color={currentColors.primary} />
            )}
        </TouchableOpacity>
    );

    const renderDateItem = ({ item }) => (
        <View style={{
            backgroundColor: currentColors.primaryLight,
            borderRadius: 12,
            padding: 16,
            marginBottom: 8,
            borderWidth: 1,
            borderColor: currentColors.primary
        }}>
            <Text style={{
                fontSize: 16,
                fontWeight: 'bold',
                color: currentColors.primary,
                marginBottom: 4
            }}>
                {item.date}
            </Text>
            <Text style={{
                fontSize: 14,
                color: currentColors.textSecondary
            }}>
                {item.available_participants?.length || 0}ëª… ê°€ëŠ¥
            </Text>
            {item.unavailable_participants && item.unavailable_participants.length > 0 && (
                <Text style={{
                    fontSize: 12,
                    color: currentColors.red,
                    marginTop: 4
                }}>
                    {item.unavailable_participants.length}ëª… ë¶ˆê°€
                </Text>
            )}
        </View>
    );

    return (
        <SafeAreaView style={{flex: 1, backgroundColor: currentColors.background}}>
            <ScrollView 
                style={{flex: 1}} 
                contentContainerStyle={{paddingHorizontal: 16, paddingBottom: 20}}
                showsVerticalScrollIndicator={true}
            >
                <View style={{marginTop: 20, marginBottom: 24}}>
                    <Text style={{
                        fontSize: 24,
                        fontWeight: 'bold',
                        color: currentColors.text,
                        marginBottom: 8
                    }}>
                        {chatMembers ? 'ì§€ëŠ¥í˜• ì•½ì† ì¡ê¸°' : 'ì¹œêµ¬ ì„ íƒ'}
                    </Text>
                    <Text style={{
                        fontSize: 16,
                        color: currentColors.textSecondary,
                        lineHeight: 22
                    }}>
                        {chatMembers 
                            ? 'ì±„íŒ…ë°© ì°¸ê°€ìë“¤ê³¼ í•¨ê»˜ ì ì‹¬ì„ ë¨¹ì„ ìˆ˜ ìˆëŠ” ë‚ ì§œë¥¼ ì°¾ì•„ë³´ì„¸ìš”.'
                            : 'í•¨ê»˜ ì ì‹¬ì„ ë¨¹ì„ ì¹œêµ¬ë“¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'
                        }
                    </Text>
                </View>

                <View style={{
                    backgroundColor: currentColors.surface,
                    borderRadius: 16,
                    padding: 20,
                    marginBottom: 20,
                    shadowColor: '#000',
                    shadowOffset: { width: 0, height: 2 },
                    shadowOpacity: 0.1,
                    shadowRadius: 8,
                    elevation: 4
                }}>
                    <Text style={{
                        fontSize: 18,
                        fontWeight: 'bold',
                        color: currentColors.text,
                        marginBottom: 16
                    }}>
                        {chatMembers ? 'ì±„íŒ…ë°© ì°¸ê°€ì' : 'ì¹œêµ¬ ëª©ë¡'}
                    </Text>
                    <FlatList
                        data={friends}
                        renderItem={renderFriendItem}
                        keyExtractor={(item, index) => `intelligent-${item.employee_id}-${index}`}
                        scrollEnabled={false}
                        showsVerticalScrollIndicator={false}
                    />
                </View>

                <TouchableOpacity 
                    style={{
                        backgroundColor: selectedFriends.length === 0 ? currentColors.disabled : currentColors.primary,
                        borderRadius: 16,
                        paddingVertical: 16,
                        paddingHorizontal: 24,
                        alignItems: 'center',
                        marginBottom: 20,
                        shadowColor: currentColors.primary,
                        shadowOffset: { width: 0, height: 4 },
                        shadowOpacity: 0.3,
                        shadowRadius: 8,
                        elevation: 6
                    }}
                    onPress={handleSuggestDates}
                    disabled={selectedFriends.length === 0 || loading}
                >
                    <Text style={{
                        fontSize: 18,
                        fontWeight: 'bold',
                        color: '#FFFFFF'
                    }}>
                        {loading ? 'ë¶„ì„ ì¤‘...' : (chatMembers ? 'ì ì‹¬ ì•½ì† ì¡ê¸°' : 'ê³µí†µ ê°€ëŠ¥ ë‚ ì§œ ì°¾ê¸°')}
                    </Text>
                </TouchableOpacity>

                {suggestedDates && suggestedDates.type && (
                    <View style={{
                        backgroundColor: currentColors.surface,
                        borderRadius: 16,
                        padding: 20,
                        shadowColor: '#000',
                        shadowOffset: { width: 0, height: 2 },
                        shadowOpacity: 0.1,
                        shadowRadius: 8,
                        elevation: 4
                    }}>
                        <Text style={{
                            fontSize: 18,
                            fontWeight: 'bold',
                            color: currentColors.text,
                            marginBottom: 16
                        }}>
                            ì œì•ˆëœ ë‚ ì§œ
                        </Text>
                        {suggestedDates.type === 'common' && suggestedDates.dates ? (
                            <FlatList
                                data={suggestedDates.dates}
                                renderItem={renderDateItem}
                                keyExtractor={item => item.date}
                                scrollEnabled={false}
                                showsVerticalScrollIndicator={false}
                            />
                        ) : suggestedDates.type === 'alternative' && suggestedDates.best_alternative ? (
                            <View style={{
                                backgroundColor: currentColors.primaryLight,
                                borderRadius: 12,
                                padding: 16,
                                alignItems: 'center'
                            }}>
                                <Text style={{
                                    fontSize: 16,
                                    fontWeight: 'bold',
                                    color: currentColors.primary,
                                    marginBottom: 8
                                }}>
                                    ê³µí†µ ê°€ëŠ¥ ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤
                                </Text>
                                <Text style={{
                                    fontSize: 14,
                                    color: currentColors.textSecondary,
                                    textAlign: 'center'
                                }}>
                                    ëŒ€ì•ˆ: {suggestedDates.best_alternative.date} 
                                    ({suggestedDates.best_alternative.available_count}ëª… ê°€ëŠ¥)
                                </Text>
                            </View>
                        ) : (
                            <Text style={{
                                fontSize: 14,
                                color: currentColors.textSecondary,
                                textAlign: 'center'
                            }}>
                                ë‚ ì§œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                            </Text>
                        )}
                    </View>
                )}
            </ScrollView>
        </SafeAreaView>
    );
}

// --- ë©”ì¸ ì•± ---
export default function App() {
  // ì „ì—­ ë³€ìˆ˜ë¥¼ ë¨¼ì € ì„¤ì • (ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´)
  global.currentColors = COLORS.light;
  global.colors = COLORS.light;
  global.styles = createStyles(COLORS.light);
  global.isDarkMode = false;
  
  const [hasCompletedOnboarding, setHasCompletedOnboarding] = useState(false);
  const [showOnboarding, setShowOnboarding] = useState(true);
  const [notifications, setNotifications] = useState([]);
  const [unreadCount, setUnreadCount] = useState(0);
  const [isDarkMode, setIsDarkMode] = useState(false);

  const colors = isDarkMode ? COLORS.dark : COLORS.light;
  const styles = createStyles(colors);
  
  // ì „ì—­ ë³€ìˆ˜ë¥¼ í˜„ì¬ ìƒ‰ìƒìœ¼ë¡œ ì—…ë°ì´íŠ¸
  global.currentColors = colors;
  global.colors = colors;
  global.styles = styles;
  global.isDarkMode = isDarkMode;

  useEffect(() => {
    // AsyncStorageì—ì„œ ì˜¨ë³´ë”© ì™„ë£Œ ì—¬ë¶€ í™•ì¸
    const checkOnboardingStatus = async () => {
      try {
        const onboardingCompleted = await AsyncStorage.getItem('onboardingCompleted');
        if (onboardingCompleted === 'true' || global.hasCompletedOnboarding) {
          setHasCompletedOnboarding(true);
          setShowOnboarding(false);
        }
      } catch (error) {
        console.error('ì˜¨ë³´ë”© ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
      }
    };
    
    checkOnboardingStatus();
  }, []);

  const handleOnboardingComplete = () => {
    setHasCompletedOnboarding(true);
    setShowOnboarding(false);
  };

  if (showOnboarding && !hasCompletedOnboarding) {
    return <OnboardingScreen navigation={{ replace: handleOnboardingComplete }} />;
  }

  return (
    <NavigationContainer>
      <Tab.Navigator screenOptions={({ route }) => ({
          tabBarIcon: ({ focused, color, size }) => {
            const icons = { 'í™ˆ': 'home', 'ë§›ì§‘': 'restaurant', 'íŒŒí‹°': 'people', 'ì†Œí†µ': 'chatbubbles', 'ë‚´ ì •ë³´': 'person' };
            const iconName = focused ? icons[route.name] : `${icons[route.name]}-outline`;
            return <Ionicons name={iconName} size={size} color={color} />;
          },
          tabBarActiveTintColor: colors.primary,
          tabBarInactiveTintColor: colors.gray,
          headerShown: false,
          tabBarStyle: { 
              backgroundColor: colors.surface, 
              borderTopColor: colors.lightGray,
              height: 85,
              paddingBottom: 18,
              paddingTop: 10,
              elevation: 8,
              shadowColor: colors.primary,
              shadowOffset: { width: 0, height: -2 },
              shadowOpacity: 0.1,
              shadowRadius: 4
          },
          tabBarLabelStyle: { fontWeight: '600', fontSize: 12, marginTop: 2 },
          tabBarIconStyle: { marginBottom: 4 }
      })}>
        <Tab.Screen name="í™ˆ" component={HomeStack} />
        <Tab.Screen name="ë§›ì§‘" component={RestaurantsStack} />
        <Tab.Screen name="íŒŒí‹°" component={PartiesStack} />
        <Tab.Screen name="ì†Œí†µ" component={CommunicationStack} />
        <Tab.Screen name="ë‚´ ì •ë³´" component={ProfileStack} />
      </Tab.Navigator>
    </NavigationContainer>
  );
}

// --- ìŠ¤íƒ€ì¼ì‹œíŠ¸ ---
const createStyles = (colors) => StyleSheet.create({
    safeArea: { flex: 1, backgroundColor: colors.background },
    centerView: { flex: 1, justifyContent: 'center', alignItems: 'center', padding: 20, backgroundColor: colors.background },
    header: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', paddingHorizontal: 16, paddingTop: 10, paddingBottom: 10, backgroundColor: colors.background },
    headerTitle: { fontSize: 32, fontWeight: 'bold', color: colors.primary, textAlign: 'center', width: '100%', letterSpacing: 1 },
    card: { 
        backgroundColor: colors.surface, 
        borderRadius: 20, 
        padding: 20, 
        marginHorizontal: 16, 
        marginBottom: 16, 
        elevation: 3, 
        shadowColor: colors.primary,
        shadowOffset: { width: 0, height: 4 }, 
        shadowOpacity: 0.1, 
        shadowRadius: 8,
        borderWidth: 1,
        borderColor: 'rgba(59, 130, 246, 0.1)'
    },
    profileCard: { 
        backgroundColor: colors.surface, 
        borderRadius: 20, 
        padding: 20, 
        marginHorizontal: 16, 
        marginBottom: 16, 
        elevation: 3, 
        shadowColor: colors.primary,
        shadowOffset: { width: 0, height: 4 }, 
        shadowOpacity: 0.1, 
        shadowRadius: 8 
    },
    cardTitle: { fontSize: 20, fontWeight: 'bold', marginBottom: 12, color: colors.primary },
    homeContainer: { paddingBottom: 20 },
    menuText: { fontSize: 16, color: colors.textSecondary, lineHeight: 24 },
    countdownText: { fontSize: 14, fontWeight: 'bold', color: colors.primaryLight, marginTop: 8 },
    appointmentCard: { 
        backgroundColor: colors.surface, 
        borderRadius: 16, 
        padding: 20, 
        marginHorizontal: 6, 
        width: SCREEN_WIDTH * 0.5, 
        height: 160, 
        borderWidth: 2, 
        borderColor: colors.lightGray, 
        justifyContent: 'flex-start',
        elevation: 2,
        shadowColor: colors.primary,
        shadowOffset: { width: 0, height: 2 }, 
        shadowOpacity: 0.1, 
        shadowRadius: 4
    },
    appointmentDate: { fontWeight: 'bold', marginBottom: 8, color: colors.primary, fontSize: 18 },
    eventItem: { marginTop: 5 },
    eventTitle: { fontWeight: '600', fontSize: 16, color: colors.text },
    eventDetail: { fontSize: 13.5, color: colors.textSecondary, marginTop: 2 },
    noAppointmentText: { fontSize: 14, color: colors.textSecondary, textAlign: 'center' },
    centeredView: { flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: 'rgba(0,0,0,0.6)' },
    modalView: { 
        margin: 20, 
        backgroundColor: 'white', 
        borderRadius: 24, 
        padding: 30, 
        alignItems: 'center', 
        width: '90%', 
        shadowColor: '#000', 
        shadowOffset: { width: 0, height: 8 }, 
        shadowOpacity: 0.3, 
        shadowRadius: 12, 
        elevation: 8 
    },
    modalTitle: { fontSize: 22, fontWeight: 'bold', marginBottom: 24, textAlign: 'center', color: colors.primary, letterSpacing: 0.5 },
    modalHeader: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', width: '100%', marginBottom: 20 },
    modalDetailCard: { 
        backgroundColor: colors.background, 
        borderRadius: 16, 
        padding: 18, 
        marginBottom: 12, 
        width: '100%',
        borderWidth: 1,
        borderColor: 'rgba(59, 130, 246, 0.2)'
    },
    modalDetailText: { fontSize: 15, color: colors.text, lineHeight: 22, marginTop: 4 },
    button: { 
        borderRadius: 16, 
        padding: 16, 
        elevation: 3, 
        width: '100%', 
        marginTop: 12,
        shadowColor: colors.primary,
        shadowOffset: { width: 0, height: 2 }, 
        shadowOpacity: 0.2, 
        shadowRadius: 4
    },
    buttonClose: { backgroundColor: colors.lightGray },
    textStyle: { color: colors.surface, fontWeight: 'bold', textAlign: 'center', fontSize: 16 },
    textStyleBlack: { color: colors.text, fontWeight: 'bold', textAlign: 'center', fontSize: 16 },
    formContainer: { padding: 20 },
    inputLabel: { fontSize: 16, fontWeight: '600', color: colors.textSecondary, marginBottom: 8, marginLeft: 4 },
    input: { 
        backgroundColor: colors.surface, 
        borderRadius: 16, 
        padding: 16, 
        marginBottom: 20, 
        fontSize: 16, 
        borderWidth: 2, 
        borderColor: colors.lightGray, 
        color: colors.text 
    },
    inputText: { color: colors.text, fontSize: 16 },
    placeholderText: { color: colors.textSecondary, fontSize: 16 },
    submitButton: { 
        backgroundColor: colors.primary, 
        padding: 16, 
        borderRadius: 16, 
        alignItems: 'center', 
        marginTop: 12,
        shadowColor: colors.primary,
        shadowOffset: { width: 0, height: 4 }, 
        shadowOpacity: 0.3, 
        shadowRadius: 8
    },
    submitButtonText: { color: colors.surface, fontWeight: 'bold', fontSize: 16 },
    searchSortContainer: { backgroundColor: colors.surface, paddingBottom: 10, borderBottomWidth: 1, borderBottomColor: colors.lightGray },
    searchInput: { backgroundColor: colors.background, borderRadius: 16, padding: 14, marginHorizontal: 16, marginTop: 10, fontSize: 16 },
    sortContainer: { flexDirection: 'row', justifyContent: 'space-around', paddingHorizontal: 16, marginTop: 15 },
    sortButton: { flexDirection: 'row', alignItems: 'center', paddingVertical: 10, paddingHorizontal: 14, backgroundColor: colors.background, borderRadius: 24 },
    sortButtonActive: { backgroundColor: colors.primaryLight },
    sortButtonText: { color: colors.text, fontWeight: '600' },
    sortButtonTextActive: { color: colors.primary, fontWeight: 'bold' },
    restaurantName: { fontSize: 18, fontWeight: 'bold' },
    restaurantCategory: { color: colors.textSecondary, marginBottom: 5 },
    restaurantInfo: { flexDirection: 'row', justifyContent: 'flex-end', alignItems: 'center', marginTop: 5 },
    restaurantRating: { color: colors.primary, fontWeight: 'bold', marginRight: 10 },
    restaurantReviews: { color: colors.textSecondary },
    infoCard: { backgroundColor: colors.surface, padding: 20, margin: 16, borderRadius: 20 },
    infoCardTitle: { fontSize: 22, fontWeight: 'bold', color: colors.black, marginBottom: 8, width: '80%' },
    infoCardAddress: { fontSize: 16, color: COLORS.gray, marginBottom: 12 },
    keywordContainer: { flexDirection: 'row', flexWrap: 'wrap', marginTop: 5 },
    keywordChip: { backgroundColor: COLORS.primaryLight, borderRadius: 20, paddingVertical: 8, paddingHorizontal: 14, marginRight: 8, marginBottom: 8 },
    keywordText: { color: COLORS.primary, fontWeight: 'bold' },
    createPartyButton: { padding: 16, borderRadius: 16, marginHorizontal: 16, marginBottom: 10, alignItems: 'center' },
    createPartyButtonText: { color: 'white', fontWeight: 'bold', fontSize: 16, textAlign: 'center' },
    reviewInputContainer: { padding: 16, backgroundColor: 'white', marginHorizontal:16, borderRadius: 20 },
    starContainer: { flexDirection: 'row', marginBottom: 15, justifyContent: 'space-around' },
    reviewCard: { backgroundColor: 'white', padding: 16, marginHorizontal: 16, marginVertical: 6, borderRadius: 16 },
    reviewHeader: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginBottom: 5 },
    reviewNickname: { fontWeight: 'bold' },
    reviewDate: { color: COLORS.gray, fontSize: 12 },
    starContainerStatic: { flexDirection: 'row', alignItems: 'center', marginVertical: 4 },
    reviewComment: { marginTop: 5, color: COLORS.black, lineHeight: 20 },
    correctionButton: { alignSelf: 'center', padding: 15, marginTop: 20 },
    correctionButtonText: { color: COLORS.gray, textDecorationLine: 'underline' },
    noDataMessage: { fontSize: 16, color: COLORS.gray, textAlign: 'center', marginTop: 50 },
    partyTitle: { fontSize: 18, fontWeight: 'bold' },
    partySubtitle: { fontSize: 14, color: COLORS.gray, marginTop: 4 },
    chatListItem: { backgroundColor: COLORS.white, flexDirection: 'row', padding: 16, alignItems: 'center', marginHorizontal: 16, marginVertical: 6, borderRadius: 16 },
    chatIcon: { width: 50, height: 50, borderRadius: 25, backgroundColor: COLORS.primary, justifyContent: 'center', alignItems: 'center', marginRight: 15 },
    chatTextContainer: { flex: 1 },
    chatListTitle: { fontSize: 16, fontWeight: 'bold' },
    chatListSubtitle: { fontSize: 14, color: COLORS.gray, marginTop: 2 },
    profileViewContainer: { padding: 16 },
    profileInfoRow: { flexDirection: 'row', alignItems: 'center', marginBottom: 20 },
    profileViewText: { fontSize: 18, color: COLORS.black, marginLeft: 15 },
    profileViewTags: { fontSize: 16, color: COLORS.gray, flexWrap: 'wrap', lineHeight: 24 },
    detailContainer: { padding: 20, paddingBottom: 50 },
    title: { fontSize: 24, fontWeight: 'bold', color: COLORS.black, marginBottom: 20 },
    detailInfo: { fontSize: 16, color: COLORS.black, marginBottom: 8, lineHeight: 24 },
    memberList: { width: '100%', marginTop: 20, padding: 20, backgroundColor: COLORS.white, borderRadius: 20 },
    partyFullText: { marginTop: 20, color: COLORS.red, fontSize: 16, textAlign: 'center' },
    chatRoomContainer: { flex: 1, padding: 10, backgroundColor: COLORS.background },
    chatMemberText: { fontSize: 15, marginLeft: 10, marginBottom: 5, lineHeight: 22 },
    chatContentArea: { flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: COLORS.white, borderRadius: 16, margin: 10, padding: 10 },
    chatButton: { padding: 16, borderRadius: 16, alignItems: 'center', marginHorizontal: 10, marginBottom: 10 },
    chatButtonText: { color: 'white', fontWeight: 'bold', fontSize: 16 },
    matchedMemberCard: { backgroundColor: COLORS.primaryLight, borderRadius: 16, padding: 16, marginBottom: 12, width: '100%' },
    matchedMemberTitle: { fontSize: 16, fontWeight: 'bold', color: COLORS.primary },
    matchedMemberText: { fontSize: 14, color: COLORS.gray, marginTop: 5 },
    optionButton: { padding: 16, borderBottomWidth: 1, borderBottomColor: '#eee' },
    optionButtonSelected: { backgroundColor: COLORS.primaryLight },
    optionButtonText: { textAlign: 'center', fontSize: 16, color: COLORS.black },
    optionButtonTextSelected: { color: COLORS.primary, fontWeight: 'bold' },
    scrollerContainer: { height: 150, alignItems: 'center', justifyContent: 'center', marginBottom: 20 },
    scroller: { width: '100%' },
    scrollerItem: { height: 50, justifyContent: 'center', alignItems: 'center' },
    scrollerItemText: { fontSize: 24, fontWeight: 'bold' },
    scrollerIndicator: { position: 'absolute', top: 50, height: 50, width: '90%', borderWidth: 2, borderColor: COLORS.primary, borderRadius: 10 },
    categoryChip: { backgroundColor: COLORS.primaryLight, borderRadius: 20, paddingVertical: 6, paddingHorizontal: 12, alignSelf: 'flex-start' },
    categoryChipText: { color: COLORS.primary, fontWeight: 'bold', fontSize: 12 },
    dangolpotCard: { 
        backgroundColor: COLORS.white, 
        borderRadius: 16, 
        marginHorizontal: 16, 
        marginBottom: 12, 
        padding: 16, 
        elevation: 2, 
        shadowColor: COLORS.indigo,
        shadowOffset: { width: 0, height: 2 }, 
        shadowOpacity: 0.1, 
        shadowRadius: 4,
        borderWidth: 1,
        borderColor: 'rgba(99, 102, 241, 0.2)'
    },
    myPotCard: { 
        backgroundColor: COLORS.white, 
        borderRadius: 16, 
        padding: 16, 
        marginHorizontal: 6, 
        width: SCREEN_WIDTH * 0.5, 
        height: 160, 
        borderWidth: 2, 
        borderColor: COLORS.lightGray, 
        justifyContent: 'flex-start',
        elevation: 2,
        shadowColor: COLORS.indigo,
        shadowOffset: { width: 0, height: 2 }, 
        shadowOpacity: 0.1, 
        shadowRadius: 4
    },
    containerTitle: { fontSize: 22, fontWeight: 'bold', color: COLORS.black, marginHorizontal: 16, marginTop: 20, marginBottom: 12 },
    myPotTitle: { fontSize: 16, fontWeight: 'bold', color: COLORS.primary, marginBottom: 8 },
    myPotSubtitle: { fontSize: 13, color: COLORS.gray, marginTop: 4, lineHeight: 18 },
    myPotMemberCount: { fontSize: 12, color: COLORS.primary, fontWeight: 'bold' },
    myPotDate: { fontSize: 11, color: COLORS.gray },
    myPartyCard: { 
        backgroundColor: COLORS.white, 
        borderRadius: 16, 
        padding: 16, 
        marginHorizontal: 6, 
        width: SCREEN_WIDTH * 0.5, 
        height: 160, 
        borderWidth: 2, 
        borderColor: COLORS.lightGray, 
        justifyContent: 'flex-start',
        elevation: 2,
        shadowColor: COLORS.primary,
        shadowOffset: { width: 0, height: 2 }, 
        shadowOpacity: 0.1, 
        shadowRadius: 4
    },
    myPartyTitle: { fontSize: 16, fontWeight: 'bold', color: COLORS.primary, marginBottom: 8 },
    myPartySubtitle: { fontSize: 13, color: COLORS.gray, marginTop: 4, lineHeight: 18 },
    myPartyMemberCount: { fontSize: 12, color: COLORS.primary, fontWeight: 'bold' },
    myPartyRestaurant: { fontSize: 11, color: COLORS.gray, flex: 1, marginLeft: 8 },
    // ì±„íŒ… ê´€ë ¨ ìŠ¤íƒ€ì¼
    chatContainer: { flex: 1, backgroundColor: COLORS.background },
    messagesList: { flex: 1 },
    messagesContainer: { padding: 10 },
    messageContainer: { marginBottom: 15 },
    myMessage: { alignItems: 'flex-end' },
    otherMessage: { alignItems: 'flex-start' },
    messageSender: { fontSize: 12, color: COLORS.gray, marginBottom: 4, marginLeft: 10 },
    messageBubble: { maxWidth: '80%', padding: 12, borderRadius: 20 },
    myMessageBubble: { backgroundColor: COLORS.primary, borderBottomRightRadius: 6 },
    otherMessageBubble: { backgroundColor: COLORS.white, borderBottomLeftRadius: 6 },
    messageText: { fontSize: 16, lineHeight: 20 },
    myMessageText: { color: COLORS.white },
    otherMessageText: { color: COLORS.black },
    messageTime: { fontSize: 10, color: COLORS.gray, marginTop: 4, marginHorizontal: 10 },
    inputContainer: { 
        flexDirection: 'row', 
        padding: 12, 
        backgroundColor: COLORS.white, 
        borderTopWidth: 1, 
        borderTopColor: COLORS.lightGray,
        alignItems: 'flex-end'
    },
    messageInput: { 
        flex: 1, 
        backgroundColor: COLORS.background, 
        borderRadius: 24, 
        paddingHorizontal: 16,
        paddingVertical: 12, 
        marginRight: 8, 
        fontSize: 16, 
        maxHeight: 100
    },
    sendButton: {
        backgroundColor: COLORS.primary,
        borderRadius: 24,
        width: 44,
        height: 44,
        justifyContent: 'center',
        alignItems: 'center'
    },
    sendButtonDisabled: {
        backgroundColor: COLORS.lightGray
    },
    // ì¹œêµ¬ ê´€ë¦¬ ê´€ë ¨ ìŠ¤íƒ€ì¼
    friendItem: {
        backgroundColor: COLORS.white,
        flexDirection: 'row',
        padding: 16,
        alignItems: 'center',
        marginHorizontal: 16,
        marginVertical: 6,
        borderRadius: 16,
        elevation: 2,
        shadowColor: COLORS.primary,
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 4
    },
    friendInfo: {
        flex: 1
    },
    friendName: {
        fontSize: 16,
        fontWeight: 'bold',
        color: COLORS.black
    },
    friendDepartment: {
        fontSize: 14,
        color: COLORS.gray,
        marginTop: 2
    },
    unfriendButton: {
        backgroundColor: COLORS.red,
        paddingHorizontal: 12,
        paddingVertical: 6,
        borderRadius: 12
    },
    unfriendButtonText: {
        color: COLORS.white,
        fontSize: 12,
        fontWeight: 'bold'
    },
    requestItem: {
        backgroundColor: COLORS.white,
        padding: 16,
        marginHorizontal: 16,
        marginVertical: 6,
        borderRadius: 16,
        elevation: 2,
        shadowColor: COLORS.primary,
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 4
    },
    requestInfo: {
        marginBottom: 12
    },
    requestName: {
        fontSize: 16,
        fontWeight: 'bold',
        color: COLORS.black
    },
    requestDepartment: {
        fontSize: 14,
        color: COLORS.gray,
        marginTop: 2
    },
    requestDate: {
        fontSize: 12,
        color: COLORS.gray,
        marginTop: 4
    },
    requestActions: {
        flexDirection: 'row',
        justifyContent: 'space-between'
    },
    requestButton: {
        flex: 1,
        paddingVertical: 8,
        borderRadius: 12,
        alignItems: 'center',
        marginHorizontal: 4
    },
    acceptButton: {
        backgroundColor: COLORS.primary
    },
    rejectButton: {
        backgroundColor: COLORS.red
    },
    acceptButtonText: {
        color: COLORS.white,
        fontSize: 14,
        fontWeight: 'bold'
    },
    rejectButtonText: {
        color: COLORS.white,
        fontSize: 14,
        fontWeight: 'bold'
    },
    searchContainer: {
        flexDirection: 'row',
        alignItems: 'center',
        paddingHorizontal: 16,
        paddingVertical: 12,
        backgroundColor: COLORS.white,
        borderBottomWidth: 1,
        borderBottomColor: COLORS.lightGray
    },
    searchButton: {
        backgroundColor: COLORS.primary,
        padding: 12,
        borderRadius: 12,
        marginLeft: 8
    },
    searchResultItem: {
        backgroundColor: COLORS.white,
        flexDirection: 'row',
        padding: 16,
        alignItems: 'center',
        marginHorizontal: 16,
        marginVertical: 6,
        borderRadius: 16,
        elevation: 2,
        shadowColor: COLORS.primary,
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 4
    },
    searchResultInfo: {
        flex: 1
    },
    searchResultName: {
        fontSize: 16,
        fontWeight: 'bold',
        color: COLORS.black
    },
    searchResultDepartment: {
        fontSize: 14,
        color: COLORS.gray,
        marginTop: 2
    },
    addFriendButton: {
        backgroundColor: COLORS.primary,
        paddingHorizontal: 12,
        paddingVertical: 6,
        borderRadius: 12
    },
    addFriendButtonDisabled: {
        backgroundColor: COLORS.lightGray
    },
    addFriendButtonPending: {
        backgroundColor: COLORS.yellow
    },
    addFriendButtonText: {
        color: COLORS.white,
        fontSize: 12,
        fontWeight: 'bold'
    },
    addFriendButtonTextDisabled: {
        color: COLORS.gray
    },
    addFriendButtonTextPending: {
        color: COLORS.deepBlue
    },
    friendSelectItem: {
        backgroundColor: COLORS.white,
        flexDirection: 'row',
        padding: 16,
        alignItems: 'center',
        marginBottom: 8,
        borderRadius: 12,
        borderWidth: 2,
        borderColor: COLORS.lightGray
    },
    friendSelectItemSelected: {
        borderColor: COLORS.primary,
        backgroundColor: COLORS.primaryLight
    },
    friendSelectInfo: {
        flex: 1
    },
    friendSelectName: {
        fontSize: 16,
        fontWeight: 'bold',
        color: COLORS.black
    },
    friendSelectDepartment: {
        fontSize: 14,
        color: COLORS.gray,
        marginTop: 2
    },
    submitButtonDisabled: {
        backgroundColor: COLORS.lightGray
    },
    sendButton: { 
        backgroundColor: COLORS.primary, 
        width: 44, 
        height: 44, 
        borderRadius: 22, 
        justifyContent: 'center', 
        alignItems: 'center' 
    },
    sendButtonDisabled: { 
        backgroundColor: COLORS.lightGray 
    },
    connectionStatus: { 
        position: 'absolute', 
        top: 10, 
        right: 10, 
        backgroundColor: COLORS.red, 
        paddingHorizontal: 12, 
        paddingVertical: 6, 
        borderRadius: 20 
    },
    connectionStatusText: { 
        color: COLORS.white, 
        fontSize: 12, 
        fontWeight: 'bold' 
    },
    addRestaurantButton: { 
        backgroundColor: COLORS.primary, 
        padding: 16, 
        borderRadius: 16, 
        marginHorizontal: 16, 
        marginBottom: 10, 
        alignItems: 'center',
        shadowColor: COLORS.primary,
        shadowOffset: { width: 0, height: 4 }, 
        shadowOpacity: 0.3, 
        shadowRadius: 8
    },
    addRestaurantButtonText: { 
        color: COLORS.white, 
        fontWeight: 'bold', 
        fontSize: 16 
    },
    // ìƒˆë¡œìš´ ëœë¤ ëŸ°ì¹˜ ì‹œìŠ¤í…œ ìŠ¤íƒ€ì¼
    loadingContainer: {
        flex: 1,
        justifyContent: 'center',
        alignItems: 'center',
        backgroundColor: COLORS.background
    },
    // ì„±ì‚¬ëœ ëœë¤ëŸ°ì¹˜ ê·¸ë£¹ ì¹´ë“œ ìŠ¤íƒ€ì¼
    confirmedGroupCard: {
        backgroundColor: COLORS.white,
        borderRadius: 16,
        padding: 16,
        marginRight: 12,
        width: 200,
        shadowColor: COLORS.primary,
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 4,
        elevation: 3
    },
    confirmedGroupHeader: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'flex-start',
        marginBottom: 8
    },
    confirmedGroupTitle: {
        fontSize: 16,
        fontWeight: 'bold',
        color: COLORS.black,
        flex: 1
    },
    confirmedGroupMembers: {
        fontSize: 14,
        color: COLORS.primary,
        marginBottom: 4
    },
    confirmedGroupRestaurant: {
        fontSize: 12,
        color: COLORS.gray
    },
    memberItem: {
        marginBottom: 12,
        paddingLeft: 8
    },
    memberName: {
        fontSize: 15,
        fontWeight: 'bold',
        color: COLORS.black,
        marginBottom: 4
    },
    memberDetail: {
        fontSize: 13,
        color: COLORS.gray,
        marginLeft: 16,
        marginBottom: 2
    },
    loadingText: {
        marginTop: 16,
        fontSize: 16,
        color: COLORS.gray,
        textAlign: 'center'
    },
    backButton: {
        padding: 8
    },
    container: {
        flex: 1,
        paddingHorizontal: 16
    },
    cardDescription: {
        fontSize: 14,
        color: COLORS.gray,
        lineHeight: 20
    },
    dateGrid: {
        paddingVertical: 10
    },
    dateButton: {
        flex: 1,
        backgroundColor: COLORS.white,
        borderRadius: 16,
        padding: 20,
        margin: 6,
        alignItems: 'center',
        elevation: 2,
        shadowColor: COLORS.primary,
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 4,
        borderWidth: 1,
        borderColor: COLORS.lightGray
    },
    todayButton: {
        backgroundColor: COLORS.yellow,
        borderColor: COLORS.yellow
    },
    dateButtonText: {
        fontSize: 18,
        fontWeight: 'bold',
        color: COLORS.black
    },
    todayButtonText: {
        color: COLORS.black
    },
    dateButtonSubText: {
        fontSize: 14,
        color: COLORS.gray,
        marginTop: 4
    },
    todayLabel: {
        fontSize: 12,
        fontWeight: 'bold',
        color: COLORS.black,
        marginTop: 4
    },
    userCard: {
        backgroundColor: COLORS.white,
        borderRadius: 16,
        padding: 12,
        marginBottom: 8,
        elevation: 2,
        shadowColor: COLORS.primary,
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 4,
        borderWidth: 1,
        borderColor: COLORS.lightGray
    },
    userCardHeader: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: 8
    },
    userNickname: {
        fontSize: 18,
        fontWeight: 'bold',
        color: COLORS.black
    },
    userBadge: {
        backgroundColor: COLORS.yellow,
        borderRadius: 12,
        paddingHorizontal: 8,
        paddingVertical: 4
    },
    userBadgeText: {
        fontSize: 12,
        fontWeight: 'bold',
        color: COLORS.black
    },
    userDetail: {
        fontSize: 14,
        color: COLORS.gray,
        marginTop: 4
    },
    emptyState: {
        flex: 1,
        justifyContent: 'center',
        alignItems: 'center',
        padding: 20
    },
    emptyStateText: {
        fontSize: 16,
        color: COLORS.gray,
        textAlign: 'center',
        lineHeight: 24
    },
    section: {
        marginBottom: 24
    },
    sectionTitle: {
        fontSize: 20,
        fontWeight: 'bold',
        color: COLORS.black,
        marginBottom: 12,
        marginHorizontal: 16
    },
    proposalCard: {
        backgroundColor: COLORS.white,
        borderRadius: 16,
        padding: 16,
        marginHorizontal: 16,
        marginBottom: 12,
        elevation: 2,
        shadowColor: COLORS.primary,
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 4,
        borderWidth: 1,
        borderColor: COLORS.lightGray
    },
    proposalHeader: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: 8
    },
    proposalHeaderRight: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 8
    },
    proposalDetails: {
        marginTop: 8,
        paddingTop: 8,
        borderTopWidth: 1,
        borderTopColor: COLORS.lightGray
    },
    proposalDate: {
        fontSize: 16,
        fontWeight: 'bold',
        color: COLORS.black
    },
    statusBadge: {
        backgroundColor: COLORS.primary,
        borderRadius: 12,
        paddingHorizontal: 8,
        paddingVertical: 4
    },
    statusConfirmed: {
        backgroundColor: COLORS.secondary
    },
    statusCancelled: {
        backgroundColor: COLORS.red
    },
    statusExpired: {
        backgroundColor: COLORS.gray
    },
    statusText: {
        fontSize: 12,
        fontWeight: 'bold',
        color: COLORS.white
    },
    acceptedText: {
        fontSize: 14,
        color: COLORS.gray,
        marginTop: 8
    },
    proposalActions: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        marginTop: 12
    },
    actionButton: {
        flex: 1,
        borderRadius: 12,
        padding: 12,
        alignItems: 'center',
        marginHorizontal: 4
    },
    actionButtonText: {
        fontSize: 14,
        fontWeight: 'bold',
        color: COLORS.white
    },
    groupInfo: {
        marginBottom: 12
    },
    groupInfoTitle: {
        fontSize: 14,
        fontWeight: 'bold',
        color: COLORS.black,
        marginBottom: 8
    },
    groupMember: {
        fontSize: 12,
        color: COLORS.gray,
        marginLeft: 8,
        marginBottom: 4
    },
    memberInfo: {
        marginBottom: 8,
        marginLeft: 8
    },
    memberName: {
        fontSize: 14,
        fontWeight: 'bold',
        color: COLORS.black,
        marginBottom: 2
    },
    memberDetail: {
        fontSize: 12,
        color: COLORS.gray,
        marginLeft: 8,
        marginBottom: 2
    },
    emptyText: {
        fontSize: 16,
        color: COLORS.gray,
        textAlign: 'center',
        marginTop: 20
    },
    // ê·¸ë£¹ ìŠ¤ì™€ì´í”„ ê´€ë ¨ ìŠ¤íƒ€ì¼
    groupCard: {
        backgroundColor: COLORS.white,
        borderRadius: 20,
        padding: 16,
        marginHorizontal: 16,
        elevation: 3,
        shadowColor: COLORS.primary,
        shadowOffset: { width: 0, height: 4 },
        shadowOpacity: 0.1,
        shadowRadius: 8,
        borderWidth: 1,
        borderColor: 'rgba(59, 130, 246, 0.1)',
        width: 310
    },
    usersScrollView: {
        maxHeight: 200,
        marginVertical: 10
    },
    groupListContainer: {
        paddingHorizontal: 0
    },
    groupHeader: {
        marginBottom: 8,
        alignItems: 'center'
    },
    groupTitle: {
        fontSize: 22,
        fontWeight: 'bold',
        color: COLORS.primary,
        marginBottom: 4
    },
    groupSubtitle: {
        fontSize: 14,
        color: COLORS.gray,
        textAlign: 'center'
    },
    paginationContainer: {
        flexDirection: 'row',
        justifyContent: 'center',
        alignItems: 'center',
        marginTop: 20,
        marginBottom: 20
    },
    paginationDot: {
        width: 8,
        height: 8,
        borderRadius: 4,
        backgroundColor: COLORS.lightGray,
        marginHorizontal: 4
    },
    paginationDotActive: {
        backgroundColor: COLORS.primary,
        width: 12,
        height: 12,
        borderRadius: 6
    },
    titleInputContainer: {
        flexDirection: 'row',
        alignItems: 'center',
        borderBottomWidth: 1,
        borderBottomColor: COLORS.lightGray,
        paddingBottom: 8,
        marginBottom: 16
    },
    aiSuggestButton: {
        marginLeft: 8,
        padding: 8,
        borderRadius: 16,
        backgroundColor: COLORS.primary,
        justifyContent: 'center',
        alignItems: 'center'
    },
    suggestionsContainer: {
        marginTop: 16,
        padding: 16,
        backgroundColor: COLORS.white,
        borderRadius: 16,
        elevation: 2,
        shadowColor: COLORS.primary,
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 4
    },
    suggestionsTitle: {
        fontSize: 18,
        fontWeight: 'bold',
        color: COLORS.black,
        marginBottom: 12
    },
    suggestionItem: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        paddingVertical: 8,
        borderBottomWidth: 1,
        borderBottomColor: COLORS.lightGray
    },
    suggestionText: {
        fontSize: 16,
        color: COLORS.black
    },
    schedulingHeader: {
        marginBottom: 20,
        paddingHorizontal: 16,
        paddingVertical: 12,
        backgroundColor: COLORS.white,
        borderRadius: 16,
        elevation: 2,
        shadowColor: COLORS.primary,
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 4,
        borderWidth: 1,
        borderColor: 'rgba(59, 130, 246, 0.1)'
    },
    schedulingTitle: {
        fontSize: 22,
        fontWeight: 'bold',
        color: COLORS.black,
        marginBottom: 12
    },
    schedulingSubtitle: {
        fontSize: 16,
        color: COLORS.gray,
        marginBottom: 16
    },
    scheduleSuggestionItem: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        paddingVertical: 12,
        borderBottomWidth: 1,
        borderBottomColor: COLORS.lightGray
    },
    scheduleSuggestionInfo: {
        flex: 1
    },
    scheduleSuggestionDate: {
        fontSize: 16,
        fontWeight: 'bold',
        color: COLORS.black
    },
    scheduleSuggestionLocation: {
        fontSize: 14,
        color: COLORS.gray,
        marginTop: 4
    },
    scheduleSuggestionReason: {
        fontSize: 12,
        color: COLORS.gray,
        marginTop: 4
    },
    settingsContainer: {
        padding: 20
    },
    settingsSection: {
        marginBottom: 20
    },
    settingsSectionTitle: {
        fontSize: 18,
        fontWeight: 'bold',
        color: COLORS.black,
        marginBottom: 10
    },
    settingItem: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: 10
    },
    settingInfo: {
        flex: 1
    },
    settingTitle: {
        fontSize: 16,
        fontWeight: 'bold',
        color: COLORS.black
    },
    settingDescription: {
        fontSize: 14,
        color: COLORS.gray
    },
    // AI ì œì•ˆ ê´€ë ¨ ìŠ¤íƒ€ì¼
    titleInputContainer: {
        flexDirection: 'row',
        alignItems: 'center',
        marginBottom: 20
    },
    // ì§€ëŠ¥í˜• ìŠ¤ì¼€ì¤„ë§ ê´€ë ¨ ìŠ¤íƒ€ì¼
    friendItem: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        padding: 16,
        backgroundColor: COLORS.white,
        borderRadius: 12,
        marginBottom: 8,
        elevation: 2,
        shadowColor: COLORS.primary,
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 4,
        borderWidth: 1,
        borderColor: COLORS.lightGray
    },
    selectedFriendItem: {
        borderColor: COLORS.primary,
        backgroundColor: 'rgba(59, 130, 246, 0.05)'
    },
    friendInfo: {
        flex: 1
    },
    friendName: {
        fontSize: 16,
        fontWeight: 'bold',
        color: COLORS.black,
        marginBottom: 4
    },
    friendPreference: {
        fontSize: 14,
        color: COLORS.gray
    },
    dateItem: {
        padding: 16,
        backgroundColor: COLORS.white,
        borderRadius: 12,
        marginBottom: 8,
        elevation: 2,
        shadowColor: COLORS.primary,
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 4,
        borderWidth: 1,
        borderColor: COLORS.lightGray
    },
    dateText: {
        fontSize: 16,
        fontWeight: 'bold',
        color: COLORS.black,
        marginBottom: 4
    },
    dateDescription: {
        fontSize: 14,
        color: COLORS.gray
    },
    alternativeContainer: {
        padding: 16,
        backgroundColor: COLORS.white,
        borderRadius: 12,
        elevation: 2,
        shadowColor: COLORS.primary,
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 4,
        borderWidth: 1,
        borderColor: COLORS.lightGray
    },
    alternativeTitle: {
        fontSize: 16,
        fontWeight: 'bold',
        color: COLORS.red,
        marginBottom: 8
    },
    alternativeDescription: {
        fontSize: 14,
        color: COLORS.gray
    },
    disabledButton: {
        backgroundColor: COLORS.lightGray,
        opacity: 0.6
    },
    // ì˜¨ë³´ë”© ê´€ë ¨ ìŠ¤íƒ€ì¼
    onboardingContainer: {
        flex: 1,
        backgroundColor: currentColors.background,
    },
    onboardingHeader: {
        padding: 20,
        alignItems: 'center',
    },
    progressBar: {
        flexDirection: 'row',
        marginBottom: 10,
    },
    progressDot: {
        width: 8,
        height: 8,
        borderRadius: 4,
        backgroundColor: currentColors.lightGray,
        marginHorizontal: 4,
    },
    progressDotActive: {
        backgroundColor: currentColors.primary,
        width: 12,
        height: 12,
        borderRadius: 6,
    },
    stepIndicator: {
        fontSize: 14,
        color: currentColors.textSecondary,
    },
    onboardingContent: {
        flex: 1,
        padding: 20,
    },
    onboardingTitle: {
        fontSize: 24,
        fontWeight: 'bold',
        color: currentColors.text,
        marginBottom: 10,
        textAlign: 'center',
    },
    onboardingDescription: {
        fontSize: 16,
        color: currentColors.textSecondary,
        marginBottom: 30,
        textAlign: 'center',
    },
    optionsContainer: {
        flex: 1,
    },
    optionCard: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        padding: 16,
        backgroundColor: currentColors.surface,
        borderRadius: 12,
        marginBottom: 12,
        borderWidth: 1,
        borderColor: currentColors.border,
    },
    optionCardSelected: {
        borderColor: currentColors.primary,
        backgroundColor: currentColors.primaryLight,
    },
    optionText: {
        fontSize: 16,
        color: currentColors.text,
    },
    optionTextSelected: {
        color: currentColors.primary,
        fontWeight: 'bold',
    },
    onboardingFooter: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        padding: 20,
        backgroundColor: currentColors.surface,
    },
    backButton: {
        padding: 12,
        borderRadius: 8,
        borderWidth: 1,
        borderColor: currentColors.border,
    },
    backButtonText: {
        fontSize: 16,
        color: currentColors.textSecondary,
    },
    nextButton: {
        padding: 12,
        borderRadius: 8,
        backgroundColor: currentColors.primary,
        flex: 1,
        marginLeft: 12,
        alignItems: 'center',
    },
    nextButtonDisabled: {
        backgroundColor: currentColors.disabled,
    },
    nextButtonText: {
        fontSize: 16,
        color: currentColors.surface,
        fontWeight: 'bold',
    },
    // íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ìŠ¤íƒ€ì¼
    tabContainer: {
        flexDirection: 'row',
        backgroundColor: currentColors.surface,
        paddingHorizontal: 16,
        paddingVertical: 8,
        borderBottomWidth: 1,
        borderBottomColor: currentColors.border,
    },
    tabButton: {
        flex: 1,
        paddingVertical: 8,
        paddingHorizontal: 12,
        alignItems: 'center',
        borderRadius: 8,
        marginHorizontal: 4,
    },
    tabButtonActive: {
        backgroundColor: currentColors.primaryLight,
    },
    tabButtonText: {
        fontSize: 14,
        color: currentColors.textSecondary,
        fontWeight: '500',
    },
    tabButtonTextActive: {
        color: currentColors.primary,
        fontWeight: 'bold',
    },
    // ì¶”ì²œ ë°°ì§€ ìŠ¤íƒ€ì¼
    recommendationBadge: {
        position: 'absolute',
        top: 8,
        right: 8,
        backgroundColor: currentColors.primary,
        paddingHorizontal: 8,
        paddingVertical: 4,
        borderRadius: 12,
    },
    recommendationText: {
        fontSize: 12,
        color: currentColors.surface,
        fontWeight: 'bold',
    },
    // ì•Œë¦¼ ê´€ë ¨ ìŠ¤íƒ€ì¼
    notificationItem: {
        flexDirection: 'row',
        alignItems: 'center',
        padding: 16,
        backgroundColor: currentColors.surface,
        marginHorizontal: 16,
        marginBottom: 8,
        borderRadius: 12,
        borderWidth: 1,
        borderColor: currentColors.border,
    },
    unreadNotification: {
        backgroundColor: currentColors.primaryLight,
        borderColor: currentColors.primary,
    },
    notificationIcon: {
        width: 40,
        height: 40,
        borderRadius: 20,
        backgroundColor: currentColors.primaryLight,
        justifyContent: 'center',
        alignItems: 'center',
        marginRight: 12,
    },
    notificationContent: {
        flex: 1,
    },
    notificationMessage: {
        fontSize: 16,
        color: currentColors.text,
        marginBottom: 4,
    },
    notificationTime: {
        fontSize: 12,
        color: currentColors.textSecondary,
    },
    unreadDot: {
        width: 8,
        height: 8,
        borderRadius: 4,
        backgroundColor: currentColors.primary,
        marginLeft: 8,
    },
    
    // ë¦¬ë·° ìƒì„¸ ìŠ¤íƒ€ì¼
    reviewDetailContainer: {
        flex: 1,
        padding: 16,
    },
    reviewDetailCard: {
        backgroundColor: currentColors.surface,
        borderRadius: 16,
        padding: 20,
        shadowColor: '#000',
        shadowOffset: { width: 0, height: 4 },
        shadowOpacity: 0.1,
        shadowRadius: 8,
        elevation: 5,
    },
    reviewHeader: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: 16,
    },
    reviewAuthor: {
        fontSize: 18,
        fontWeight: '600',
        color: currentColors.text,
    },
    ratingContainer: {
        flexDirection: 'row',
        alignItems: 'center',
    },
    reviewPhotoContainer: {
        marginVertical: 16,
        borderRadius: 12,
        overflow: 'hidden',
    },
    reviewPhoto: {
        width: '100%',
        height: 200,
        borderRadius: 12,
    },
    tagsContainer: {
        flexDirection: 'row',
        flexWrap: 'wrap',
        marginVertical: 12,
    },
    tagItem: {
        backgroundColor: currentColors.primaryLight,
        paddingHorizontal: 12,
        paddingVertical: 6,
        borderRadius: 16,
        marginRight: 8,
        marginBottom: 8,
    },
    tagText: {
        fontSize: 12,
        color: currentColors.primary,
        fontWeight: '500',
    },
    reviewComment: {
        fontSize: 16,
        lineHeight: 24,
        color: currentColors.text,
        marginVertical: 12,
    },
    reviewActions: {
        flexDirection: 'row',
        justifyContent: 'flex-end',
        marginTop: 16,
        paddingTop: 16,
        borderTopWidth: 1,
        borderTopColor: currentColors.border,
    },
    likeButton: {
        flexDirection: 'row',
        alignItems: 'center',
        paddingHorizontal: 16,
        paddingVertical: 8,
        borderRadius: 20,
        backgroundColor: currentColors.lightGray,
    },
    likedButton: {
        backgroundColor: currentColors.red + '20',
    },
    likeCount: {
        marginLeft: 6,
        fontSize: 14,
        color: currentColors.textSecondary,
        fontWeight: '500',
    },
    likedText: {
        color: currentColors.red,
    },
    header: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        padding: 16,
        borderBottomWidth: 1,
        borderBottomColor: currentColors.border,
    },
    headerTitle: {
        fontSize: 20,
        fontWeight: 'bold',
        color: currentColors.text,
    },
    clearButton: {
        fontSize: 14,
        color: currentColors.primary,
    },
    emptyContainer: {
        flex: 1,
        justifyContent: 'center',
        alignItems: 'center',
        paddingVertical: 60,
    },
    emptyText: {
        fontSize: 16,
        color: currentColors.textSecondary,
        marginTop: 16,
    },
    // AA ê³„ì‚°ê¸° ìŠ¤íƒ€ì¼
    aaContainer: {
        padding: 16,
    },
    aaTitle: {
        fontSize: 24,
        fontWeight: 'bold',
        color: currentColors.text,
        textAlign: 'center',
        marginBottom: 20,
    },
    inputSection: {
        marginBottom: 20,
    },
    sectionTitle: {
        fontSize: 18,
        fontWeight: 'bold',
        color: currentColors.text,
        marginBottom: 12,
    },
    inputRow: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 8,
    },
    input: {
        flex: 1,
        borderWidth: 1,
        borderColor: currentColors.border,
        borderRadius: 8,
        padding: 12,
        fontSize: 16,
        color: currentColors.text,
        backgroundColor: currentColors.surface,
    },
    addButton: {
        backgroundColor: currentColors.primary,
        width: 44,
        height: 44,
        borderRadius: 22,
        justifyContent: 'center',
        alignItems: 'center',
    },
    expensesSection: {
        marginBottom: 20,
    },
    expenseItem: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        padding: 12,
        backgroundColor: currentColors.surface,
        borderRadius: 8,
        marginBottom: 8,
        borderWidth: 1,
        borderColor: currentColors.border,
    },
    expenseInfo: {
        flex: 1,
    },
    expenseUser: {
        fontSize: 16,
        fontWeight: 'bold',
        color: currentColors.text,
    },
    expenseAmount: {
        fontSize: 14,
        color: currentColors.textSecondary,
        marginTop: 4,
    },
    removeButton: {
        padding: 4,
    },
    calculateButton: {
        backgroundColor: currentColors.primary,
        padding: 16,
        borderRadius: 8,
        alignItems: 'center',
        marginTop: 16,
    },
    calculateButtonText: {
        fontSize: 16,
        fontWeight: 'bold',
        color: currentColors.surface,
    },
    resultSection: {
        marginTop: 20,
    },
    summaryCard: {
        backgroundColor: currentColors.primaryLight,
        padding: 16,
        borderRadius: 8,
        marginBottom: 16,
    },
    summaryText: {
        fontSize: 16,
        color: currentColors.text,
        marginBottom: 4,
    },
    settlementItem: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        padding: 12,
        backgroundColor: currentColors.surface,
        borderRadius: 8,
        marginBottom: 8,
        borderWidth: 1,
        borderColor: currentColors.border,
    },
    receiveItem: {
        borderColor: currentColors.secondary,
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
    },
    payItem: {
        borderColor: currentColors.red,
        backgroundColor: 'rgba(239, 68, 68, 0.1)',
    },
    settlementUser: {
        fontSize: 16,
        fontWeight: 'bold',
        color: currentColors.text,
    },
    settlementAmount: {
        fontSize: 16,
        fontWeight: 'bold',
        color: currentColors.text,
    },
    settlementStatus: {
        fontSize: 12,
        color: currentColors.textSecondary,
    },
    aiSuggestButton: {
        backgroundColor: COLORS.primaryLight,
        padding: 12,
        borderRadius: 12,
        marginLeft: 8
    },
    suggestionsContainer: {
        backgroundColor: COLORS.white,
        borderRadius: 16,
        padding: 16,
        marginBottom: 20,
        elevation: 2,
        shadowColor: COLORS.primary,
        shadowOffset: { width: 0, height: 2 },
        shadowOpacity: 0.1,
        shadowRadius: 4
    },
    suggestionsTitle: {
        fontSize: 16,
        fontWeight: 'bold',
        color: COLORS.black,
        marginBottom: 12
    },
    suggestionItem: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        paddingVertical: 12,
        borderBottomWidth: 1,
        borderBottomColor: COLORS.lightGray
    },
    suggestionText: {
        fontSize: 14,
        color: COLORS.black,
        flex: 1
    },
    // ì±„íŒ… í•„í„° ìŠ¤íƒ€ì¼
    chatFilterContainer: {
        backgroundColor: COLORS.white,
        paddingVertical: 12,
        borderBottomWidth: 1,
        borderBottomColor: COLORS.lightGray
    },
    chatFilterButton: {
        paddingHorizontal: 16,
        paddingVertical: 8,
        marginHorizontal: 6,
        borderRadius: 20,
        backgroundColor: COLORS.background
    },
    chatFilterButtonActive: {
        backgroundColor: COLORS.primary
    },
    chatFilterText: {
        fontSize: 14,
        fontWeight: '600',
        color: COLORS.gray
    },
    chatFilterTextActive: {
        color: COLORS.white
    }
});

